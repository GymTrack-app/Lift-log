<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gemini Strength Pro</title>
  <style>
    :root {
      --bg: #09090b;
      --card: #18181b;
      --border: #27272a;
      --accent: #3b82f6; 
      --success: #22c55e;
      --danger: #ef4444;
      --text: #fafafa;
      --muted: #a1a1aa;
      --gold: #fbbf24;
    }

    body {
      background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding-bottom: 90px; overflow-x: hidden;
    }

    /* Core Layout */
    .screen { display: none; padding: 16px; animation: fadeIn 0.2s ease; }
    .screen.show { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 16px; margin-bottom: 12px;
    }

    .plateau-warning { border-left: 4px solid var(--danger); background: rgba(239, 68, 68, 0.05); }
    .pr-card { border-left: 4px solid var(--gold); background: rgba(251, 191, 36, 0.05); }

    h2, h3 { margin: 0 0 8px 0; }
    .tiny { font-size: 0.75rem; }
    .muted { color: var(--muted); }
    .row { display: flex; align-items: center; gap: 8px; }
    .sep { height: 1px; background: var(--border); margin: 12px 0; }

    /* Interactive Elements */
    input, select {
      width: 100%; background: #000; border: 1px solid var(--border);
      color: #fff; padding: 10px; border-radius: 8px; margin: 4px 0;
    }

    button {
      cursor: pointer; border-radius: 12px; font-weight: 600; border: none; padding: 12px;
    }
    .btnPrimary { background: var(--accent); color: white; width: 100%; }
    .btnGhost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btnDanger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    /* Navigation */
    .nav {
      position: fixed; bottom: 0; width: 100%; background: rgba(9, 9, 11, 0.95);
      backdrop-filter: blur(10px); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; padding: 12px 0; z-index: 100;
    }
    .navItem { color: var(--muted); font-size: 0.75rem; text-align: center; flex: 1; }
    .navItem.active { color: var(--accent); font-weight: bold; }

    /* Data Visualization */
    .bar-container { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 8px 0; }
    .bar-fill { height: 100%; background: var(--accent); transition: width 0.5s ease; }
    
    table { width: 100%; margin-top: 10px; }
    th { text-align: left; color: var(--muted); font-size: 0.7rem; }
    td input { padding: 4px; font-size: 0.9rem; }
  </style>
</head>
<body>

  <div id="screenToday" class="screen">
    <div class="row" style="justify-content: space-between;">
      <h2>Today</h2>
      <button class="btnGhost tiny" onclick="renderSetup()">‚öôÔ∏è Settings</button>
    </div>
    <div id="todayBox"></div>
    <button class="btnPrimary" id="btnStartWorkout" style="display:none; margin-top:16px;">Start Session</button>
  </div>

  <div id="screenStats" class="screen">
    <h2>Performance Stats</h2>
    <div id="statsBox"></div>
  </div>

  <div id="screenPRs" class="screen">
    <h2>Personal Records üèÜ</h2>
    <div id="prsBox"></div>
  </div>

  <div class="nav">
    <div class="navItem" id="tabToday">Today</div>
    <div class="navItem" id="tabStats">Stats</div>
    <div class="navItem" id="tabPRs">PRs</div>
  </div>

  <script>
    /* --- CONSTANTS & STATE --- */
    const KEY = "gemini_pro_v2";
    const WEEKDAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const $ = id => document.getElementById(id);

    let state = JSON.parse(localStorage.getItem(KEY)) || {
      program: { units: "lb", split: [], exercises: {} },
      sessions: [],
      exerciseState: {},
      ui: { activeTab: "today" }
    };

    const save = () => localStorage.getItem(KEY, JSON.stringify(state));
    const num = (x, fb = 0) => { let n = parseFloat(x); return isNaN(n) ? fb : n; };
    const e1rm = (w, r) => w * (1 + (r / 30));
    const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));

    /* --- PLATEAU & PROGRESSION LOGIC --- */
    function getPlateaus() {
      const p = state.program;
      if (!p || !state.sessions.length) return [];
      const plateaus = [];
      const threshold = 21 * 24 * 60 * 60 * 1000; // 21 days

      Object.keys(p.exercises).forEach(id => {
        const history = state.sessions.filter(s => s.exercises.some(e => e.exId === id))
          .sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if (history.length < 3) return;
        const current = history[0].computed.e1rm[id];
        const oldSess = history.find(s => (new Date() - new Date(s.date)) > threshold);
        
        if (oldSess && current <= oldSess.computed.e1rm[id] * 1.01) {
          plateaus.push({ name: p.exercises[id].name, days: Math.floor((new Date() - new Date(oldSess.date))/86400000) });
        }
      });
      return plateaus;
    }

    /* --- RENDERING ENGINE --- */
    function render() {
      const t = state.ui.activeTab;
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
      document.querySelectorAll('.navItem').forEach(n => n.classList.remove('active'));
      
      if (t === "today") { $("screenToday").classList.add("show"); renderToday(); }
      if (t === "stats") { $("screenStats").classList.add("show"); renderStats(); }
      if (t === "prs") { $("screenPRs").classList.add("show"); renderPRs(); }
      if (t === "setup") { $("screenToday").classList.add("show"); renderSetup(); }
      if (t === "logger") { $("screenToday").classList.add("show"); renderLogger(); }
      
      $(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`)?.classList.add("active");
    }

    function renderToday() {
      const p = state.program;
      if (!p.split.length) {
        $("todayBox").innerHTML = `<div class="card muted">Welcome! Tap Settings to create your split.</div>`;
        $("btnStartWorkout").style.display = "none";
        return;
      }

      const stalls = getPlateaus();
      let html = stalls.map(s => `
        <div class="card plateau-warning">
          <div class="tiny" style="color:var(--danger)">‚ö†Ô∏è PLATEAU DETECTED</div>
          <strong>${escapeHtml(s.name)}</strong>
          <div class="tiny muted">No progress in ${s.days} days. Try a deload or changing reps.</div>
        </div>
      `).join("");

      const dow = new Date().getDay();
      const plan = p.split.find(s => s.weekday === dow);

      if (!plan) {
        html += `<div class="card"><h3>Rest Day</h3><p class="muted">Growth happens during recovery.</p></div>`;
        $("btnStartWorkout").style.display = "none";
      } else {
        html += `<div class="card"><h3>${escapeHtml(plan.title)}</h3><div class="sep"></div>`;
        plan.exercises.forEach(id => {
          const ex = p.exercises[id];
          html += `<div class="row" style="justify-content:space-between">
            <span>${escapeHtml(ex.name)}</span>
            <span class="tiny muted">${ex.sets} sets @ ${state.exerciseState[id]?.currentWeight || ex.startWeight}${p.units}</span>
          </div>`;
        });
        html += `</div>`;
        $("btnStartWorkout").style.display = "block";
      }
      $("todayBox").innerHTML = html;
    }

    /* --- WORKOUT LOGGER --- */
    let activeSession = null;
    function startWorkout() {
      const p = state.program;
      const dow = new Date().getDay();
      const plan = p.split.find(s => s.weekday === dow);
      
      activeSession = {
        date: new Date().toISOString().split('T')[0],
        workoutTitle: plan.title,
        exercises: plan.exercises.map(id => ({
          exId: id,
          sets: Array.from({length: p.exercises[id].sets}, () => ({ w: state.exerciseState[id]?.currentWeight || p.exercises[id].startWeight, r: 0, done: false }))
        })),
        computed: { e1rm: {} }
      };
      state.ui.activeTab = "logger";
      render();
    }

    function renderLogger() {
      let html = `<h3>Logging ${activeSession.workoutTitle}</h3>`;
      activeSession.exercises.forEach((ex, exIdx) => {
        const name = state.program.exercises[ex.exId].name;
        html += `<div class="card">
          <strong>${escapeHtml(name)}</strong>
          <table>
            <tr><th>W</th><th>R</th><th>‚úì</th></tr>
            ${ex.sets.map((s, sIdx) => `
              <tr>
                <td><input type="number" value="${s.w}" onchange="updateSet(${exIdx},${sIdx},'w',this.value)"></td>
                <td><input type="number" placeholder="0" onchange="updateSet(${exIdx},${sIdx},'r',this.value)"></td>
                <td><input type="checkbox" onchange="updateSet(${exIdx},${sIdx},'done',this.checked)"></td>
              </tr>
            `).join('')}
          </table>
        </div>`;
      });
      html += `<button class="btnPrimary" onclick="finishWorkout()">Complete Session</button>`;
      $("todayBox").innerHTML = html;
      $("btnStartWorkout").style.display = "none";
    }

    window.updateSet = (ei, si, field, val) => {
      activeSession.exercises[ei].sets[si][field] = field === 'done' ? val : num(val);
    };

    window.finishWorkout = () => {
      activeSession.exercises.forEach(ex => {
        let best = 0;
        ex.sets.forEach(s => { if(s.done) best = Math.max(best, e1rm(s.w, s.r)); });
        activeSession.computed.e1rm[ex.exId] = best;
        
        // Progression: Simple 5lb increase if all reps done (logic can be expanded)
        if (!state.exerciseState[ex.exId]) state.exerciseState[ex.exId] = { currentWeight: state.program.exercises[ex.exId].startWeight };
        state.exerciseState[ex.exId].currentWeight += 5; 
      });

      state.sessions.push(activeSession);
      activeSession = null;
      state.ui.activeTab = "today";
      save(); render();
    };

    /* --- STATS & PRS --- */
    function renderStats() {
      if (!state.sessions.length) { $("statsBox").innerHTML = `<div class="muted">Complete a workout to see stats.</div>`; return; }
      
      let html = "";
      Object.keys(state.program.exercises).forEach(id => {
        const data = state.sessions.filter(s => s.computed.e1rm[id]).map(s => s.computed.e1rm[id]);
        if (!data.length) return;
        const max = Math.max(...data);
        const last = data[data.length - 1];
        const progress = (last / max) * 100;

        html += `<div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>${escapeHtml(state.program.exercises[id].name)}</strong>
            <span class="tiny">${Math.round(last)} ${state.program.units} e1RM</span>
          </div>
          <div class="bar-container"><div class="bar-fill" style="width:${progress}%"></div></div>
          <div class="tiny muted">Last: ${Math.round(last)} | All-time: ${Math.round(max)}</div>
        </div>`;
      });
      $("statsBox").innerHTML = html;
    }

    function renderPRs() {
      const records = {};
      state.sessions.forEach(s => {
        Object.keys(s.computed.e1rm).forEach(id => {
          if (!records[id] || s.computed.e1rm[id] > records[id].val) {
            records[id] = { val: s.computed.e1rm[id], date: s.date };
          }
        });
      });

      let html = "";
      Object.keys(records).forEach(id => {
        html += `<div class="card pr-card">
          <div class="row" style="justify-content:space-between">
            <strong>${escapeHtml(state.program.exercises[id].name)}</strong>
            <span style="color:var(--gold); font-weight:bold;">${Math.round(records[id].val)} ${state.program.units}</span>
          </div>
          <div class="tiny muted">Achieved on ${records[id].date}</div>
        </div>`;
      });
      $("prsBox").innerHTML = html || `<div class="muted">No records yet. Hit the gym!</div>`;
    }

    /* --- SETUP / SETTINGS --- */
    function renderSetup() {
      state.ui.activeTab = "setup";
      let html = `<button class="btnGhost" onclick="state.ui.activeTab='today'; render();">‚Üê Back</button>
      <div class="card" style="margin-top:16px;">
        <h3>Split Manager</h3>
        <div id="setupList"></div>
        <button class="btnPrimary" style="margin-top:10px" onclick="addDay()">+ Add Workout Day</button>
      </div>
      <button class="btnDanger" style="width:100%" onclick="localStorage.clear(); location.reload();">Nuke All Data</button>`;
      $("todayBox").innerHTML = html;
      $("btnStartWorkout").style.display = "none";

      const list = $("setupList");
      state.program.split.forEach((day, dIdx) => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.background = "#000";
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <strong>${day.title}</strong>
            <span class="tiny muted">${WEEKDAYS[day.weekday]}</span>
          </div>
          <div id="exList-${dIdx}"></div>
          <button class="btnGhost tiny" style="width:100%; margin-top:8px" onclick="addEx(${dIdx})">+ Add Exercise</button>
        `;
        list.appendChild(div);
        
        const exList = div.querySelector(`#exList-${dIdx}`);
        day.exercises.forEach(exId => {
          exList.innerHTML += `<div class="tiny muted" style="padding:4px 0; border-bottom:1px solid #111">${state.program.exercises[exId].name}</div>`;
        });
      });
    }

    window.addDay = () => {
      const title = prompt("Day Title (e.g. Push Day)");
      const dow = prompt("Day Number (0=Sun, 1=Mon...6=Sat)");
      if (title && dow !== null) {
        state.program.split.push({ title, weekday: parseInt(dow), exercises: [] });
        save(); renderSetup();
      }
    };

    window.addEx = (dIdx) => {
      const name = prompt("Exercise Name");
      const sets = prompt("Number of Sets", "3");
      const weight = prompt("Start Weight", "45");
      if (name) {
        const id = "ex_" + Date.now();
        state.program.exercises[id] = { name, sets: parseInt(sets), startWeight: parseInt(weight) };
        state.program.split[dIdx].exercises.push(id);
        save(); renderSetup();
      }
    };

    /* --- INIT --- */
    $("tabToday").onclick = () => { state.ui.activeTab = "today"; render(); };
    $("tabStats").onclick = () => { state.ui.activeTab = "stats"; render(); };
    $("tabPRs").onclick = () => { state.ui.activeTab = "prs"; render(); };
    $("btnStartWorkout").onclick = startWorkout;

    render();
  </script>
</body>
</html>
