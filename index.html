<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0b0f"/>
  <title>LiftLog MVP</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --card:#171726;
      --line:#2a2a3e;
      --text:#f2f4f8;
      --muted:#9aa0aa;
      --green:#1fe48a;
      --red:#ff4d6d;
      --amber:#ffb020;
      --blue:#57b8ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0;background:var(--bg);color:var(--text);
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(72px + env(safe-area-inset-bottom));
    }
    .app{max-width:560px;margin:0 auto}
    .topbar{
      position:sticky;top:0;z-index:20;
      background: rgba(11,11,15,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(42,42,62,.65);
      padding: 10px 12px;
    }
    .navrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-size:17px;font-weight:800;text-align:center;flex:1}
    .pill{
      font-size:11px;color:var(--muted);border:1px solid rgba(42,42,62,.7);
      padding:4px 8px;border-radius:999px
    }
    .content{padding:12px}
    .card{
      background: linear-gradient(180deg, rgba(23,23,38,.92), rgba(18,18,26,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    button, input, select, textarea{
      border:1px solid var(--line);
      background:#0f0f18;color:var(--text);
      border-radius:14px;padding:10px 12px;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer}
    button:active{transform:scale(.99)}
    .btnGood{background: rgba(31,228,138,.15);border-color: rgba(31,228,138,.35);}
    .btnDanger{background: rgba(255,77,109,.12);border-color: rgba(255,77,109,.35);}
    .btnGhost{background: rgba(255,255,255,.04);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }
    .list{
      margin-top:12px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      background: rgba(15,15,24,.5);
    }
    .listHeader{
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid rgba(42,42,62,.65);
      display:flex;justify-content:space-between;align-items:center
    }
    .item{
      display:flex;align-items:center;justify-content:space-between;
      padding: 12px;
      border-bottom:1px solid rgba(42,42,62,.35);
    }
    .item:last-child{border-bottom:none}
    .name{font-weight:800}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .tabs{
      position: fixed;left:0;right:0;bottom:0;z-index:30;
      background: rgba(11,11,15,.92);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(42,42,62,.65);
      padding: 8px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{
      max-width:560px;margin:0 auto;
      display:flex;justify-content:space-around;align-items:center;
      gap:10px;
    }
    .tab{display:flex;flex-direction:column;align-items:center;gap:4px;color:#7e8596;font-size:11px;cursor:pointer;user-select:none}
    .tab.active{color:var(--green)}
    .icon{width:22px;height:22px;border-radius:6px;border:1px solid rgba(42,42,62,.7);display:grid;place-items:center;font-weight:900}
    .screen{display:none}
    .screen.show{display:block}
    .fab{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom) + 44px);
      width:66px;height:66px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 14px 40px rgba(31,228,138,.25);
      border:none;
      color:#03110a;
      font-size:36px;
      display:none;
      place-items:center;
      z-index: 40;
    }
    .fab.show{display:grid}

    /* Logger table */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(42,42,62,.5);padding:8px 6px;font-size:13px;text-align:left}
    th{color:var(--muted);font-weight:700;font-size:12px}
    .chk{width:20px;height:20px;border-radius:8px;border:1px solid rgba(42,42,62,.7);display:grid;place-items:center}
    .chk.on{border-color: rgba(31,228,138,.6); background: rgba(31,228,138,.12); color: var(--green); font-weight:900}
    .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
    .mini{padding:7px 9px;border-radius:12px;font-size:12px}
    .sep{height:1px;background:rgba(42,42,62,.55);margin:12px 0}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(42,42,62,.7);color:var(--muted)}
    .badge.good{border-color: rgba(31,228,138,.45); color: var(--green); background: rgba(31,228,138,.10);}
    .badge.hard{border-color: rgba(255,176,32,.45); color: var(--amber); background: rgba(255,176,32,.08);}

    /* Calendar */
    .calHead{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .calCell{
      border:1px solid rgba(42,42,62,.6);
      border-radius:14px;
      padding:8px;
      min-height:64px;
      background: rgba(12,12,18,.35);
      cursor:pointer;
    }
    .calCell.off{opacity:.35;cursor:default}
    .calNum{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--green);display:inline-block}
    .dot.amber{background:var(--amber)}
    .calTitle{margin-top:6px;font-size:11px;color:var(--text);opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Modal */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;z-index:60;align-items:flex-end;justify-content:center;
      padding: 14px;
    }
    .overlay.show{display:flex}
    .sheet{
      width:min(560px, 100%);
      background: rgba(18,18,26,.96);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .sheet h3{margin:4px 2px 10px;font-size:16px}
    .toast{
      position:fixed;left:50%;bottom:calc(82px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:#111122;border:1px solid rgba(42,42,62,.8);
      padding:10px 12px;border-radius:999px;font-size:12px;color:var(--text);
      opacity:0;pointer-events:none;transition:.18s;z-index:80
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">

  <!-- SETUP -->
  <div id="screenSetup" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Setup</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="tiny">Set your split once. Then logging is fast + auto-progress.</div>
        <div class="sep"></div>

        <div class="grid2">
          <div>
            <div class="tiny">Units</div>
            <select id="setUnits">
              <option value="lb">lbs</option>
              <option value="kg">kg</option>
            </select>
          </div>
          <div>
            <div class="tiny">Start week date (Monday)</div>
            <input id="setStartWeek" placeholder="YYYY-MM-DD"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">Your Split</div>
            <div class="tiny">Add days (Upper/Lower etc.) + exercises inside them.</div>
          </div>
          <button id="btnAddDay" class="btnGood">+ Day</button>
        </div>

        <div id="daysBox" class="list" style="margin-top:10px">
          <div class="listHeader"><span>Days</span><span class="tiny">tap to add exercises</span></div>
          <div id="daysList"></div>
        </div>

        <div class="sep"></div>
        <button id="btnFinishSetup" class="btnGood" style="width:100%">Finish Setup</button>
        <div class="tiny" style="margin-top:10px">You can edit this later in Settings.</div>
      </div>
    </div>
  </div>

  <!-- TODAY -->
  <div id="screenToday" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Today</div>
        <button id="btnSettings" class="btnGhost" style="width:80px">Settings</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="todayTitle">‚Äî</div>
            <div class="tiny" id="todaySub">‚Äî</div>
          </div>
          <span class="pill" id="todayDatePill">‚Äî</span>
        </div>

        <div class="sep"></div>

        <div id="todayBox" class="tiny muted">‚Äî</div>

        <div class="sep"></div>
        <button id="btnStartWorkout" class="btnGood" style="width:100%">Start Workout</button>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Quick stats</div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="tiny">Planned sessions this week: <b id="stPlanned">0</b></div>
          <div class="tiny">Completed this week: <b id="stDone">0</b></div>
          <div class="tiny">Streak (days trained): <b id="stStreak">0</b></div>
          <div class="tiny">Total sessions: <b id="stTotal">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGGER -->
  <div id="screenLogger" class="screen">
    <div class="topbar">
      <div class="navrow">
        <button id="btnBackToday" class="btnGhost" style="width:80px">Back</button>
        <div class="title" id="loggerTitle">Workout</div>
        <button id="btnFinishWorkout" class="btnGood" style="width:100px">Finish</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="loggerName">‚Äî</div>
            <div class="tiny" id="loggerMeta">‚Äî</div>
          </div>
          <span class="pill" id="loggerDate">‚Äî</span>
        </div>
        <div class="sep"></div>
        <div class="tiny">Tap cells to edit. Use quick buttons for speed.</div>
      </div>

      <div id="loggerExercises"></div>
    </div>
    <button class="fab" id="fabAddExerciseToSession">+</button>
  </div>

  <!-- CALENDAR -->
  <div id="screenCalendar" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Calendar</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="calHead">
          <button id="calPrev" class="btnGhost">‚Äπ</button>
          <div class="name" id="calMonth">‚Äî</div>
          <button id="calNext" class="btnGhost">‚Ä∫</button>
        </div>
        <div class="sep"></div>
        <div class="calGrid tiny muted" style="margin-top:0">
          <div style="text-align:center">S</div><div style="text-align:center">M</div><div style="text-align:center">T</div>
          <div style="text-align:center">W</div><div style="text-align:center">T</div><div style="text-align:center">F</div><div style="text-align:center">S</div>
        </div>
        <div class="calGrid" id="calGrid"></div>
        <div class="tiny" style="margin-top:10px">Tap a day to view workout details.</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Selected Day</div>
        <div class="sep"></div>
        <div id="calDetail" class="tiny muted">Tap a completed day.</div>
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="screenProgress" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Progress</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
  <div class="row" style="justify-content:space-between;align-items:flex-start">
    <div>
      <div class="name">How much stronger did you get?</div>
      <div class="tiny muted">Shows % change using e1RM + PR % change for the selected window.</div>
    </div>
    <div class="right">
      <select id="progWindow">
        <option value="7">Week</option>
        <option value="30" selected>Month</option>
        <option value="365">Year</option>
      </select>
    </div>
  </div>

  <div class="sep"></div>

  <div id="progSummary" class="tiny muted">‚Äî</div>
</div>


      <div class="list">
        <div class="listHeader"><span>Exercises</span><span class="tiny">best e1RM</span></div>
        <div id="progList"></div>
      </div>
    </div>
  </div>

</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabsInner">
    <div class="tab" id="tabToday"><div class="icon">‚ñ¶</div><div>Today</div></div>
    <div class="tab" id="tabLogger"><div class="icon">‚â°</div><div>Log</div></div>
    <div class="tab" id="tabCalendar"><div class="icon">üìÖ</div><div>Calendar</div></div>
    <div class="tab" id="tabProgress"><div class="icon">üìà</div><div>Progress</div></div>
  </div>
</div>

<!-- Modal -->
<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <h3 id="sheetTitle">‚Äî</h3>
    <div id="sheetBody"></div>
    <div class="row" style="margin-top:12px">
      <button id="sheetOk" class="btnGood" style="flex:1">OK</button>
      <button id="sheetCancel" class="btnDanger" style="flex:1">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* =========================
   Storage + State
========================= */
const KEY = "liftlog_mvp_v1";
const $ = (id) => document.getElementById(id);

function toast(msg="Saved"){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 900);
}

function isoToday(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function dayOfWeek(iso){ // 0=Sun..6=Sat
  const d=new Date(iso+"T12:00:00");
  return d.getDay();
}

function prettyDate(iso){
  const d=new Date(iso+"T12:00:00");
  const days=["SUN","MON","TUE","WED","THU","FRI","SAT"];
  const mons=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  return `${days[d.getDay()]}, ${d.getDate()} ${mons[d.getMonth()]} ${d.getFullYear()}`;
}

function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
function num(x, fb=0){ const n=Number(x); return Number.isFinite(n)?n:fb; }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) throw 0;
    const s=JSON.parse(raw);
    s.program ||= null;
    s.sessions ||= [];
    s.exerciseState ||= {}; // exId -> {currentWeight, misses}
    s.prs ||= {}; // exId -> PRs
    s.ui ||= { activeTab:"today" };
    return s;
  }catch{
    return { program:null, sessions:[], exerciseState:{}, prs:{}, ui:{activeTab:"today"} };
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

let state = load();

/* =========================
   Program model helpers
========================= */
const WEEKDAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

function defaultMonday(){
  // set to current week Monday
  const d=new Date();
  const dow=d.getDay(); // Sun 0
  const diff = (dow===0? -6 : 1-dow); // move to Monday
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function ensureExerciseState(exId, startWeight){
  if(!state.exerciseState[exId]){
    state.exerciseState[exId] = { currentWeight: startWeight, misses: 0 };
  }
}

function getPlanForWeekday(dow){
  const p=state.program;
  if(!p) return null;
  return p.split.find(s => s.weekday === dow) || null;
}

/* =========================
   Progress + PR calculations
========================= */
function e1rmEpley(w, r){
  if(w<=0 || r<=0) return 0;
  return w * (1 + (r/30));
}

function computeSession(session){
  let totalVol=0;
  const e1rms = {};
  for(const exLog of session.exercises){
    let best = { w:0, r:0, e1:0 };
    for(const set of exLog.sets){
      const w=num(set.w,0), r=num(set.r,0);
      totalVol += w*r;
      const e1 = e1rmEpley(w,r);
      if(e1 > best.e1){
        best = { w, r, e1 };
      }
    }
    e1rms[exLog.exId] = best.e1;
  }
  session.computed = session.computed || {};
  session.computed.volume = Math.round(totalVol);
  session.computed.e1rm = e1rms;
  return session;
}

function updatePRsFromSession(session){
  for(const exLog of session.exercises){
    const exId = exLog.exId;
    const sets = exLog.sets;
    if(!sets.length) continue;

    state.prs[exId] ||= {
      bestWeight:{value:0,date:null},
      bestE1RM:{value:0,date:null},
      bestVolume:{value:0,date:null},
      bestRepsAtWeight:{weight:0,reps:0,date:null}
    };

    let bestW=0, bestE1=0, exVol=0;

    for(const s of sets){
      const w=num(s.w,0), r=num(s.r,0);
      bestW = Math.max(bestW, w);
      bestE1 = Math.max(bestE1, e1rmEpley(w,r));
      exVol += w*r;

      // reps at weight PR (simple: if same weight and higher reps)
      if(w>0){
        const cur = state.prs[exId].bestRepsAtWeight;
        if(cur.weight===0 || w > cur.weight || (w===cur.weight && r>cur.reps)){
          state.prs[exId].bestRepsAtWeight = { weight:w, reps:r, date: session.date };
        }
      }
    }

    if(bestW > state.prs[exId].bestWeight.value){
      state.prs[exId].bestWeight = { value: bestW, date: session.date };
    }
    if(bestE1 > state.prs[exId].bestE1RM.value){
      state.prs[exId].bestE1RM = { value: Math.round(bestE1), date: session.date };
    }
    if(exVol > state.prs[exId].bestVolume.value){
      state.prs[exId].bestVolume = { value: Math.round(exVol), date: session.date };
    }
  }
}

/* =========================
   Progression engine
========================= */
function isSuccessForExercise(exDef, exLog){
  const sets = exLog.sets;
  if(!sets.length) return false;

  // consider a set "attempted" if reps >0
  const attempted = sets.filter(s => num(s.r,0) > 0);
  if(!attempted.length) return false;

  if(exDef.target.type === "range"){
    const min = num(exDef.target.min, 6);
    return attempted.every(s => num(s.r,0) >= min);
  } else {
    const reps = num(exDef.target.reps, 3);
    return attempted.every(s => num(s.r,0) >= reps);
  }
}

function hitTopRangeAllSets(exDef, exLog){
  if(exDef.target.type !== "range") return false;
  const max = num(exDef.target.max, 10);
  const attempted = exLog.sets.filter(s => num(s.r,0) > 0);
  if(!attempted.length) return false;
  return attempted.every(s => num(s.r,0) >= max);
}

function applyProgression(exDef, exLog){
  const exId = exLog.exId;
  ensureExerciseState(exId, exDef.startWeight);
  const st = state.exerciseState[exId];
  const rule = exDef.rule || {type:"double", inc:5};

  const success = isSuccessForExercise(exDef, exLog);
  const topHit = hitTopRangeAllSets(exDef, exLog);

  // deload rule: if miss 2 times in a row -> -10%
  if(!success){
    st.misses = (st.misses || 0) + 1;
    if((rule.deloadOnMiss2 ?? true) && st.misses >= 2){
      st.currentWeight = Math.max(0, Math.round(st.currentWeight * 0.9));
      st.misses = 0;
    }
    return;
  }

  // success resets misses
  st.misses = 0;

  if(rule.type === "double"){
    const inc = num(rule.inc, 5);
    if(exDef.target.type === "range"){
      if(topHit) st.currentWeight = st.currentWeight + inc;
    }else{
      // fixed reps strength: if success, add
      st.currentWeight = st.currentWeight + inc;
    }
  } else if(rule.type === "fixed"){
    const inc = num(rule.inc, 5);
    st.currentWeight = st.currentWeight + inc;
  } else if(rule.type === "percent"){
    const pct = num(rule.pct, 2.5)/100;
    st.currentWeight = Math.round(st.currentWeight * (1+pct));
  }
}

/* =========================
   UI Routing + Tabs
========================= */
function setActiveTab(tab){
  if(tab === "setup"){
    showScreen("screenSetup");
    renderSetup();
    return;
  }
  state.ui.activeTab = tab;
  save();
  render();
}


function tabEl(id, active){
  const el=$(id);
  el.classList.toggle("active", active);
}

function showScreen(id){
  for(const s of ["screenSetup","screenToday","screenLogger","screenCalendar","screenProgress"]){
    $(s).classList.toggle("show", s===id);
  }
}

/* =========================
   Modal helpers
========================= */
let modal = { onOk:null, onCancel:null };

function openModal(title, bodyHtml, okText="OK", cancelText="Cancel", onOk=null, onCancel=null){
  $("sheetTitle").textContent = title;
  $("sheetBody").innerHTML = bodyHtml;
  $("sheetOk").textContent = okText;
  $("sheetCancel").textContent = cancelText;
  modal.onOk = onOk;
  modal.onCancel = onCancel;
  $("overlay").classList.add("show");
}
function closeModal(){ $("overlay").classList.remove("show"); modal.onOk=null; modal.onCancel=null; }
$("overlay").addEventListener("click", (e)=>{ if(e.target === $("overlay")) closeModal(); });
$("sheetOk").addEventListener("click", ()=>{ if(modal.onOk) modal.onOk(); else closeModal(); });
$("sheetCancel").addEventListener("click", ()=>{ if(modal.onCancel) modal.onCancel(); closeModal(); });

/* =========================
   Setup Screen
========================= */
function renderSetup(){
  $("setUnits").value = state.program?.units || "lb";
  $("setStartWeek").value = state.program?.startWeekDate || defaultMonday();

  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{} };
  const list = $("daysList");
  list.innerHTML = "";

  if(!p.split.length){
    list.innerHTML = `<div class="item"><div class="tiny muted">No days yet. Tap ‚Äú+ Day‚Äù.</div></div>`;
  } else {
    for(const day of p.split){
      const exCount = (day.exercises||[]).length;
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div>
          <div class="name">${escapeHtml(WEEKDAYS[day.weekday])} ‚Äî ${escapeHtml(day.title)}</div>
          <div class="tiny muted">${exCount} exercise(s)</div>
        </div>
        <div class="right">
          <button class="mini btnGhost" data-act="addEx" data-id="${day.id}">+ Exercise</button>
          <button class="mini btnDanger" data-act="delDay" data-id="${day.id}">Delete</button>
        </div>
      `;
      list.appendChild(div);

      // show exercises
      const exDiv = document.createElement("div");
      exDiv.style.padding="0 12px 10px";
      exDiv.innerHTML = (day.exercises||[]).map(exId=>{
        const ex = p.exercises[exId];
        if(!ex) return "";
        const tgt = ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const rule = ex.rule?.type || "double";
        const ruleTxt = rule==="double" ? `Double +${ex.rule.inc||5}` :
                        rule==="fixed" ? `Weekly +${ex.rule.inc||5}` :
                        `+${ex.rule.pct||2.5}%`;
        return `
          <div class="item" style="border-radius:14px;margin-top:8px;background:rgba(12,12,18,.35);border:1px solid rgba(42,42,62,.5)">
            <div>
              <div class="name">${escapeHtml(ex.name)}</div>
              <div class="tiny muted">${ex.sets} sets ‚Ä¢ ${tgt} reps ‚Ä¢ start ${ex.startWeight}${p.units} ‚Ä¢ ${ruleTxt}</div>
            </div>
            <div class="right">
              <button class="mini btnDanger" data-act="delEx" data-day="${day.id}" data-ex="${exId}">Remove</button>
            </div>
          </div>
        `;
      }).join("");
      list.appendChild(exDiv);
    }
  }

  // attach handlers
  list.querySelectorAll("button[data-act]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const act=b.getAttribute("data-act");
      const id=b.getAttribute("data-id");
      if(act==="delDay") deleteDay(id);
      if(act==="addEx") addExerciseToDay(id);
      if(act==="delEx"){
        const dayId=b.getAttribute("data-day");
        const exId=b.getAttribute("data-ex");
        removeExerciseFromDay(dayId, exId);
      }
    });
  });
}

function deleteDay(dayId){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{} };
  p.split = p.split.filter(d => d.id !== dayId);
  // (we keep exercises in library; removing from day only)
  state.program = p;
  save();
  render();
}

function addDay(){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{} };
  openModal("Add Day",
    `
      <div class="grid2">
        <div>
          <div class="tiny">Weekday</div>
          <select id="mWeekday">
            ${WEEKDAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("")}
          </select>
        </div>
        <div>
          <div class="tiny">Title</div>
          <input id="mTitle" placeholder="Upper / Lower / Push..."/>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:10px">Example: Tue Upper, Wed Lower, Fri Upper‚Ä¶</div>
    `,
    "Add","Cancel",
    ()=>{
      const wd = num(document.getElementById("mWeekday").value, 1);
      const title = (document.getElementById("mTitle").value||"Workout").trim();
      p.split.push({ id: uid(), weekday: wd, title, exercises: [] });
      state.program = p;
      save();
      closeModal();
      render();
      toast("Day added");
    },
    ()=>{}
  );
}

function addExerciseToDay(dayId){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{} };
  const day = p.split.find(d=>d.id===dayId);
  if(!day) return;

  openModal("Add Exercise",
    `
      <div class="grid2">
        <div class="tiny" style="grid-column:1/-1">Name</div>
        <input id="exName" class="full" placeholder="Bench Press / Squat / Pull-Ups"/>

        <div>
          <div class="tiny">Sets</div>
          <input id="exSets" inputmode="numeric" value="4"/>
        </div>

        <div>
          <div class="tiny">Start weight (${p.units})</div>
          <input id="exW" inputmode="decimal" value="0"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">Target</div>
        <select id="exTargetType">
          <option value="range">Rep range</option>
          <option value="fixed">Fixed reps</option>
        </select>

        <div id="rangeBox" class="grid2" style="grid-column:1/-1">
          <div>
            <div class="tiny">Min</div>
            <input id="exMin" inputmode="numeric" value="6"/>
          </div>
          <div>
            <div class="tiny">Max</div>
            <input id="exMax" inputmode="numeric" value="8"/>
          </div>
        </div>

        <div id="fixedBox" style="grid-column:1/-1; display:none">
          <div class="tiny">Reps</div>
          <input id="exFixed" inputmode="numeric" value="3"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">Progression rule</div>
        <select id="exRuleType">
          <option value="double">Double progression</option>
          <option value="fixed">Fixed weekly increase</option>
          <option value="percent">Percent increase</option>
        </select>

        <div id="incBox" class="grid2" style="grid-column:1/-1">
          <div>
            <div class="tiny">Increase (${p.units})</div>
            <input id="exInc" inputmode="decimal" value="5"/>
          </div>
          <div>
            <div class="tiny">Deload after 2 misses</div>
            <select id="exDeload">
              <option value="yes">Yes (-10%)</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>

        <div id="pctBox" class="grid2" style="grid-column:1/-1; display:none">
          <div>
            <div class="tiny">Percent (%)</div>
            <input id="exPct" inputmode="decimal" value="2.5"/>
          </div>
          <div></div>
        </div>

        <div class="tiny muted" style="grid-column:1/-1;margin-top:6px">
          Tip: For bodyweight moves, start weight can be 0.
        </div>
      </div>
    `,
    "Add","Cancel",
    ()=>{
      const name = (document.getElementById("exName").value||"").trim();
      if(!name){ alert("Enter exercise name."); return; }
      const sets = clamp(num(document.getElementById("exSets").value, 4), 1, 10);
      const startW = num(document.getElementById("exW").value, 0);

      const ttype = document.getElementById("exTargetType").value;
      let target;
      if(ttype==="range"){
        target = { type:"range", min: clamp(num(document.getElementById("exMin").value,6),1,50), max: clamp(num(document.getElementById("exMax").value,8),1,50) };
        if(target.max < target.min) target.max = target.min;
      } else {
        target = { type:"fixed", reps: clamp(num(document.getElementById("exFixed").value,3),1,50) };
      }

      const rtype = document.getElementById("exRuleType").value;
      const deload = (document.getElementById("exDeload")?.value || "yes") === "yes";
      let rule;
      if(rtype==="percent"){
        rule = { type:"percent", pct: num(document.getElementById("exPct").value, 2.5), deloadOnMiss2: deload };
      } else {
        rule = { type: rtype, inc: num(document.getElementById("exInc").value, 5), deloadOnMiss2: deload };
      }

      const exId = "ex_"+uid();
      p.exercises[exId] = { name, sets, target, startWeight:startW, rule };
      day.exercises.push(exId);
      state.program = p;

      ensureExerciseState(exId, startW);

      save();
      closeModal();
      render();
      toast("Exercise added");
    },
    ()=>{}
  );

  // toggle fields in modal
  setTimeout(()=>{
    const tsel = document.getElementById("exTargetType");
    const rsel = document.getElementById("exRuleType");
    const rangeBox = document.getElementById("rangeBox");
    const fixedBox = document.getElementById("fixedBox");
    const incBox = document.getElementById("incBox");
    const pctBox = document.getElementById("pctBox");

    const sync = ()=>{
      const t = tsel.value;
      rangeBox.style.display = (t==="range") ? "" : "none";
      fixedBox.style.display = (t==="fixed") ? "" : "none";
    };
    const syncRule = ()=>{
      const r = rsel.value;
      incBox.style.display = (r==="percent") ? "none" : "";
      pctBox.style.display = (r==="percent") ? "" : "none";
    };
    tsel.addEventListener("change", sync);
    rsel.addEventListener("change", syncRule);
    sync(); syncRule();
  }, 0);
}

function removeExerciseFromDay(dayId, exId){
  const p = state.program;
  if(!p) return;
  const day = p.split.find(d=>d.id===dayId);
  if(!day) return;
  day.exercises = (day.exercises||[]).filter(x=>x!==exId);
  state.program = p;
  save();
  render();
  toast("Removed");
}

$("btnAddDay").addEventListener("click", addDay);

$("btnFinishSetup").addEventListener("click", ()=>{
  // build program from UI
  const units = $("setUnits").value;
  const startWeekDate = ($("setStartWeek").value||"").trim() || defaultMonday();
  const p = state.program || { units, startWeekDate, split:[], exercises:{} };
  p.units = units;
  p.startWeekDate = startWeekDate;

  // require at least 1 day
  if(!p.split.length){
    alert("Add at least 1 training day.");
    return;
  }
  state.program = p;
  save();
  toast("Setup saved");
  setActiveTab("today");
});

/* =========================
   Today + Logger
========================= */
let sessionDraft = null; // current workout draft

function getSessionByDate(date){
  return state.sessions.find(s=>s.date===date) || null;
}

function weekKeyForDate(iso){
  // derive Monday ISO for this week (simple)
  const d=new Date(iso+"T12:00:00");
  const dow=d.getDay();
  const diff = (dow===0? -6 : 1-dow);
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function countWeekStats(){
  const today = isoToday();
  const wk = weekKeyForDate(today);
  const p = state.program;
  const planned = p ? p.split.length : 0;

  const doneThisWeek = state.sessions.filter(s => weekKeyForDate(s.date)===wk).length;

  // streak = consecutive days with sessions ending today
  let streak=0;
  const datesSet = new Set(state.sessions.map(s=>s.date));
  let d = new Date(today+"T12:00:00");
  for(;;){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
    const iso=`${y}-${m}-${day}`;
    if(datesSet.has(iso)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }

  $("stPlanned").textContent = planned;
  $("stDone").textContent = doneThisWeek;
  $("stStreak").textContent = streak;
  $("stTotal").textContent = state.sessions.length;
}

function plannedWorkoutForToday(){
  const p=state.program;
  if(!p) return null;
  const d=isoToday();
  const dow=dayOfWeek(d);
  const plan = getPlanForWeekday(dow);
  return { date:d, dow, plan };
}

function renderToday(){
  const p=state.program;
  const info = plannedWorkoutForToday();
  const d=isoToday();
  $("todayDatePill").textContent = d;
  $("todaySub").textContent = prettyDate(d);

  if(!p || !info?.plan){
    $("todayTitle").textContent = "Rest Day ‚úÖ";
    $("todayBox").innerHTML = `No workout scheduled for today.`;
    $("btnStartWorkout").disabled = true;
  } else {
    $("todayTitle").textContent = info.plan.title;
    const exIds = info.plan.exercises || [];
    if(!exIds.length){
      $("todayBox").innerHTML = `No exercises in today‚Äôs plan. (Add in Settings)`;
      $("btnStartWorkout").disabled = true;
    } else {
      const lines = exIds.map(exId=>{
        const ex=p.exercises[exId];
        if(!ex) return "";
        ensureExerciseState(exId, ex.startWeight);
        const st=state.exerciseState[exId];
        const tgt = ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const w = st.currentWeight;
        return `<div class="item">
          <div>
            <div class="name">${escapeHtml(ex.name)}</div>
            <div class="tiny muted">${ex.sets} sets ‚Ä¢ ${tgt} reps ‚Ä¢ target <b>${w}${p.units}</b></div>
          </div>
          <span class="pill">next: ${w}${p.units}</span>
        </div>`;
      }).join("");
      $("todayBox").innerHTML = `<div class="list" style="margin-top:0"><div class="listHeader"><span>Planned</span><span class="tiny">targets</span></div>${lines}</div>`;
      $("btnStartWorkout").disabled = false;
    }
  }

  countWeekStats();
}

function buildSessionDraft(){
  const p=state.program;
  const {date,dow,plan} = plannedWorkoutForToday();
  const exLogs = (plan.exercises||[]).map(exId=>{
    const ex = p.exercises[exId];
    ensureExerciseState(exId, ex.startWeight);
    const w = state.exerciseState[exId].currentWeight;
    const sets = Array.from({length: ex.sets}, ()=>({ w: w, r: 0, done:false }));
    return { exId, sets, note:"" };
  });

  return {
    id: "sess_"+uid(),
    date,
    weekday: dow,
    workoutTitle: plan.title,
    rating: "normal",
    notes: "",
    exercises: exLogs,
    computed: { volume:0, e1rm:{} }
  };
}

$("btnStartWorkout").addEventListener("click", ()=>{
  sessionDraft = buildSessionDraft();
  setActiveTab("logger");
});

$("btnBackToday").addEventListener("click", ()=>{
  setActiveTab("today");
});

/* =========================
   Logger rendering + controls
========================= */
function renderLogger(){
  const p=state.program;
  if(!sessionDraft || !p){
    $("loggerExercises").innerHTML = `<div class="content"><div class="card"><div class="tiny muted">No active workout. Start from Today.</div></div></div>`;
    $("fabAddExerciseToSession").classList.remove("show");
    return;
  }

  $("loggerTitle").textContent = "Log";
  $("loggerName").textContent = sessionDraft.workoutTitle;
  $("loggerMeta").textContent = `Targets in ${p.units}. Quick buttons use your jump size in Settings.`;
  $("loggerDate").textContent = sessionDraft.date;

  const box=$("loggerExercises");
  box.innerHTML = "";

  const jump = state.program?.settings?.jump ?? 5;

  sessionDraft.exercises.forEach((exLog, idx)=>{
    const exDef = p.exercises[exLog.exId];
    if(!exDef) return;

    const tgt = exDef.target.type==="range" ? `${exDef.target.min}-${exDef.target.max}` : `${exDef.target.reps}`;
    const st = state.exerciseState[exLog.exId] || { currentWeight: exDef.startWeight, misses:0 };
    const targetW = st.currentWeight;

    const card=document.createElement("div");
    card.className="card";
    card.style.marginTop="12px";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="name">${escapeHtml(exDef.name)}</div>
          <div class="tiny muted">${exDef.sets} sets ‚Ä¢ ${tgt} reps ‚Ä¢ target <b>${targetW}${p.units}</b></div>
        </div>
        <div class="right">
          <span class="badge">misses: ${st.misses||0}</span>
        </div>
      </div>

      <div class="sep"></div>

      <table>
        <thead>
          <tr>
            <th style="width:42px">‚úì</th>
            <th style="width:64px">Set</th>
            <th>Weight</th>
            <th>Reps</th>
            <th style="width:120px">Quick</th>
          </tr>
        </thead>
        <tbody>
          ${exLog.sets.map((s,i)=>`
            <tr>
              <td><div class="chk ${s.done?'on':''}" data-act="toggle" data-e="${idx}" data-i="${i}">${s.done?'‚úì':''}</div></td>
              <td>${i+1}</td>
              <td><input inputmode="decimal" value="${escapeAttr(s.w)}" data-act="w" data-e="${idx}" data-i="${i}" style="width:100%"/></td>
              <td><input inputmode="numeric" value="${escapeAttr(s.r)}" data-act="r" data-e="${idx}" data-i="${i}" style="width:100%"/></td>
              <td>
                <div class="miniBtns">
                  <button class="mini btnGhost" data-act="repUp" data-e="${idx}" data-i="${i}">+1</button>
                  <button class="mini btnGhost" data-act="repDn" data-e="${idx}" data-i="${i}">-1</button>
                  <button class="mini btnGhost" data-act="wUp" data-e="${idx}" data-i="${i}">+${jump}</button>
                  <button class="mini btnGhost" data-act="wDn" data-e="${idx}" data-i="${i}">-${jump}</button>
                  <button class="mini btnGhost" data-act="copyPrev" data-e="${idx}" data-i="${i}">Copy</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="sep"></div>

      <div class="grid2">
        <div>
          <div class="tiny">Exercise note</div>
          <input value="${escapeAttr(exLog.note||"")}" data-act="note" data-e="${idx}" placeholder="felt heavy, form‚Ä¶"/>
        </div>
        <div>
          <div class="tiny">Rule</div>
          <div class="tiny muted">${ruleText(exDef, p.units)}</div>
        </div>
      </div>
    `;

    // event delegation inside card
    card.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(!(t instanceof HTMLElement)) return;
      const act = t.getAttribute("data-act");
      if(!act) return;

      const e = num(t.getAttribute("data-e"), -1);
      const i = num(t.getAttribute("data-i"), -1);
      if(e<0) return;

      const exL = sessionDraft.exercises[e];
      const set = (i>=0) ? exL.sets[i] : null;
      const jump = state.program?.settings?.jump ?? 5;

      if(act==="toggle" && set){
        set.done = !set.done;
        // auto-fill reps if toggling on with 0 reps
        if(set.done && num(set.r,0)===0){
          if(exDef.target.type==="range") set.r = exDef.target.min;
          else set.r = exDef.target.reps;
        }
        render();
      }
      if(act==="repUp" && set){ set.r = clamp(num(set.r,0)+1, 0, 100); render(); }
      if(act==="repDn" && set){ set.r = clamp(num(set.r,0)-1, 0, 100); render(); }
      if(act==="wUp" && set){ set.w = num(set.w,0)+jump; render(); }
      if(act==="wDn" && set){ set.w = Math.max(0, num(set.w,0)-jump); render(); }
      if(act==="copyPrev" && set){
        if(i>0){
          set.w = exL.sets[i-1].w;
          set.r = exL.sets[i-1].r;
          render();
        }
      }
    });

    // inputs
    card.querySelectorAll("input[data-act='w']").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1), i=num(inp.getAttribute("data-i"),-1);
        sessionDraft.exercises[e].sets[i].w = num(inp.value,0);
      });
    });
    card.querySelectorAll("input[data-act='r']").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1), i=num(inp.getAttribute("data-i"),-1);
        sessionDraft.exercises[e].sets[i].r = num(inp.value,0);
      });
    });
    card.querySelectorAll("input[data-act='note']").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1);
        sessionDraft.exercises[e].note = inp.value;
      });
    });

    box.appendChild(card);
  });

  $("fabAddExerciseToSession").classList.add("show"); // (MVP placeholder)
}

function ruleText(exDef, units){
  const r=exDef.rule||{type:"double",inc:5};
  const deload = (r.deloadOnMiss2 ?? true) ? " ‚Ä¢ deload -10% after 2 misses" : "";
  if(r.type==="double"){
    if(exDef.target.type==="range") return `Double progression: hit top reps on all sets ‚Üí +${r.inc||5}${units}.${deload}`;
    return `Fixed reps: complete all sets ‚Üí +${r.inc||5}${units}.${deload}`;
  }
  if(r.type==="fixed"){
    return `Weekly increase: if successful ‚Üí +${r.inc||5}${units}.${deload}`;
  }
  return `Percent increase: if successful ‚Üí +${r.pct||2.5}%.${deload}`;
}

$("btnFinishWorkout").addEventListener("click", ()=>{
  if(!sessionDraft) return;

  // quick rating
  openModal("Finish Workout",
    `
      <div class="tiny">How did it feel?</div>
      <div class="row" style="margin-top:10px">
        <button class="mini btnGhost" id="rateEasy">Easy</button>
        <button class="mini btnGhost" id="rateNorm">Normal</button>
        <button class="mini btnGhost" id="rateHard">Hard</button>
      </div>
      <div class="sep"></div>
      <div class="tiny">Workout notes (optional)</div>
      <textarea id="sessNote" placeholder="Anything to remember‚Ä¶"></textarea>
      <div class="sep"></div>
      <div class="tiny muted">We‚Äôll save your sets, compute volume, PRs, and update next targets automatically.</div>
    `,
    "Save","Cancel",
    ()=>{
      const note = (document.getElementById("sessNote").value||"").trim();
      sessionDraft.notes = note;
      // default rating if not picked
      if(!sessionDraft.rating) sessionDraft.rating = "normal";

      // compute + save session
      computeSession(sessionDraft);
      state.sessions.push(sessionDraft);

      // PRs
      updatePRsFromSession(sessionDraft);

      // progression (updates currentWeight/misses)
      for(const exLog of sessionDraft.exercises){
        const exDef = state.program.exercises[exLog.exId];
        if(exDef) applyProgression(exDef, exLog);
      }

      save();
      closeModal();
      toast("Workout saved");
      sessionDraft = null;
      setActiveTab("today");
    },
    ()=>{}
  );

  setTimeout(()=>{
    document.getElementById("rateEasy").addEventListener("click", ()=>{ sessionDraft.rating="easy"; toast("Easy"); });
    document.getElementById("rateNorm").addEventListener("click", ()=>{ sessionDraft.rating="normal"; toast("Normal"); });
    document.getElementById("rateHard").addEventListener("click", ()=>{ sessionDraft.rating="hard"; toast("Hard"); });
  }, 0);
});

$("fabAddExerciseToSession").addEventListener("click", ()=>{
  toast("MVP: add exercises in Settings");
});

/* =========================
   Settings (simple)
========================= */
$("btnSettings").addEventListener("click", ()=>{
  const p = state.program;
  openModal("Settings",
    `
      <div class="grid2">
        <div>
          <div class="tiny">Jump size (${p.units})</div>
          <input id="stJump" inputmode="decimal" value="${escapeAttr(p.settings?.jump ?? 5)}"/>
        </div>
        <div>
          <div class="tiny">Edit split</div>
          <button id="goSetup" class="btnGhost" style="width:100%">Open Setup</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button id="exportBtn" class="btnGhost" style="flex:1">Export backup</button>
        <button id="importBtn" class="btnGhost" style="flex:1">Import backup</button>
      </div>
      <div class="sep"></div>
      <button id="wipeBtn" class="btnDanger" style="width:100%">Delete ALL data</button>
    `,
    "Save","Close",
    ()=>{
      const jump = num(document.getElementById("stJump").value, 5);
      state.program.settings ||= {};
      state.program.settings.jump = jump;
      save();
      closeModal();
      toast("Settings saved");
      render();
    },
    ()=>{}
  );

  setTimeout(()=>{
    document.getElementById("goSetup").addEventListener("click", ()=>{
      closeModal();
      showScreen("screenSetup");
      render();
    });

    document.getElementById("goSetup").addEventListener("click", ()=>{
  closeModal();
  state.ui.activeTab = "setup";   // ‚Üê force setup mode
  save();
  showScreen("screenSetup");
  renderSetup();
});


    document.getElementById("importBtn").addEventListener("click", ()=>{
      const raw = prompt("Paste backup JSON:");
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        state = parsed;
        save();
        toast("Imported");
        closeModal();
        render();
      }catch{
        alert("Import failed.");
      }
    });

    document.getElementById("wipeBtn").addEventListener("click", ()=>{
      if(confirm("Delete ALL data?")) {
        localStorage.removeItem(KEY);
        state = load();
        toast("Wiped");
        closeModal();
        render();
      }
    });
  }, 0);
});

/* =========================
   Calendar
========================= */
let calCursor = (()=>{ const d=new Date(); return { y:d.getFullYear(), m:d.getMonth() }; })();
let calSelected = null;

function monthName(y,m){
  const mons=["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${mons[m]} ${y}`;
}

function renderCalendar(){
  $("calMonth").textContent = monthName(calCursor.y, calCursor.m);
  const grid = $("calGrid");
  grid.innerHTML = "";

  const first = new Date(calCursor.y, calCursor.m, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(calCursor.y, calCursor.m+1, 0).getDate();

  const prevDays = startDow;
  const prevMonthDays = new Date(calCursor.y, calCursor.m, 0).getDate();

  const cells = [];
  for(let i=0;i<prevDays;i++){
    const dayNum = prevMonthDays - prevDays + 1 + i;
    cells.push({ off:true, day:dayNum, y: calCursor.m===0? calCursor.y-1 : calCursor.y, m: calCursor.m===0? 11 : calCursor.m-1 });
  }
  for(let d=1; d<=daysInMonth; d++){
    cells.push({ off:false, day:d, y: calCursor.y, m: calCursor.m });
  }
  while(cells.length % 7 !== 0){
    const dayNum = (cells.length - (prevDays+daysInMonth)) + 1;
    cells.push({ off:true, day:dayNum, y: calCursor.m===11? calCursor.y+1 : calCursor.y, m: calCursor.m===11? 0 : calCursor.m+1 });
  }

  // completed sessions map
  const doneMap = new Map();
  for(const s of state.sessions){
    doneMap.set(s.date, s);
  }

  // planned workouts map (date -> title)
  const plannedMap = new Map();
  const p = state.program;
  if(p?.split?.length){
    for(const c of cells){
      if(c.off) continue;
      const mm = String(c.m+1).padStart(2,"0");
      const dd = String(c.day).padStart(2,"0");
      const iso = `${c.y}-${mm}-${dd}`;
      const dow = new Date(iso+"T12:00:00").getDay();
      const plan = p.split.find(x => x.weekday === dow);
      if(plan) plannedMap.set(iso, plan.title);
    }
  }

  for(const c of cells){
    const mm = String(c.m+1).padStart(2,"0");
    const dd = String(c.day).padStart(2,"0");
    const iso = `${c.y}-${mm}-${dd}`;

    const sess = doneMap.get(iso);
    const plannedTitle = plannedMap.get(iso);

    const cell=document.createElement("div");
    cell.className = "calCell" + (c.off ? " off" : "");

    // dot logic:
    // - completed = green (or amber if hard)
    // - planned only = blue
    let dotHtml = "";
    if(sess){
      dotHtml = `<span class="dot ${sess.rating==='hard'?'amber':''}"></span>`;
    } else if(plannedTitle){
      dotHtml = `<span class="dot" style="background: var(--blue)"></span>`;
    }

    // title logic:
    // - show completed title, else planned title
    const title = sess ? sess.workoutTitle : (plannedTitle || "");

    cell.innerHTML = `
      <div class="calNum">
        <span>${c.day}</span>
        <span>${dotHtml}</span>
      </div>
      <div class="calTitle">${title ? escapeHtml(title) : ""}</div>
    `;

    // click behavior:
    // - completed: show details
    // - planned only: show message
    if(!c.off){
      cell.addEventListener("click", ()=>{
        if(sess){
          calSelected = sess.date;
          renderCalDetail(sess);
        } else if(plannedTitle){
          $("calDetail").innerHTML = `
            <div class="tiny"><b>${prettyDate(iso)}</b> ‚Ä¢ Planned: <b>${escapeHtml(plannedTitle)}</b></div>
            <div class="sep"></div>
            <div class="tiny muted">Log the workout from the Today tab to make this a completed session.</div>
          `;
        }
      });
    }

    grid.appendChild(cell);
  }

  if(calSelected){
    const sess = doneMap.get(calSelected);
    if(sess) renderCalDetail(sess);
    else $("calDetail").textContent="Tap a completed day.";
  }
}


function renderCalDetail(sess){
  const p = state.program;
  const units = p?.units || "lb";
  const prMsgs = getPRMessages(sess);

  const exLines = sess.exercises.map(exLog=>{
    const ex = p?.exercises?.[exLog.exId];
    const name = ex ? ex.name : exLog.exId;
    const setsStr = exLog.sets.map((s,i)=>`${i+1}:${num(s.w,0)}x${num(s.r,0)}`).join("  ");
    return `<div class="item">
      <div>
        <div class="name">${escapeHtml(name)}</div>
        <div class="tiny muted">${escapeHtml(setsStr)}</div>
      </div>
    </div>`;
  }).join("");

  $("calDetail").innerHTML = `
    <div class="tiny"><b>${prettyDate(sess.date)}</b> ‚Ä¢ ${escapeHtml(sess.workoutTitle)} ‚Ä¢ <span class="badge ${sess.rating==='hard'?'hard':'good'}">${escapeHtml(sess.rating)}</span></div>
    <div class="sep"></div>
    <div class="tiny">Volume: <b>${sess.computed?.volume ?? 0}</b> ${units}</div>
    <div class="tiny">PRs: ${prMsgs.length ? prMsgs.map(m=>`<span class="badge good">${escapeHtml(m)}</span>`).join(" ") : `<span class="muted">none</span>`}</div>
    <div class="sep"></div>
    <div class="list" style="margin-top:0">
      <div class="listHeader"><span>Logged</span><span class="tiny">sets</span></div>
      ${exLines}
    </div>
    ${sess.notes ? `<div class="sep"></div><div class="tiny muted">${escapeHtml(sess.notes)}</div>` : ""}
  `;
}

function getPRMessages(sess){
  // quick PR messages by comparing session e1RM to stored PR after saving
  // Here we just show "e1RM PR" for exercises where this session == best date
  const msgs=[];
  for(const exLog of sess.exercises){
    const exId = exLog.exId;
    const pr = state.prs[exId];
    if(pr?.bestE1RM?.date === sess.date) msgs.push("New e1RM PR");
    if(pr?.bestWeight?.date === sess.date) msgs.push("New Weight PR");
    if(pr?.bestVolume?.date === sess.date) msgs.push("New Volume PR");
  }
  // de-dupe
  return [...new Set(msgs)];
}

$("calPrev").addEventListener("click", ()=>{
  calCursor.m -= 1;
  if(calCursor.m<0){ calCursor.m=11; calCursor.y-=1; }
  render();
});
$("calNext").addEventListener("click", ()=>{
  calCursor.m += 1;
  if(calCursor.m>11){ calCursor.m=0; calCursor.y+=1; }
  render();
});

/* =========================
   Progress screen
========================= */
function renderProgress(){
  const p = state.program;
  const box = $("progList");
  box.innerHTML = "";

  if(!p){
    box.innerHTML = `<div class="item"><div class="tiny muted">Finish setup first.</div></div>`;
    return;
  }

  const exIds = Object.keys(p.exercises || {});
  if(!exIds.length){
    box.innerHTML = `<div class="item"><div class="tiny muted">No exercises.</div></div>`;
    return;
  }

  // window days (default month)
  const sel = $("progWindow");
  const days = num(sel?.value, 30);

  // date range
  const endIso = isoToday();
  const end = new Date(endIso + "T12:00:00");
  const start = new Date(end);
  start.setDate(start.getDate() - (days - 1));
  const startIso = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,"0")}-${String(start.getDate()).padStart(2,"0")}`;

  // helper: get best e1RM for an exercise on a given session
  function bestE1rmFromSession(exLog){
    let best = 0;
    for(const s of exLog.sets || []){
      const w = num(s.w,0), r = num(s.r,0);
      best = Math.max(best, e1rmEpley(w,r));
    }
    return best;
  }

  // prebuild maps:
  // - window series: exId -> [{date, e1rm}]
  // - before max PR: exId -> max e1rm before window start
  const series = {};
  const beforeMax = {};
  for(const exId of exIds){ series[exId] = []; beforeMax[exId] = 0; }

  for(const sess of (state.sessions || [])){
    const d = sess.date;
    // ignore sessions without exercises
    if(!sess.exercises) continue;

    for(const exLog of sess.exercises){
      const exId = exLog.exId;
      if(!series[exId]) continue;

      const best = bestE1rmFromSession(exLog);
      if(best <= 0) continue;

      if(d >= startIso && d <= endIso){
        series[exId].push({ date: d, e1rm: best });
      } else if(d < startIso){
        beforeMax[exId] = Math.max(beforeMax[exId], best);
      }
    }
  }

  // overall summary numbers
  let counted = 0;
  let sumPct = 0;

  for(const exId of exIds){
    const ex = p.exercises[exId];
    const arr = series[exId] || [];
    arr.sort((a,b)=> a.date.localeCompare(b.date));

    const first = arr.length ? arr[0].e1rm : 0;
    const last  = arr.length ? arr[arr.length-1].e1rm : 0;

    // % stronger in window (e1RM)
    let pctStr = "‚Äî";
    let pctNum = null;
    if(first > 0 && last > 0){
      pctNum = ((last - first) / first) * 100;
      pctStr = `${pctNum >= 0 ? "+" : ""}${pctNum.toFixed(1)}%`;
      counted++;
      sumPct += pctNum;
    }

    // PR % change in window (best in window vs best before window)
    const winBest = arr.reduce((m,x)=>Math.max(m,x.e1rm), 0);
    const prevBest = beforeMax[exId] || 0;
    // PR % change ONLY for Bench + Squat (by name match)
const exNameLower = (ex.name || "").toLowerCase();
const isBench = exNameLower.includes("bench");
const isSquat = exNameLower.includes("squat");
const isPrimaryPR = isBench || isSquat;

const winBest = arr.reduce((m,x)=>Math.max(m,x.e1rm), 0);
const prevBest = beforeMax[exId] || 0;

let prPctStr = "‚Äî";
if(isPrimaryPR){
  if(winBest > 0 && prevBest > 0){
    const prPct = ((winBest - prevBest) / prevBest) * 100;
    prPctStr = `${prPct >= 0 ? "+" : ""}${prPct.toFixed(1)}%`;
  } else if(winBest > 0 && prevBest === 0){
    prPctStr = `NEW`;
  }
}


    // text for the right side
    const right = `
      <div class="right" style="flex-direction:column;align-items:flex-end;gap:2px">
        <span class="pill">Strength: <b>${pctStr}</b></span>
        <span class="pill">PR: <b>${prPctStr}</b></span>
      </div>
    `;

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="name">${escapeHtml(ex.name)}</div>
        <div class="tiny muted">
          Window: ${days===7?"Week":days===30?"Month":"Year"} ‚Ä¢
          e1RM ${first?Math.round(first):"‚Äî"} ‚Üí ${last?Math.round(last):"‚Äî"} ‚Ä¢
          Best in window: ${winBest?Math.round(winBest):"‚Äî"}
        </div>
      </div>
      ${right}
    `;
    box.appendChild(div);
  }

  // summary line
  const avg = counted ? (sumPct / counted) : null;
  const label = days===7 ? "this week" : days===30 ? "this month" : "this year";
  $("progSummary").textContent =
    avg === null
      ? `No enough data ${label} yet. Log a couple sessions and this will fill in.`
      : `Average strength change ${label}: ${avg >= 0 ? "+" : ""}${avg.toFixed(1)}% (across ${counted} exercise(s)).`;
}

/* =========================
   Render + Init
========================= */
function render(){
  // setup default program if not exists (for editing screen)
  if(!state.program){
    showScreen("screenSetup");
    renderSetup();
    // tabs states
    tabEl("tabToday", false);
    tabEl("tabLogger", false);
    tabEl("tabCalendar", false);
    tabEl("tabProgress", false);
    $("fabAddExerciseToSession").classList.remove("show");
    return;
  }

  // active tab
  const t = state.ui.activeTab || "today";
  tabEl("tabToday", t==="today");
  tabEl("tabLogger", t==="logger");
  tabEl("tabCalendar", t==="calendar");
  tabEl("tabProgress", t==="progress");

  if(t==="today"){
    showScreen("screenToday");
    renderToday();
    $("fabAddExerciseToSession").classList.remove("show");
  }
  if(t==="logger"){
    showScreen("screenLogger");
    renderLogger();
  }
  if(t==="calendar"){
    showScreen("screenCalendar");
    renderCalendar();
    $("fabAddExerciseToSession").classList.remove("show");
  }
  if(t==="progress"){
    showScreen("screenProgress");
    renderProgress();
    $("fabAddExerciseToSession").classList.remove("show");
  }
}

// Tabs
$("tabToday").addEventListener("click", ()=>setActiveTab("today"));
$("tabLogger").addEventListener("click", ()=>{
  // if no draft, bounce to today
  if(!sessionDraft) { toast("Start from Today"); setActiveTab("today"); return; }
  setActiveTab("logger");
});
$("tabCalendar").addEventListener("click", ()=>setActiveTab("calendar"));
$("tabProgress").addEventListener("click", ()=>setActiveTab("progress"));
// Progress window selector live-update
setTimeout(()=>{
  const sel = document.getElementById("progWindow");
  if(sel){
    sel.addEventListener("change", ()=>{
      // re-render progress screen when window changes
      if(state.ui.activeTab === "progress") render();
    });
  }
}, 0);

// Setup screen first time
if(!state.program){
  // create a blank program shell so setup UI works
  state.program = { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{}, settings:{ jump:5 } };
  save();
}

// Render setup if they have no split yet
if(state.program && (!state.program.split || state.program.split.length===0)){
  showScreen("screenSetup");
  renderSetup();
} else {
  render();
}

// If setup screen is open, keep it rendered
const obs = new MutationObserver(()=>{
  if($("screenSetup").classList.contains("show")) renderSetup();
});
obs.observe(document.body, { attributes:true, subtree:true, attributeFilter:["class"] });

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }
</script>
</body>
</html>

