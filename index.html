<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#070712"/>
  <title>LiftLog AI</title>

  <style>
    :root{
      --bg:#05040b;
      --panel:#0c0b18;
      --card:#131126;
      --line:rgba(255,255,255,.10);
      --text:#f5f4ff;
      --muted:rgba(220,218,255,.70);
      --accent:#b772ff;    /* purple */
      --accent2:#5be6ff;   /* teal pop */
      --danger:#ff6b81;
      --warn:#ffbf5a;
      --shadow:0 18px 40px rgba(0,0,0,.5);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0;background:radial-gradient(circle at top,#15122a 0,#05040b 55%);
      color:var(--text);
      padding-top:env(safe-area-inset-top);
      padding-bottom:calc(72px + env(safe-area-inset-bottom));
    }
    .app{max-width:560px;margin:0 auto}
    .topbar{
      position:sticky;top:0;z-index:20;
      background:rgba(7,6,18,.9);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
    }
    .navrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-size:17px;font-weight:850;text-align:center;flex:1;letter-spacing:.04em}
    .pill{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;border-radius:999px;
      background:linear-gradient(120deg,rgba(183,114,255,.2),rgba(91,230,255,.12));
    }
    .content{padding:12px}
    .card{
      background:radial-gradient(circle at top left,rgba(183,114,255,.16),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(91,230,255,.12),transparent 60%),
                 linear-gradient(180deg,rgba(16,15,38,.96),rgba(7,7,18,.96));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
    }
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    button,input,select,textarea{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,9,24,.85);
      color:var(--text);
      border-radius:14px;padding:10px 12px;font-size:14px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(183,114,255,.8);
      box-shadow:0 0 0 2px rgba(183,114,255,.35);
      background:rgba(16,14,40,.95);
    }
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer;transition:.12s transform,.12s box-shadow}
    button:active{transform:scale(.985)}
    .btnAccent{
      background:linear-gradient(120deg,#b772ff,#5be6ff);
      border:none;color:#05040b;
      box-shadow:0 12px 30px rgba(92,230,255,.35);
    }
    .btnDanger{background:rgba(255,107,129,.14);border-color:rgba(255,107,129,.5);}
    .btnGhost{background:rgba(255,255,255,.06);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}
    .list{margin-top:12px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--line);background:rgba(6,5,18,.9);}
    .listHeader{padding:10px 12px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,.04);}
    .item:last-child{border-bottom:none}
    .name{font-weight:850}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
    .mini{padding:7px 9px;border-radius:12px;font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.09);margin:12px 0}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:rgba(255,255,255,.03)}
    .badge.good{border-color:rgba(91,230,255,.7);color:var(--accent2);background:rgba(91,230,255,.13);}
    .badge.hard{border-color:rgba(255,191,90,.7);color:var(--warn);background:rgba(255,191,90,.12);}
    .badge.tag{border-color:rgba(183,114,255,.7);color:rgba(222,206,255,.95);background:rgba(183,114,255,.14);}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:700;font-size:12px}
    .chk{width:22px;height:22px;border-radius:9px;border:1px solid var(--line);display:grid;place-items:center;font-size:13px}
    .chk.on{border-color:rgba(91,230,255,.8);background:rgba(91,230,255,.15);color:var(--accent2);font-weight:900}
    .tabs{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background:rgba(3,3,10,.96);
      backdrop-filter:blur(16px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:8px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{max-width:560px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;gap:10px}
    .tab{display:flex;flex-direction:column;align-items:center;gap:4px;color:rgba(220,218,255,.6);font-size:11px;cursor:pointer;user-select:none}
    .tab.active{color:var(--accent2)}
    .icon{
      width:26px;height:26px;border-radius:11px;border:1px solid rgba(255,255,255,.14);
      display:grid;place-items:center;font-weight:900;font-size:12px;
      background:radial-gradient(circle at top,rgba(183,114,255,.4),rgba(7,7,18,1));
    }
    .tab.active .icon{
      border-color:rgba(91,230,255,.9);
      box-shadow:0 0 0 2px rgba(91,230,255,.35) inset;
    }
    .screen{display:none}
    .screen.show{display:block}
    .fab{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:calc(18px + env(safe-area-inset-bottom) + 44px);
      width:62px;height:62px;border-radius:999px;
      background:radial-gradient(circle at top,#ffffff,#b772ff);
      box-shadow:0 18px 40px rgba(183,114,255,.55);
      border:none;color:#120f2a;font-size:34px;
      display:none;place-items:center;z-index:40;
    }
    .fab.show{display:grid}
    .calHead{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .calCell{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:8px;
      min-height:72px;
      background:rgba(12,10,32,.96);
      cursor:pointer;
      overflow:hidden;
      display:flex;flex-direction:column;gap:6px;
    }
    .calCell.off{opacity:.25;cursor:default}
    .calNum{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent2);display:inline-block}
    .dot.warn{background:var(--warn)}
    .dot.plan{background:rgba(183,114,255,.95)}
    .calTitle{
      font-size:11px;color:var(--text);opacity:.9;
      line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;
      -webkit-line-clamp:2;white-space:normal;word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }
    .weekStrip{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .wkDay{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:8px;min-height:54px;
      background:rgba(12,10,32,.96);
      display:flex;flex-direction:column;gap:6px;
      cursor:pointer;overflow:hidden;
    }
    .wkTop{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted)}
    .wkTitle{
      font-size:11px;opacity:.9;overflow:hidden;
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      line-height:1.2;white-space:normal;word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }
    .wkDay.today{border-color:rgba(91,230,255,.9);box-shadow:0 0 0 2px rgba(91,230,255,.45) inset;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:60;align-items:flex-end;justify-content:center;padding:14px;}
    .overlay.show{display:flex}
    .sheet{width:min(560px,100%);background:rgba(8,7,20,.98);border:1px solid rgba(255,255,255,.14);border-radius:22px;box-shadow:var(--shadow);padding:14px;}
    .sheet h3{margin:4px 2px 10px;font-size:16px}
    .toast{
      position:fixed;left:50%;bottom:calc(82px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:rgba(8,7,20,.97);
      border:1px solid rgba(91,230,255,.6);
      padding:10px 12px;border-radius:999px;font-size:12px;color:var(--text);
      opacity:0;pointer-events:none;transition:.18s;z-index:80
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">

  <div id="screenSetup" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Setup</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="tiny">
          Tell the app your split once. The AI will adjust reps and loads every session.
        </div>
        <div class="sep"></div>

        <div class="grid2">
          <div>
            <div class="tiny">Units</div>
            <select id="setUnits">
              <option value="lb">lbs</option>
              <option value="kg">kg</option>
            </select>
          </div>
          <div>
            <div class="tiny">Start week date (Monday)</div>
            <input id="setStartWeek" placeholder="YYYY-MM-DD"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">Your split</div>
            <div class="tiny" id="setupProgress">0 days • 0 exercises</div>
          </div>
          <button id="btnAddDay" class="btnAccent">+ Day</button>
        </div>

        <div id="daysBox" class="list" style="margin-top:10px">
          <div class="listHeader"><span>Days</span><span class="tiny">tap to manage</span></div>
          <div id="daysList"></div>
        </div>

        <div class="sep"></div>
        <button id="btnFinishSetup" class="btnAccent" style="width:100%">Save split</button>
        <div class="tiny" style="margin-top:10px">
          Tip: If Today shows Rest, you probably did not add a day for that weekday.
        </div>
      </div>
    </div>
  </div>

  <div id="screenToday" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Today</div>
        <button id="btnEditSplitToday" class="btnGhost" style="width:80px">Split</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="todayTitle">—</div>
            <div class="tiny" id="todaySub">—</div>
          </div>
          <span class="pill" id="todayDatePill">—</span>
        </div>

        <div class="sep"></div>
        <div id="todayBox" class="tiny muted">—</div>

        <div class="sep"></div>
        <div class="row" style="gap:10px">
          <button id="btnStartWorkout" class="btnAccent" style="flex:1">Start workout</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">This week</div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="tiny">Planned: <b id="stPlanned">0</b></div>
          <div class="tiny">Completed: <b id="stDone">0</b></div>
          <div class="tiny">Streak: <b id="stStreak">0</b></div>
          <div class="tiny">Total: <b id="stTotal">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <div id="screenLogger" class="screen">
    <div class="topbar">
      <div class="navrow">
        <button id="btnBackToday" class="btnGhost" style="width:80px">Back</button>
        <div class="title" id="loggerTitle">Log</div>
        <button id="btnFinishWorkout" class="btnAccent" style="width:110px">Finish</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="loggerName">—</div>
            <div class="tiny" id="loggerMeta">—</div>
          </div>
          <span class="pill" id="loggerDate">—</span>
        </div>
        <div class="sep"></div>
        <div class="tiny">AI will bump or deload weights based on how you hit the target reps.</div>
      </div>

      <div id="loggerExercises"></div>
    </div>
    <button class="fab" id="fabAddExerciseToSession">+</button>
  </div>

  <div id="screenCalendar" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Calendar</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="calHead">
          <button id="calPrev" class="btnGhost">‹</button>
          <div class="name" id="calMonth">—</div>
          <button id="calNext" class="btnGhost">›</button>
        </div>

        <div class="sep"></div>

        <div class="tiny muted">This week</div>
        <div class="weekStrip" id="weekStrip"></div>

        <div class="sep"></div>

        <div class="calGrid tiny muted" style="margin-top:0">
          <div style="text-align:center">S</div><div style="text-align:center">M</div><div style="text-align:center">T</div>
          <div style="text-align:center">W</div><div style="text-align:center">T</div><div style="text-align:center">F</div><div style="text-align:center">S</div>
        </div>
        <div class="calGrid" id="calGrid"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Selected day</div>
        <div class="sep"></div>
        <div id="calDetail" class="tiny muted">Tap a day.</div>
      </div>
    </div>
  </div>

  <div id="screenProgress" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Progress</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">Strength change</div>
            <div class="tiny muted">Estimated 1RM + best sets.</div>
          </div>
          <div class="right">
            <select id="progWindow">
              <option value="7">Week</option>
              <option value="30" selected>Month</option>
              <option value="365">Year</option>
            </select>
          </div>
        </div>
        <div class="sep"></div>
        <div id="progSummary" class="tiny muted">—</div>
      </div>

      <div class="list">
        <div class="listHeader"><span>Exercises</span><span class="tiny">last 3 + change</span></div>
        <div id="progList"></div>
      </div>
    </div>
  </div>

  <div id="screenPRs" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">PRs</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">PRs</div>
            <div class="tiny muted">Uses PR tags (Bench/Squat/etc.).</div>
          </div>
        </div>
        <div class="sep"></div>
        <div id="prSummary" class="tiny muted">—</div>
      </div>

      <div id="prCards" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px"></div>

      <div class="card" style="margin-top:12px">
        <div class="name">PR history</div>
        <div class="sep"></div>
        <div id="prHistory" class="tiny muted">—</div>
      </div>
    </div>
  </div>

</div>

<div class="tabs">
  <div class="tabsInner">
    <div class="tab" id="tabToday"><div class="icon">H</div><div>Home</div></div>
    <div class="tab" id="tabLogger"><div class="icon">L</div><div>Log</div></div>
    <div class="tab" id="tabCalendar"><div class="icon">C</div><div>Cal</div></div>
    <div class="tab" id="tabProgress"><div class="icon">P</div><div>Prog</div></div>
    <div class="tab" id="tabPRs"><div class="icon">R</div><div>PR</div></div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <h3 id="sheetTitle">—</h3>
    <div id="sheetBody"></div>
    <div class="row" style="margin-top:12px">
      <button id="sheetOk" class="btnAccent" style="flex:1">OK</button>
      <button id="sheetCancel" class="btnDanger" style="flex:1">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* ===== Constants ===== */
const WEEKDAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const PR_TAGS = [
  {v:"none",t:"None"}, {v:"squat",t:"Squat"}, {v:"bench",t:"Bench"},
  {v:"dead",t:"Deadlift"}, {v:"ohp",t:"Overhead"}, {v:"row",t:"Row"},
  {v:"pullup",t:"Pullup"}, {v:"dip",t:"Dip"}
];
const KEY="liftlog_ai_v1";
const AUTO_BACKUP_KEY="liftlog_ai_autobackup";
const $=id=>document.getElementById(id);

/* ===== Storage + helpers ===== */
function toast(msg="Saved"){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  if(navigator.vibrate) navigator.vibrate(10);
  setTimeout(()=>t.classList.remove("show"),900);
}
function isoToday(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function defaultMonday(){
  // Returns last Monday
  const d=new Date();
  const day=d.getDay();
  const diff=d.getDate()-day+(day===0?-6:1);
  const m=new Date(d.setDate(diff));
  return m.toISOString().split("T")[0];
}
function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
function num(x,fb=0){ const n=Number(x); return Number.isFinite(n)?n:fb; }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){ return escapeHtml(s); }

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) throw 0;
    const s=JSON.parse(raw);
    s.program ||= null;
    s.sessions ||= [];
    s.exerciseState ||= {};
    s.prs ||= {};
    s.ui ||= {activeTab:"today"};
    s.meta ||= {lastBackupAt:null};
    return s;
  }catch{
    return {program:null,sessions:[],exerciseState:{},prs:{},ui:{activeTab:"today"},meta:{lastBackupAt:null}};
  }
}
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

function maybeAutoBackup(){
  const now=Date.now();
  const last=state.meta?.lastBackupAt ? Number(state.meta.lastBackupAt) : 0;
  const weekMs=7*24*60*60*1000;
  if(!last || (now-last)>weekMs){
    try{
      localStorage.setItem(AUTO_BACKUP_KEY,JSON.stringify({at:now,state}));
      state.meta ||= {};
      state.meta.lastBackupAt=now;
      save();
    }catch{}
  }
}

let state=load();
maybeAutoBackup();

/* ===== lightweight DOM cache ===== */
const EL = {
  overlay: $("overlay"),
  sheetBody: $("sheetBody"),
  sheetTitle: $("sheetTitle"),
  sheetOk: $("sheetOk"),
  sheetCancel: $("sheetCancel"),
  toast: $("toast"),
  daysList: $("daysList"),
  loggerExercises: $("loggerExercises")
};

/* ===== UI routing ===== */
function tabEl(id,active){
  const el=$(id); if(!el) return;
  el.classList.toggle("active",active);
}
function showScreen(id){
  ["screenSetup","screenToday","screenLogger","screenCalendar","screenProgress","screenPRs"].forEach(s=>{
    const el=$(s); if(!el) return;
    el.classList.toggle("show",s===id);
  });
}
function setActiveTab(tab){
  state.ui.activeTab=tab;
  save();
  render();
}

/* ===== Modal helpers ===== */
let modal={onOk:null,onCancel:null};
function openModal(title,bodyHtml,okText="OK",cancelText="Cancel",onOk=null,onCancel=null){
  $("sheetTitle").textContent=title;
  $("sheetBody").innerHTML=bodyHtml;
  $("sheetOk").textContent=okText;
  $("sheetCancel").textContent=cancelText;
  modal.onOk=onOk;
  modal.onCancel=onCancel;
  EL.overlay.classList.add("show");
}
function closeModal(){
  EL.overlay.classList.remove("show");
  modal.onOk=null; modal.onCancel=null;
}
EL.overlay.addEventListener("click",e=>{ if(e.target===EL.overlay) closeModal(); });
EL.sheetOk.addEventListener("click",()=>{ if(modal.onOk) modal.onOk(); else closeModal(); });
EL.sheetCancel.addEventListener("click",()=>{ if(modal.onCancel) modal.onCancel(); closeModal(); });

/* ===== Setup screen ===== */
function normalizeProgram(){
  const p=state.program || {units:"lb",startWeekDate:defaultMonday(),split:[],exercises:{},settings:{jump:5,microload:false,repsFirstBW:false}};
  p.split ||= [];
  p.exercises ||= {};
  p.settings ||= {jump:5,microload:false,repsFirstBW:false};
  p.settings.jump ??= 5;
  p.settings.microload ??= false;
  p.settings.repsFirstBW ??= false;
  return p;
}
function countSetupProgress(p){
  const days=(p.split||[]).length;
  let exTotal=0;
  for(const d of (p.split||[])) exTotal+=(d.exercises||[]).length;
  return {days,exTotal};
}
function ensureExerciseState(exId,startW){
  if(!state.exerciseState[exId]){
    state.exerciseState[exId]={nextWeight:startW,history:[]};
  }
}
function renderSetup(){
  const p=normalizeProgram();
  $("setUnits").value=p.units || "lb";
  $("setStartWeek").value=p.startWeekDate || defaultMonday();
  const {days,exTotal}=countSetupProgress(p);
  $("setupProgress").textContent=`${days} day(s) • ${exTotal} exercise(s)`;

  const list=$("daysList");
  list.innerHTML="";
  if(!p.split.length){
    list.innerHTML=`<div class="item"><div class="tiny muted">No days yet. Tap “+ Day”.</div></div>`;
  }else{
    p.split.forEach(day=>{
      const exCount=(day.exercises||[]).length;
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div>
          <div class="name">${escapeHtml(WEEKDAYS[day.weekday])} — ${escapeHtml(day.title)}</div>
          <div class="tiny muted">${exCount} exercise(s)</div>
        </div>
        <div class="right">
          <button class="mini btnGhost" data-act="editDay" data-id="${day.id}">Edit</button>
          <button class="mini btnAccent" data-act="addEx" data-id="${day.id}">+ Ex</button>
          <button class="mini btnDanger" data-act="delDay" data-id="${day.id}">Del</button>
        </div>`;
      list.appendChild(div);

      const exDiv=document.createElement("div");
      exDiv.style.padding="0 12px 10px";
      exDiv.innerHTML=(day.exercises||[]).map(exId=>{
        const ex=p.exercises[exId];
        if(!ex) return "";
        const tgt=ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const rule=ex.rule?.type || "double";
        const ruleTxt=rule==="double" ? `Range + load` :
                      rule==="fixed"  ? `Weekly +${ex.rule.inc||5}` :
                                        `+${ex.rule.pct||2.5}%`;
        const tag=ex.prTag && ex.prTag!=="none" ? PR_TAGS.find(x=>x.v===ex.prTag)?.t : "";
        const tagBadge=tag ? `<span class="badge tag">${escapeHtml(tag)}</span>` : "";
        return `
          <div class="item" style="border-radius:14px;margin-top:8px;background:rgba(9,7,26,.95);border:1px solid rgba(255,255,255,.10)">
            <div>
              <div class="name">${escapeHtml(ex.name)} ${tagBadge}</div>
              <div class="tiny muted">${ex.sets} sets • ${tgt} reps • start ${ex.startWeight}${p.units} • ${ruleTxt}</div>
            </div>
            <div class="right">
              <button class="mini btnGhost" data-act="editEx" data-ex="${exId}">Edit</button>
              <button class="mini btnDanger" data-act="delEx" data-day="${day.id}" data-ex="${exId}">Remove</button>
            </div>
          </div>`;
      }).join("");
      list.appendChild(exDiv);
    });
  }
}

/* Event listeners delegate */
$("daysBox").addEventListener("click",e=>{
  const b=e.target.closest("button");
  if(!b) return;
  const act=b.dataset.act;
  const id=b.dataset.id;
  const exId=b.dataset.ex;
  const dayId=b.dataset.day;
  if(act==="delDay") deleteDay(id);
  if(act==="editDay") editDay(id);
  if(act==="addEx") addExerciseToDay(id);
  if(act==="editEx") editExercise(exId);
  if(act==="delEx") removeExerciseFromDay(dayId,exId);
});

function deleteDay(dayId){
  const p=normalizeProgram();
  p.split=p.split.filter(d=>d.id!==dayId);
  state.program=p;
  save(); render(); toast("Day deleted");
}
function editDay(dayId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  openModal("Edit day",
    `
    <div class="grid2">
      <div>
        <div class="tiny">Weekday</div>
        <select id="edDayWeekday">
          ${WEEKDAYS.map((d,i)=>`<option value="${i}" ${i===day.weekday?"selected":""}>${d}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="tiny">Title</div>
        <input id="edDayTitle" value="${escapeAttr(day.title||"Workout")}"/>
      </div>
    </div>
    `,
    "Save","Cancel",
    ()=>{
      day.weekday=num(document.getElementById("edDayWeekday").value,day.weekday);
      day.title=(document.getElementById("edDayTitle").value||day.title).trim() || "Workout";
      state.program=p;
      save(); closeModal(); render(); toast("Day updated");
    },
    ()=>{}
  );
}
function addDay(){
  const p=normalizeProgram();
  openModal("Add day",
    `
    <div class="grid2">
      <div>
        <div class="tiny">Weekday</div>
        <select id="mWeekday">
          ${WEEKDAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="tiny">Title</div>
        <input id="mTitle" placeholder="Push / Pull / Legs..."/>
      </div>
    </div>
    `,
    "Add","Cancel",
    ()=>{
      const wd=num(document.getElementById("mWeekday").value,1);
      const title=(document.getElementById("mTitle").value||"Workout").trim();
      p.split.push({id:uid(),weekday:wd,title,exercises:[]});
      state.program=p;
      save(); closeModal(); render(); toast("Day added");
    },
    ()=>{}
  );
}
function addExerciseToDay(dayId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  openModal("Add exercise",
    `
    <div class="grid2">
      <div class="tiny" style="grid-column:1/-1">Name</div>
      <input id="exName" placeholder="Bench Press / Squat / Pull-Ups"/>

      <div>
        <div class="tiny">Sets</div>
        <input id="exSets" inputmode="numeric" value="4"/>
      </div>

      <div>
        <div class="tiny">Start weight (${p.units})</div>
        <input id="exW" inputmode="decimal" value="0"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">PR tag (optional)</div>
      <select id="exPRTag">
        ${PR_TAGS.map(x=>`<option value="${x.v}">${escapeHtml(x.t)}</option>`).join("")}
      </select>

      <div class="tiny" style="grid-column:1/-1">Target</div>
      <select id="exTargetType">
        <option value="range">Rep range</option>
        <option value="fixed">Fixed reps</option>
      </select>

      <div id="rangeBox" class="grid2" style="grid-column:1/-1">
        <div>
          <div class="tiny">Min</div>
          <input id="exMin" inputmode="numeric" value="6"/>
        </div>
        <div>
          <div class="tiny">Max</div>
          <input id="exMax" inputmode="numeric" value="8"/>
        </div>
      </div>

      <div id="fixedBox" style="grid-column:1/-1;display:none">
        <div class="tiny">Reps</div>
        <input id="exFixed" inputmode="numeric" value="3"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">Progression rule</div>
      <select id="exRuleType">
        <option value="double">AI range + load</option>
        <option value="fixed">Fixed weekly increase</option>
        <option value="percent">Percent increase</option>
      </select>

      <div id="incBox" class="grid2" style="grid-column:1/-1">
        <div>
          <div class="tiny">Increase (${p.units})</div>
          <input id="exInc" inputmode="decimal" value="5"/>
        </div>
        <div>
          <div class="tiny">Deload after 2 misses</div>
          <select id="exDeload">
            <option value="yes">Yes (-10%)</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div id="pctBox" class="grid2" style="grid-column:1/-1;display:none">
        <div>
          <div class="tiny">Percent (%)</div>
          <input id="exPct" inputmode="decimal" value="2.5"/>
        </div>
        <div></div>
      </div>
    </div>
    `,
    "Add","Cancel",
    ()=>{
      const name=(document.getElementById("exName").value||"").trim();
      if(!name){ alert("Enter exercise name."); return; }
      const sets=clamp(num(document.getElementById("exSets").value,4),1,20);
      const startW=num(document.getElementById("exW").value,0);
      const prTag=document.getElementById("exPRTag").value || "none";

      const ttype=document.getElementById("exTargetType").value;
      let target;
      if(ttype==="range"){
        const min=clamp(num(document.getElementById("exMin").value,6),1,200);
        let max=clamp(num(document.getElementById("exMax").value,8),1,200);
        if(max<min) max=min;
        target={type:"range",min,max};
      }else{
        target={type:"fixed",reps:clamp(num(document.getElementById("exFixed").value,3),1,200)};
      }

      const rtype=document.getElementById("exRuleType").value;
      const deload=(document.getElementById("exDeload")?.value || "yes")==="yes";
      let rule;
      if(rtype==="percent"){
        rule={type:"percent",pct:num(document.getElementById("exPct").value,2.5),deloadOnMiss2:deload};
      }else{
        rule={type:rtype,inc:num(document.getElementById("exInc").value,5),deloadOnMiss2:deload};
      }

      const exId="ex_"+uid();
      p.exercises[exId]={name,sets,target,startWeight:startW,rule,prTag};
      day.exercises.push(exId);
      state.program=p;
      ensureExerciseState(exId,startW);
      save(); closeModal(); render(); toast("Exercise added");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel=document.getElementById("exTargetType");
    const rsel=document.getElementById("exRuleType");
    const rangeBox=document.getElementById("rangeBox");
    const fixedBox=document.getElementById("fixedBox");
    const incBox=document.getElementById("incBox");
    const pctBox=document.getElementById("pctBox");
    tsel.addEventListener("change",()=>{
      const v=tsel.value;
      rangeBox.style.display=v==="range"?"grid":"none";
      fixedBox.style.display=v==="fixed"?"block":"none";
    });
    rsel.addEventListener("change",()=>{
      const v=rsel.value;
      incBox.style.display=(v==="percent")?"none":"grid";
      pctBox.style.display=(v==="percent")?"grid":"none";
    });
  },0);
}
function removeExerciseFromDay(dayId,exId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  day.exercises=(day.exercises||[]).filter(x=>x!==exId);
  state.program=p;
  save(); render(); toast("Removed");
}
function editExercise(exId){
  const p=normalizeProgram();
  const ex=p.exercises[exId];
  if(!ex) return;

  const isRange = ex.target.type==="range";
  const isFixed = ex.target.type==="fixed";
  const isPercent = ex.rule.type==="percent";

  openModal("Edit exercise",
    `
    <div class="grid2">
      <div class="tiny" style="grid-column:1/-1">Name</div>
      <input id="edExName" value="${escapeAttr(ex.name)}"/>

      <div>
        <div class="tiny">Sets</div>
        <input id="edExSets" inputmode="numeric" value="${ex.sets}"/>
      </div>
      
      <div>
        <div class="tiny">PR Tag</div>
        <select id="edExPR">
           ${PR_TAGS.map(x=>`<option value="${x.v}" ${x.v===ex.prTag?"selected":""}>${escapeHtml(x.t)}</option>`).join("")}
        </select>
      </div>

      <div class="tiny" style="grid-column:1/-1">Target</div>
      <select id="edExTargetType">
        <option value="range" ${isRange?"selected":""}>Rep range</option>
        <option value="fixed" ${isFixed?"selected":""}>Fixed reps</option>
      </select>

      <div id="edRangeBox" class="grid2" style="grid-column:1/-1;display:${isRange?"grid":"none"}">
        <div>
          <div class="tiny">Min</div>
          <input id="edExMin" inputmode="numeric" value="${isRange?ex.target.min:6}"/>
        </div>
        <div>
          <div class="tiny">Max</div>
          <input id="edExMax" inputmode="numeric" value="${isRange?ex.target.max:8}"/>
        </div>
      </div>

      <div id="edFixedBox" style="grid-column:1/-1;display:${isFixed?"block":"none"}">
        <div class="tiny">Reps</div>
        <input id="edExFixed" inputmode="numeric" value="${isFixed?ex.target.reps:5}"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">Rule</div>
      <select id="edExRuleType">
        <option value="double" ${ex.rule.type==="double"?"selected":""}>AI range + load</option>
        <option value="fixed" ${ex.rule.type==="fixed"?"selected":""}>Fixed weekly increase</option>
        <option value="percent" ${isPercent?"selected":""}>Percent increase</option>
      </select>

      <div id="edIncBox" class="grid2" style="grid-column:1/-1;display:${isPercent?"none":"grid"}">
        <div>
           <div class="tiny">Increase</div>
           <input id="edExInc" inputmode="decimal" value="${ex.rule.inc||5}"/>
        </div>
        <div></div>
      </div>
    </div>
    `,
    "Save","Cancel",
    ()=>{
      ex.name = (document.getElementById("edExName").value||"").trim();
      ex.sets = clamp(num(document.getElementById("edExSets").value,4),1,20);
      ex.prTag = document.getElementById("edExPR").value;
      
      const ttype = document.getElementById("edExTargetType").value;
      if(ttype==="range"){
        ex.target={type:"range",min:num(document.getElementById("edExMin").value,6),max:num(document.getElementById("edExMax").value,8)};
      } else {
        ex.target={type:"fixed",reps:num(document.getElementById("edExFixed").value,5)};
      }

      const rtype = document.getElementById("edExRuleType").value;
      if(rtype==="percent"){
         ex.rule={type:"percent",pct:2.5,deloadOnMiss2:true}; // Simplified update
      } else {
         ex.rule={type:rtype,inc:num(document.getElementById("edExInc").value,5),deloadOnMiss2:true};
      }
      state.program=p;
      save(); closeModal(); render(); toast("Updated");
    },
    ()=>{}
  );
  
  setTimeout(()=>{
    const tsel=$("edExTargetType"); const rb=$("edRangeBox"); const fb=$("edFixedBox");
    tsel.addEventListener("change",()=>{ rb.style.display=tsel.value==="range"?"grid":"none"; fb.style.display=tsel.value==="fixed"?"block":"none"; });
    const rsel=$("edExRuleType"); const ib=$("edIncBox");
    rsel.addEventListener("change",()=>{ ib.style.display=rsel.value==="percent"?"none":"grid"; });
  },0);
}

/* ===== Today / Dashboard ===== */
function renderToday(){
  const p=normalizeProgram();
  const d=new Date();
  const todayIso=isoToday();
  const wd=d.getDay();
  
  $("todayDatePill").textContent=prettyDate(todayIso);
  
  // Find if today is a workout day
  const day=p.split.find(x=>x.weekday===wd);
  const titleEl=$("todayTitle");
  const subEl=$("todaySub");
  const box=$("todayBox");
  const btn=$("btnStartWorkout");

  if(!day){
    titleEl.textContent="Rest Day";
    subEl.textContent="Recover & grow.";
    box.textContent="No workout scheduled for "+WEEKDAYS[wd];
    btn.textContent="Rest";
    btn.disabled=true;
    btn.style.opacity="0.5";
  } else {
    titleEl.textContent=day.title;
    subEl.textContent=`${(day.exercises||[]).length} exercises`;
    btn.textContent="Start Workout";
    btn.disabled=false;
    btn.style.opacity="1";
    
    // Preview exercises
    const list=(day.exercises||[]).map(eid=>{
      const ex=p.exercises[eid];
      const wStr = (state.exerciseState[eid]?.nextWeight) ? ` @ ${state.exerciseState[eid].nextWeight}` : "";
      return ex ? `• ${ex.name}${wStr}` : "";
    }).join("<br>");
    box.innerHTML=list || "Empty workout";
  }

  // Stats
  // Simple check of this week (last 7 days logic roughly)
  const doneCount = state.sessions.filter(s=>s.date.startsWith(todayIso.slice(0,7))).length; 
  $("stDone").textContent=doneCount;
  $("stTotal").textContent=state.sessions.length;
}

$("btnStartWorkout").addEventListener("click",()=>{
  const p=normalizeProgram();
  const d=new Date();
  const wd=d.getDay();
  const day=p.split.find(x=>x.weekday===wd);
  if(!day) return;
  startSession(day);
});

/* ===== Logger ===== */
let activeSession = null;

function startSession(dayCfg){
  activeSession = {
    id: uid(),
    date: isoToday(),
    dayId: dayCfg.id,
    dayTitle: dayCfg.title,
    startTime: Date.now(),
    exercises: [] // {exId, sets:[ {reps,weight,done} ]}
  };
  
  // Pre-populate based on program
  const p=normalizeProgram();
  (dayCfg.exercises||[]).forEach(exId=>{
    const def=p.exercises[exId];
    if(!def) return;
    const st=state.exerciseState[exId] || {nextWeight:def.startWeight};
    const setArr=[];
    for(let i=0;i<def.sets;i++){
      setArr.push({reps: (def.target.type==="fixed"?def.target.reps : def.target.max), weight: st.nextWeight, done:false});
    }
    activeSession.exercises.push({
      exId: exId,
      name: def.name,
      sets: setArr
    });
  });
  
  setActiveTab("logger");
}

function renderLogger(){
  if(!activeSession){
     $("loggerTitle").textContent="No Active";
     $("loggerExercises").innerHTML="<div class='card tiny muted'>No active workout. Go to Home to start one.</div>";
     return;
  }
  $("loggerName").textContent=activeSession.dayTitle;
  $("loggerDate").textContent=activeSession.date;
  $("loggerMeta").textContent=`${activeSession.exercises.length} Exercises`;

  const container=$("loggerExercises");
  container.innerHTML="";
  
  activeSession.exercises.forEach((exItem, exIdx)=>{
     const div=document.createElement("div");
     div.className="card";
     div.style.marginTop="10px";
     
     // Build rows
     let rowsHtml="";
     exItem.sets.forEach((set, sIdx)=>{
       rowsHtml += `
         <div class="row" style="margin-top:8px">
           <div class="tiny" style="width:20px">${sIdx+1}</div>
           <input type="number" class="l-reps" data-ex="${exIdx}" data-s="${sIdx}" value="${set.reps}" style="width:60px">
           <div class="tiny">x</div>
           <input type="number" class="l-w" data-ex="${exIdx}" data-s="${sIdx}" value="${set.weight}" style="width:70px">
           <div class="chk ${set.done?'on':''}" data-act="tog" data-ex="${exIdx}" data-s="${sIdx}">✓</div>
         </div>
       `;
     });

     div.innerHTML = `
       <div class="name">${escapeHtml(exItem.name)}</div>
       <div class="sep"></div>
       ${rowsHtml}
     `;
     container.appendChild(div);
  });
}

// Logger interactions
$("loggerExercises").addEventListener("click",e=>{
  const t=e.target;
  if(t.dataset.act==="tog"){
     const exIdx=t.dataset.ex;
     const sIdx=t.dataset.s;
     const set=activeSession.exercises[exIdx].sets[sIdx];
     set.done=!set.done;
     renderLogger();
  }
});
$("loggerExercises").addEventListener("change",e=>{
  if(e.target.tagName==="INPUT"){
    const exIdx=e.target.dataset.ex;
    const sIdx=e.target.dataset.s;
    const val=Number(e.target.value);
    const set=activeSession.exercises[exIdx].sets[sIdx];
    if(e.target.classList.contains("l-reps")) set.reps=val;
    if(e.target.classList.contains("l-w")) set.weight=val;
  }
});

$("btnFinishWorkout").addEventListener("click",()=>{
  if(!activeSession) return;
  if(!confirm("Finish workout?")) return;
  finishSession();
});
$("btnBackToday").addEventListener("click",()=>{
   setActiveTab("today");
});

function finishSession(){
  const p=normalizeProgram();
  
  // 1. Update Progression Logic (The "AI")
  activeSession.exercises.forEach(logEx=>{
    const def = p.exercises[logEx.exId];
    if(!def) return;
    
    // Check if all planned sets were done at target
    const allDone = logEx.sets.every(s=>s.done);
    if(!allDone) return; // Dont bump if skipped
    
    // Calc logic
    const stateEx = state.exerciseState[logEx.exId];
    let nextW = stateEx.nextWeight;
    
    // Check performance
    // Simple double progression: If all sets >= max reps (or fixed reps), increase weight
    let passed=true;
    logEx.sets.forEach(s=>{
       const targetReps = (def.target.type==="fixed") ? def.target.reps : def.target.max;
       if(s.reps < targetReps) passed=false;
    });

    if(passed){
       // Increase
       const inc = (def.rule.type==="percent") ? (nextW * (def.rule.pct/100)) : (def.rule.inc || 5);
       nextW += inc;
       // Round to nearest 2.5 or 5? Let's just keep decimal clean
       nextW = Math.round(nextW*100)/100;
       toast(`Bumped ${def.name} to ${nextW}`);
    } else {
       // Missed? logic could go here (deload)
    }
    
    // Update state
    state.exerciseState[logEx.exId].nextWeight = nextW;
    
    // PR Check
    if(def.prTag && def.prTag!=="none"){
       const maxLoad = Math.max(...logEx.sets.map(s=>s.weight));
       const curPR = state.prs[def.prTag] || 0;
       if(maxLoad > curPR){
          state.prs[def.prTag] = maxLoad;
          toast(`New PR: ${def.prTag.toUpperCase()} ${maxLoad}!`);
       }
    }
  });

  // 2. Save Session
  activeSession.endTime = Date.now();
  state.sessions.unshift(activeSession);
  if(state.sessions.length>100) state.sessions.pop(); // keep last 100
  
  save();
  activeSession=null;
  setActiveTab("today");
}

/* ===== Calendar ===== */
let calDate = new Date(); // tracking view

function renderCalendar(){
  const y=calDate.getFullYear();
  const m=calDate.getMonth();
  $("calMonth").textContent = new Date(y,m,1).toLocaleString('default',{month:'long', year:'numeric'});
  
  const firstDay = new Date(y,m,1).getDay();
  const daysInMonth = new Date(y,m+1,0).getDate();
  
  const grid=$("calGrid");
  grid.innerHTML="";
  
  // Empty slots
  for(let i=0;i<firstDay;i++){
    grid.innerHTML+=`<div class="calCell off"></div>`;
  }
  
  // Days
  for(let d=1; d<=daysInMonth; d++){
    const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const sess = state.sessions.filter(s=>s.date===iso);
    
    let dots = sess.map(s=>`<div class="dot plan"></div>`).join("");
    
    const div=document.createElement("div");
    div.className="calCell";
    div.innerHTML=`<div class="calNum"><span>${d}</span></div><div style="display:flex;gap:2px;flex-wrap:wrap">${dots}</div>`;
    div.onclick=()=>showCalDay(iso, sess);
    grid.appendChild(div);
  }
}

$("calPrev").onclick=()=>{ calDate.setMonth(calDate.getMonth()-1); renderCalendar(); };
$("calNext").onclick=()=>{ calDate.setMonth(calDate.getMonth()+1); renderCalendar(); };

function showCalDay(iso, sessions){
  const el=$("calDetail");
  if(sessions.length===0){
     el.textContent=`No workout recorded on ${iso}.`;
     return;
  }
  el.innerHTML = sessions.map(s=>`
    <div style="margin-bottom:8px">
      <div class="name">${escapeHtml(s.dayTitle)}</div>
      <div class="tiny muted">${s.exercises.length} Exercises</div>
    </div>
  `).join("");
}

/* ===== Progress / PRs ===== */
function renderProgress(){
  // Just show recent sessions in list
  const list=$("progList");
  list.innerHTML="";
  state.sessions.slice(0,10).forEach(s=>{
     const div=document.createElement("div");
     div.className="item";
     div.innerHTML=`
       <div>
         <div class="name">${escapeHtml(s.dayTitle)}</div>
         <div class="tiny muted">${s.date}</div>
       </div>
       <div class="badge good">Done</div>
     `;
     list.appendChild(div);
  });
}

function renderPRs(){
   const c=$("prCards");
   c.innerHTML="";
   Object.entries(state.prs).forEach(([k,v])=>{
      c.innerHTML+=`
        <div class="card" style="text-align:center">
          <div class="tiny muted">${k.toUpperCase()}</div>
          <div class="name" style="font-size:20px;color:var(--accent2)">${v}</div>
        </div>
      `;
   });
}

/* ===== Main render ===== */
function render(){
  const tab=state.ui.activeTab || "today";
  
  // Tabs UI
  ["today","logger","calendar","progress","prs"].forEach(t=>{
    const el=$("tab"+t.charAt(0).toUpperCase()+t.slice(1));
    if(el) el.classList.toggle("active", tab===t);
  });

  // Screens
  if(tab==="today"){
    // If setup not done, force setup
    if(!state.program || state.program.split.length===0){
      showScreen("screenSetup");
      renderSetup();
    } else {
      showScreen("screenToday");
      renderToday();
    }
  } else if(tab==="logger"){
    showScreen("screenLogger");
    renderLogger();
  } else if(tab==="calendar"){
    showScreen("screenCalendar");
    renderCalendar();
  } else if(tab==="progress"){
    showScreen("screenProgress");
    renderProgress();
  } else if(tab==="prs"){
    showScreen("screenPRs");
    renderPRs();
  }
}

/* ===== Init ===== */
$("btnFinishSetup").onclick=()=>{
  if(normalizeProgram().split.length===0){ alert("Add at least one day."); return; }
  setActiveTab("today");
};
$("btnEditSplitToday").onclick=()=>{
  showScreen("screenSetup");
  renderSetup();
};

// Bottom tabs
$("tabToday").onclick=()=>setActiveTab("today");
$("tabLogger").onclick=()=>setActiveTab("logger");
$("tabCalendar").onclick=()=>setActiveTab("calendar");
$("tabProgress").onclick=()=>setActiveTab("progress");
$("tabPRs").onclick=()=>setActiveTab("prs");

render();
</script>
</body>
</html>
