<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gemini Strength Pro v3</title>
  <style>
    :root {
      --bg: #09090b;
      --card: #18181b;
      --border: #27272a;
      --accent: #3b82f6; 
      --success: #22c55e;
      --danger: #ef4444;
      --text: #fafafa;
      --muted: #a1a1aa;
      --gold: #fbbf24;
      --nav-bg: rgba(9, 9, 11, 0.95);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; padding-bottom: 100px; line-height: 1.5;
    }

    /* Layout Components */
    .container { max-width: 600px; margin: 0 auto; padding: 16px; }
    .screen { display: none; animation: slideUp 0.3s ease-out; }
    .screen.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; padding: 20px; margin-bottom: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .plateau-warning { border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.05); }
    .pr-glow { border: 1px solid var(--gold); background: rgba(251, 191, 36, 0.05); }

    /* Typography */
    h1, h2, h3 { margin: 0 0 10px 0; letter-spacing: -0.02em; }
    .tiny { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .muted { color: var(--muted); }
    .success { color: var(--success); }
    .danger { color: var(--danger); }

    /* Form Elements */
    input, select, textarea {
      width: 100%; background: #000; border: 1px solid var(--border);
      color: #fff; padding: 12px; border-radius: 12px; font-size: 1rem;
      margin-bottom: 12px; transition: border-color 0.2s;
    }
    input:focus { border-color: var(--accent); outline: none; }

    /* Buttons */
    button {
      cursor: pointer; border-radius: 14px; font-weight: 700; border: none;
      padding: 14px 20px; font-size: 1rem; transition: transform 0.1s, opacity 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    button:active { transform: scale(0.97); opacity: 0.8; }
    .btn-main { background: var(--accent); color: white; width: 100%; }
    .btn-sub { background: var(--card); border: 1px solid var(--border); color: var(--text); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    /* Bottom Nav */
    .nav {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg);
      backdrop-filter: blur(15px); border-top: 1px solid var(--border);
      display: flex; height: 85px; padding-bottom: 20px; z-index: 1000;
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; color: var(--muted); font-size: 0.7rem; gap: 4px;
    }
    .nav-btn.active { color: var(--accent); }
    .nav-icon { font-size: 1.4rem; }

    /* Logger Specifics */
    .log-table { width: 100%; border-spacing: 0 8px; }
    .log-table th { text-align: left; padding: 0 8px; }
    .log-table td { padding: 4px; }
    .check-btn {
      width: 40px; height: 40px; border-radius: 10px; background: var(--border);
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .check-btn.done { background: var(--success); color: #000; }

    /* Timer Overlay */
    #timerOverlay {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: white; padding: 10px 24px;
      border-radius: 30px; font-weight: bold; z-index: 2000; display: none;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }

    /* Progress Visuals */
    .progress-track { height: 6px; background: var(--border); border-radius: 3px; margin: 10px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>
<body>

  <div id="timerOverlay">Rest: <span id="timerVal">60</span>s</div>

  <div class="container">
    
    <section id="today" class="screen active">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1>Dashboard</h1>
        <button class="btn-sub" onclick="app.nav('settings')" style="padding: 8px 12px;">‚öôÔ∏è</button>
      </header>
      <div id="plateauSection"></div>
      <div id="workoutSummary"></div>
      <button id="startBtn" class="btn-main" onclick="app.startWorkout()" style="display:none; margin-top: 20px;">Start Workout</button>
    </section>

    <section id="logger" class="screen">
      <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="logTitle">Push Day</h2>
        <button class="btn-danger" onclick="app.cancelWorkout()" style="padding: 8px;">Cancel</button>
      </header>
      <div id="logExercises"></div>
      <button class="btn-main" onclick="app.finishWorkout()" style="margin-top: 30px;">Finish Workout</button>
    </section>

    <section id="stats" class="screen">
      <h1>Progress</h1>
      <div id="statsList"></div>
    </section>

    <section id="prs" class="screen">
      <h1>Wall of Fame üèÜ</h1>
      <div id="prList"></div>
    </section>

    <section id="settings" class="screen">
      <h1>Settings</h1>
      <div class="card">
        <h3>Program Split</h3>
        <div id="splitList"></div>
        <button class="btn-sub" onclick="app.addDay()" style="width: 100%; margin-top: 10px;">+ Add Day</button>
      </div>
      <div class="card">
        <h3>Data Management</h3>
        <button class="btn-danger" onclick="app.clearData()" style="width: 100%;">Nuke All Data</button>
      </div>
    </section>

  </div>

  <nav class="nav">
    <div class="nav-btn active" onclick="app.nav('today')" id="nav-today">
      <span class="nav-icon">‚ö°</span><span>Today</span>
    </div>
    <div class="nav-btn" onclick="app.nav('stats')" id="nav-stats">
      <span class="nav-icon">üìà</span><span>Stats</span>
    </div>
    <div class="nav-btn" onclick="app.nav('prs')" id="nav-prs">
      <span class="nav-icon">üèÜ</span><span>PRs</span>
    </div>
  </nav>

  <script>
    /* --- GEMINI STRENGTH PRO CORE ENGINE ---
       Fully Reactive, Persistent, and Data-Driven
    */

    const app = {
      state: {
        program: { units: "lb", split: [], exercises: {} },
        sessions: [],
        exerciseState: {},
        currentTab: "today"
      },

      init() {
        const saved = localStorage.getItem('gemini_pro_v3_data');
        if (saved) this.state = JSON.parse(saved);
        this.render();
      },

      save() {
        localStorage.setItem('gemini_pro_v3_data', JSON.stringify(this.state));
      },

      // --- Navigation ---
      nav(target) {
        this.state.currentTab = target;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(target).classList.add('active');
        document.getElementById('nav-' + (target === 'settings' ? 'today' : target)).classList.add('active');
        
        this.render();
      },

      // --- Math & Analytics ---
      calcE1RM(w, r) { return w * (1 + (r / 30)); },

      getPlateaus() {
        const p = this.state.program;
        const plateaus = [];
        const threshold = 21 * 86400000; // 21 days

        Object.keys(p.exercises).forEach(id => {
          const history = this.state.sessions
            .filter(s => s.logs.some(l => l.exId === id))
            .sort((a,b) => new Date(b.date) - new Date(a.date));
          
          if (history.length < 3) return;
          const currentE1 = history[0].computedE1[id];
          const threeWeeksAgo = history.find(s => (new Date() - new Date(s.date)) > threshold);
          
          if (threeWeeksAgo && currentE1 <= threeWeeksAgo.computedE1[id] * 1.01) {
            plateaus.push({ name: p.exercises[id].name, days: 21 });
          }
        });
        return plateaus;
      },

      // --- Workout Logic ---
      activeWorkout: null,

      startWorkout() {
        const dow = new Date().getDay();
        const plan = this.state.program.split.find(s => s.weekday === dow);
        if (!plan) return;

        this.activeWorkout = {
          date: new Date().toISOString(),
          title: plan.title,
          logs: plan.exercises.map(id => {
            const ex = this.state.program.exercises[id];
            const lastWeight = this.state.exerciseState[id]?.weight || ex.startWeight;
            return {
              exId: id,
              sets: Array.from({ length: ex.sets }, () => ({ w: lastWeight, r: 0, done: false }))
            };
          })
        };
        this.nav('logger');
      },

      finishWorkout() {
        const session = {
          date: this.activeWorkout.date,
          title: this.activeWorkout.title,
          logs: this.activeSessionClean(),
          computedE1: {}
        };

        session.logs.forEach(log => {
          let best = 0;
          log.sets.forEach(s => {
            if(s.done) best = Math.max(best, this.calcE1RM(s.w, s.r));
          });
          session.computedE1[log.exId] = best;
          
          // Auto Progression
          const allDone = log.sets.every(s => s.done && s.r >= 10); // Logic: 10+ reps all sets = +5lb
          if (allDone) {
            this.state.exerciseState[log.exId] = { weight: (this.state.exerciseState[log.exId]?.weight || 0) + 5 };
          }
        });

        this.state.sessions.push(session);
        this.activeWorkout = null;
        this.save();
        this.nav('today');
      },

      activeSessionClean() { return JSON.parse(JSON.stringify(this.activeWorkout.logs)); },

      cancelWorkout() {
        if(confirm("Discard this session?")) {
          this.activeWorkout = null;
          this.nav('today');
        }
      },

      // --- Timer Logic ---
      timerId: null,
      startTimer() {
        clearInterval(this.timerId);
        let count = 60;
        const el = document.getElementById('timerOverlay');
        const val = document.getElementById('timerVal');
        el.style.display = 'block';
        val.innerText = count;

        this.timerId = setInterval(() => {
          count--;
          val.innerText = count;
          if (count <= 0) {
            clearInterval(this.timerId);
            el.style.display = 'none';
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{});
          }
        }, 1000);
      },

      // --- Rendering Screens ---
      render() {
        const t = this.state.currentTab;
        if (t === 'today') this.renderToday();
        if (t === 'logger') this.renderLogger();
        if (t === 'stats') this.renderStats();
        if (t === 'prs') this.renderPRs();
        if (t === 'settings') this.renderSettings();
      },

      renderToday() {
        const dow = new Date().getDay();
        const plan = this.state.program.split.find(s => s.weekday === dow);
        const plateauDiv = document.getElementById('plateauSection');
        const summaryDiv = document.getElementById('workoutSummary');
        const startBtn = document.getElementById('startBtn');

        // Plateau Warnings
        const stalls = this.getPlateaus();
        plateauDiv.innerHTML = stalls.map(s => `
          <div class="card plateau-warning">
            <span class="tiny danger">Plateau Alert</span>
            <h3>${s.name}</h3>
            <p class="muted">Stalled for ${s.days}+ days. Lower weight by 10% to reset.</p>
          </div>
        `).join('');

        if (!plan) {
          summaryDiv.innerHTML = `<div class="card"><h3>Rest Day</h3><p class="muted">No workout scheduled for today. Take it easy!</p></div>`;
          startBtn.style.display = 'none';
        } else {
          summaryDiv.innerHTML = `
            <div class="card">
              <span class="tiny success">Up Next</span>
              <h3>${plan.title}</h3>
              <div class="progress-track"><div class="progress-fill" style="width: 100%"></div></div>
              <p class="muted">${plan.exercises.length} Exercises planned.</p>
            </div>
          `;
          startBtn.style.display = 'block';
        }
      },

      renderLogger() {
        if (!this.activeWorkout) return;
        document.getElementById('logTitle').innerText = this.activeWorkout.title;
        const container = document.getElementById('logExercises');
        container.innerHTML = this.activeWorkout.logs.map((log, exIdx) => {
          const exDef = this.state.program.exercises[log.exId];
          return `
            <div class="card">
              <h3 style="margin-bottom:15px;">${exDef.name}</h3>
              <table class="log-table">
                <tr><th>Set</th><th>Weight</th><th>Reps</th><th></th></tr>
                ${log.sets.map((s, sIdx) => `
                  <tr>
                    <td>${sIdx + 1}</td>
                    <td><input type="number" value="${s.w}" oninput="app.updateLog(${exIdx},${sIdx},'w',this.value)"></td>
                    <td><input type="number" placeholder="0" oninput="app.updateLog(${exIdx},${sIdx},'r',this.value)"></td>
                    <td>
                      <div class="check-btn ${s.done ? 'done' : ''}" onclick="app.toggleDone(${exIdx},${sIdx})">
                        ${s.done ? '‚úì' : ''}
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </table>
            </div>
          `;
        }).join('');
      },

      updateLog(exIdx, sIdx, prop, val) {
        this.activeWorkout.logs[exIdx].sets[sIdx][prop] = parseInt(val) || 0;
      },

      toggleDone(exIdx, sIdx) {
        const s = this.activeWorkout.logs[exIdx].sets[sIdx];
        s.done = !s.done;
        if (s.done) this.startTimer();
        this.renderLogger();
      },

      renderStats() {
        const container = document.getElementById('statsList');
        if (this.state.sessions.length === 0) {
          container.innerHTML = `<p class="muted">Finish your first workout to see analytics.</p>`;
          return;
        }

        let html = "";
        Object.keys(this.state.program.exercises).forEach(id => {
          const history = this.state.sessions.filter(s => s.computedE1[id]).map(s => s.computedE1[id]);
          if (!history.length) return;
          const current = Math.round(history[history.length - 1]);
          const max = Math.round(Math.max(...history));
          const pct = (current / max) * 100;

          html += `
            <div class="card">
              <div style="display:flex; justify-content:space-between;">
                <strong>${this.state.program.exercises[id].name}</strong>
                <span>${current}${this.state.program.units}</span>
              </div>
              <div class="progress-track"><div class="progress-fill" style="width: ${pct}%"></div></div>
              <div style="display:flex; justify-content:space-between;" class="tiny muted">
                <span>Peak: ${max}</span>
                <span>Strength: ${Math.round(pct)}%</span>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      },

      renderPRs() {
        const container = document.getElementById('prList');
        const prs = {};
        this.state.sessions.forEach(s => {
          Object.keys(s.computedE1).forEach(id => {
            if (!prs[id] || s.computedE1[id] > prs[id].val) {
              prs[id] = { val: s.computedE1[id], date: s.date };
            }
          });
        });

        container.innerHTML = Object.keys(prs).map(id => `
          <div class="card pr-glow">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <span class="tiny" style="color:var(--gold)">Personal Record</span>
                <h3 style="margin:0;">${this.state.program.exercises[id].name}</h3>
              </div>
              <h2 style="color:var(--gold); margin:0;">${Math.round(prs[id].val)}</h2>
            </div>
            <p class="tiny muted" style="margin-top:10px;">Set on ${new Date(prs[id].date).toLocaleDateString()}</p>
          </div>
        `).join('') || `<p class="muted">No PRs recorded yet. Keep pushing!</p>`;
      },

      renderSettings() {
        const list = document.getElementById('splitList');
        list.innerHTML = this.state.program.split.map((day, dIdx) => `
          <div style="background: #000; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>${day.title} (${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][day.weekday]})</strong>
              <button class="btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="app.removeDay(${dIdx})">X</button>
            </div>
            <div id="ex-setup-${dIdx}" style="margin-top:10px;">
              ${day.exercises.map(id => `<div class="tiny muted">‚Ä¢ ${this.state.program.exercises[id].name}</div>`).join('')}
            </div>
            <button class="btn-sub" style="width:100%; margin-top:10px; font-size: 12px;" onclick="app.addEx(${dIdx})">+ Add Exercise</button>
          </div>
        `).join('');
      },

      addDay() {
        const title = prompt("Day Name (e.g. Upper Body)");
        const dow = prompt("Day of week (0=Sun, 1=Mon...6=Sat)");
        if (title && dow !== null) {
          this.state.program.split.push({ title, weekday: parseInt(dow), exercises: [] });
          this.save(); this.render();
        }
      },

      addEx(dIdx) {
        const name = prompt("Exercise Name");
        const sets = prompt("Sets", "3");
        const weight = prompt("Starting Weight", "45");
        if (name) {
          const id = 'ex_' + Date.now();
          this.state.program.exercises[id] = { name, sets: parseInt(sets), startWeight: parseInt(weight) };
          this.state.program.split[dIdx].exercises.push(id);
          this.save(); this.render();
        }
      },

      removeDay(idx) {
        if(confirm("Delete this day?")) {
          this.state.program.split.splice(idx, 1);
          this.save(); this.render();
        }
      },

      clearData() {
        if(confirm("DELETE EVERYTHING? This cannot be undone.")) {
          localStorage.clear();
          location.reload();
        }
      }
    };

    // Global Initializer
    app.init();
  </script>
</body>
</html>
