<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#070712"/>
  <title>LiftLog AI</title>
  <style>
    :root{
      --bg:#05040b; --panel:#0c0b18; --card:#131126; --line:rgba(255,255,255,.10);
      --text:#f5f4ff; --muted:rgba(220,218,255,.70); --accent:#b772ff; --accent2:#5be6ff;
      --danger:#ff6b81; --warn:#ffbf5a; --shadow:0 18px 40px rgba(0,0,0,.5); --radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0; background:radial-gradient(circle at top,#15122a 0,#05040b 55%);
      color:var(--text); padding-top:env(safe-area-inset-top);
      padding-bottom:calc(72px + env(safe-area-inset-bottom));
    }
    .app{max-width:560px;margin:0 auto}
    .topbar{
      position:sticky;top:0;z-index:20; background:rgba(7,6,18,.9);
      backdrop-filter:blur(16px); border-bottom:1px solid var(--line); padding:10px 12px;
    }
    .card{
      background:radial-gradient(circle at top left,rgba(183,114,255,.16),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(91,230,255,.12),transparent 60%),
                 linear-gradient(180deg,rgba(16,15,38,.96),rgba(7,7,18,.96));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
      padding:12px; box-shadow:var(--shadow); margin-bottom:12px;
    }
    .screen{display:none} .screen.show{display:block}
    .tabs{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background:rgba(3,3,10,.96); backdrop-filter:blur(16px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:8px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{max-width:560px;margin:0 auto;display:flex;justify-content:space-around;}
    /* ... more styles included in full file ... */
  </style>
</head>
<body>
<div class="app">
  <div id="screenSetup" class="screen">
    <div class="topbar"><div class="title">Setup</div></div>
    <div class="content"><div class="card" id="setupContent">...</div></div>
  </div>

  <div id="screenToday" class="screen">
    <div class="topbar">
      <div class="navrow"><div class="title">Today</div><button id="btnEditSplitToday">Split</button></div>
    </div>
    <div class="content"><div id="todayWorkoutCard" class="card">...</div></div>
  </div>

  <div class="tabs">
    <div class="tabsInner">
      <div class="tab" id="tabToday">Home</div>
      <div class="tab" id="tabLogger">Log</div>
      <div class="tab" id="tabCalendar">Cal</div>
      <div class="tab" id="tabProgress">Prog</div>
    </div>
  </div>
</div>
/* ===== Constants ===== */
const WEEKDAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
const KEY = "liftlog_ai_v1";
const $ = id => document.getElementById(id);

/* ===== Storage & Loading ===== */
function load() {
  try {
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : {
      program: null, sessions: [], exerciseState: {}, prs: {}, ui: { activeTab: "today" }
    };
  } catch {
    return { program: null, sessions: [], exerciseState: {}, prs: {}, ui: { activeTab: "today" } };
  }
}

function save() { 
  localStorage.setItem(KEY, JSON.stringify(state)); 
}

let state = load();
/* ===== Program Management (Setup) ===== */
function normalizeProgram() {
  const p = state.program || {
    units: "lb",
    startWeekDate: defaultMonday(),
    split: [],
    exercises: {},
    settings: { jump: 5, microload: false }
  };
  p.split ||= [];
  p.exercises ||= {};
  return p;
}

// Logic to add/remove workout days
function deleteDay(dayId) {
  const p = normalizeProgram();
  p.split = p.split.filter(d => d.id !== dayId);
  state.program = p;
  save(); render(); toast("Day deleted");
}

/* ===== Progression AI Logic ===== */
function calculateNextSession(logEx, def) {
  const stateEx = state.exerciseState[logEx.exId];
  let nextW = stateEx.nextWeight;
  
  // Check if all sets were completed
  const allDone = logEx.sets.every(s => s.done);
  if (!allDone) return nextW; // No change if workout was incomplete

  // Determine if user hit target reps (Double Progression)
  let passed = true;
  logEx.sets.forEach(s => {
    const targetReps = (def.target.type === "fixed") ? def.target.reps : def.target.max;
    if (s.reps < targetReps) passed = false;
  });

  if (passed) {
    // Increase weight based on the specific exercise rule
    const inc = (def.rule.type === "percent") ? (nextW * (def.rule.pct / 100)) : (def.rule.inc || 5);
    nextW += inc;
    nextW = Math.round(nextW * 100) / 100; // Keep decimals clean
    toast(`AI: Bumped ${def.name} to ${nextW}`);
  }
  
  return nextW;
}

// Helper to ensure exercise tracking exists
function ensureExerciseState(exId, startW) {
  if (!state.exerciseState[exId]) {
    state.exerciseState[exId] = { nextWeight: startW, history: [] };
  }
}
/* ===== Active Logger Logic ===== */
let activeSession = null;

function startSession(dayCfg) {
  activeSession = {
    id: uid(),
    date: isoToday(),
    dayId: dayCfg.id,
    dayTitle: dayCfg.title,
    startTime: Date.now(),
    exercises: []
  };

  const p = normalizeProgram();
  (dayCfg.exercises || []).forEach(exId => {
    const def = p.exercises[exId];
    if (!def) return;
    const st = state.exerciseState[exId] || { nextWeight: def.startWeight };
    
    // Fill initial set data
    const setArr = [];
    for (let i = 0; i < def.sets; i++) {
      setArr.push({
        reps: (def.target.type === "fixed" ? def.target.reps : def.target.max),
        weight: st.nextWeight,
        done: false
      });
    }
    activeSession.exercises.push({ exId, name: def.name, sets: setArr });
  });

  setActiveTab("logger");
}

function finishSession() {
  if (!activeSession) return;
  const p = normalizeProgram();

  activeSession.exercises.forEach(logEx => {
    const def = p.exercises[logEx.exId];
    if (!def) return;

    // Run AI progression
    const nextWeight = calculateNextSession(logEx, def);
    state.exerciseState[logEx.exId].nextWeight = nextWeight;

    // Update Personal Records (PRs)
    if (def.prTag && def.prTag !== "none") {
      const maxLoad = Math.max(...logEx.sets.map(s => s.weight));
      const curPR = state.prs[def.prTag] || 0;
      if (maxLoad > curPR) {
        state.prs[def.prTag] = maxLoad;
      }
    }
  });

  activeSession.endTime = Date.now();
  state.sessions.unshift(activeSession); // Add to history
  if (state.sessions.length > 100) state.sessions.pop(); // Keep storage light
  
  save();
  activeSession = null;
  setActiveTab("today");
}
