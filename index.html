<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0b0f"/>
  <title>LiftLog MVP</title>
  <style>
    :root{
  --bg:#0f1115;
  --panel:#12151c;
  --card:#151a23;
  --line:#262c3a;

  --text:#eef2f7;
  --muted:#98a2b3;

  --accent:#6aa9ff;   /* main accent */
  --danger:#ff5b6e;
  --warn:#ffbf5a;

  --shadow: 0 10px 26px rgba(0,0,0,.28);
  --radius: 16px;
}


    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0;background:var(--bg);color:var(--text);
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(72px + env(safe-area-inset-bottom));
    }
    .app{max-width:560px;margin:0 auto}
    .topbar{
      position:sticky;top:0;z-index:20;
      background: rgba(11,11,15,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid rgba(42,42,62,.65);
      padding: 10px 12px;
    }
    .navrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-size:17px;font-weight:800;text-align:center;flex:1}
    .pill{
      font-size:11px;color:var(--muted);border:1px solid rgba(42,42,62,.7);
      padding:4px 8px;border-radius:999px
    }
    .content{padding:12px}
    .card{
      background: linear-gradient(180deg, rgba(23,23,38,.92), rgba(18,18,26,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    button, input, select, textarea{
      border:1px solid var(--line);
      background:#0f0f18;color:var(--text);
      border-radius:14px;padding:10px 12px;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer}
    button:active{transform:scale(.99)}
    .btnGood{background: rgba(31,228,138,.15);border-color: rgba(31,228,138,.35);}
    .btnDanger{background: rgba(255,77,109,.12);border-color: rgba(255,77,109,.35);}
    .btnGhost{background: rgba(255,255,255,.04);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }
    .list{
      margin-top:12px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      background: rgba(15,15,24,.5);
    }
    .listHeader{
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid rgba(42,42,62,.65);
      display:flex;justify-content:space-between;align-items:center
    }
    .item{
      display:flex;align-items:center;justify-content:space-between;
      padding: 12px;
      border-bottom:1px solid rgba(42,42,62,.35);
    }
    .item:last-child{border-bottom:none}
    .name{font-weight:800}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .tabs{
      position: fixed;left:0;right:0;bottom:0;z-index:30;
      background: rgba(11,11,15,.92);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(42,42,62,.65);
      padding: 8px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{
      max-width:560px;margin:0 auto;
      display:flex;justify-content:space-around;align-items:center;
      gap:10px;
    }
    .tab{display:flex;flex-direction:column;align-items:center;gap:4px;color:#7e8596;font-size:11px;cursor:pointer;user-select:none}
    .tab.active{color:var(--green)}
    .icon{width:22px;height:22px;border-radius:6px;border:1px solid rgba(42,42,62,.7);display:grid;place-items:center;font-weight:900}
    .tab.active .icon{border-color: rgba(31,228,138,.6); box-shadow: 0 0 0 2px rgba(31,228,138,.10) inset;}
    .screen{display:none}
    .screen.show{display:block}
    .fab{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom) + 44px);
      width:66px;height:66px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 14px 40px rgba(31,228,138,.25);
      border:none;
      color:#03110a;
      font-size:36px;
      display:none;
      place-items:center;
      z-index: 40;
    }
    .fab.show{display:grid}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(42,42,62,.5);padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:700;font-size:12px}
    .chk{width:20px;height:20px;border-radius:8px;border:1px solid rgba(42,42,62,.7);display:grid;place-items:center}
    .chk.on{border-color: rgba(31,228,138,.6); background: rgba(31,228,138,.12); color: var(--green); font-weight:900}
    .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
    .mini{padding:7px 9px;border-radius:12px;font-size:12px}
    .sep{height:1px;background:rgba(42,42,62,.55);margin:12px 0}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(42,42,62,.7);color:var(--muted)}
    .badge.good{border-color: rgba(31,228,138,.45); color: var(--green); background: rgba(31,228,138,.10);}
    .badge.hard{border-color: rgba(255,176,32,.45); color: var(--amber); background: rgba(255,176,32,.08);}
    .badge.blue{border-color: rgba(87,184,255,.45); color: var(--blue); background: rgba(87,184,255,.08);}

    .calHead{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .calCell{
      border:1px solid rgba(42,42,62,.6);
      border-radius:14px;
      padding:8px;
      min-height:72px;
      background: rgba(12,12,18,.35);
      cursor:pointer;

      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .calCell.off{opacity:.35;cursor:default}
    .calNum{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--green);display:inline-block}
    .dot.amber{background:var(--amber)}
    .dot.blue{background:var(--blue)}
    /* Title fix (2-line clamp without breaking cell proportions) */
    .calTitle{
      font-size:11px;color:var(--text);opacity:.9;
      line-height:1.2;
      overflow:hidden;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      white-space:normal;
      word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }

    .weekStrip{
      display:grid;grid-template-columns:repeat(7,1fr);gap:8px;
      margin-top:10px;
    }
    .wkDay{
      border:1px solid rgba(42,42,62,.6);
      border-radius:14px;
      padding:8px;
      min-height:54px;
      background: rgba(12,12,18,.25);
      display:flex;flex-direction:column;gap:6px;
      cursor:pointer;
      overflow:hidden;
    }
    .wkTop{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted)}
    .wkTitle{
      font-size:11px;opacity:.9;overflow:hidden;
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      line-height:1.2;white-space:normal;word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }
    .wkDay.today{border-color: rgba(31,228,138,.55); box-shadow: 0 0 0 2px rgba(31,228,138,.10) inset;}

    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;z-index:60;align-items:flex-end;justify-content:center;
      padding: 14px;
    }
    .overlay.show{display:flex}
    .sheet{
      width:min(560px, 100%);
      background: rgba(18,18,26,.96);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .sheet h3{margin:4px 2px 10px;font-size:16px}
    .toast{
      position:fixed;left:50%;bottom:calc(82px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:#111122;border:1px solid rgba(42,42,62,.8);
      padding:10px 12px;border-radius:999px;font-size:12px;color:var(--text);
      opacity:0;pointer-events:none;transition:.18s;z-index:80
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">

  <!-- SETUP -->
  <div id="screenSetup" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Setup</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="tiny">Set your split once. Then logging is fast + auto-progress.</div>
        <div class="sep"></div>

        <div class="grid2">
          <div>
            <div class="tiny">Units</div>
            <select id="setUnits">
              <option value="lb">lbs</option>
              <option value="kg">kg</option>
            </select>
          </div>
          <div>
            <div class="tiny">Start week date (Monday)</div>
            <input id="setStartWeek" placeholder="YYYY-MM-DD"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">Your Split</div>
            <div class="tiny" id="setupProgress">0 days ‚Ä¢ 0 exercises</div>
          </div>
          <button id="btnAddDay" class="btnGood">+ Day</button>
        </div>

        <div id="daysBox" class="list" style="margin-top:10px">
          <div class="listHeader"><span>Days</span><span class="tiny">tap to add exercises</span></div>
          <div id="daysList"></div>
        </div>

        <div class="sep"></div>
        <button id="btnFinishSetup" class="btnGood" style="width:100%">Finish Setup</button>
        <div class="tiny" style="margin-top:10px">You can edit this later in Settings.</div>
      </div>
    </div>
  </div>

  <!-- TODAY -->
  <div id="screenToday" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Today</div>
        <button id="btnSettings" class="btnGhost" style="width:80px">Settings</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="todayTitle">‚Äî</div>
            <div class="tiny" id="todaySub">‚Äî</div>
          </div>
          <span class="pill" id="todayDatePill">‚Äî</span>
        </div>

        <div class="sep"></div>
        <div id="todayBox" class="tiny muted">‚Äî</div>

        <div class="sep"></div>
        <div class="row" style="gap:10px">
          <button id="btnStartWorkout" class="btnGood" style="flex:1">Start Workout</button>
          <button id="btnEditSplitToday" class="btnGhost" style="flex:1">Edit Split</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Quick stats</div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="tiny">Planned sessions this week: <b id="stPlanned">0</b></div>
          <div class="tiny">Completed this week: <b id="stDone">0</b></div>
          <div class="tiny">Streak (days trained): <b id="stStreak">0</b></div>
          <div class="tiny">Total sessions: <b id="stTotal">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGGER -->
  <div id="screenLogger" class="screen">
    <div class="topbar">
      <div class="navrow">
        <button id="btnBackToday" class="btnGhost" style="width:80px">Back</button>
        <div class="title" id="loggerTitle">Workout</div>
        <button id="btnFinishWorkout" class="btnGood" style="width:100px">Finish</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="loggerName">‚Äî</div>
            <div class="tiny" id="loggerMeta">‚Äî</div>
          </div>
          <span class="pill" id="loggerDate">‚Äî</span>
        </div>
        <div class="sep"></div>
        <div class="tiny">Tip: Enter on reps jumps to the next reps cell. Use quick buttons to fly.</div>
      </div>

      <div id="loggerExercises"></div>
    </div>
    <button class="fab" id="fabAddExerciseToSession">+</button>
  </div>

  <!-- CALENDAR -->
  <div id="screenCalendar" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Calendar</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="calHead">
          <button id="calPrev" class="btnGhost">‚Äπ</button>
          <div class="name" id="calMonth">‚Äî</div>
          <button id="calNext" class="btnGhost">‚Ä∫</button>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between;gap:10px">
          <div class="tiny muted">Tap a day. Planned days can start a workout.</div>
          <select id="calFilter">
            <option value="both" selected>Show: Planned + Done</option>
            <option value="planned">Show: Planned</option>
            <option value="done">Show: Done</option>
          </select>
        </div>

        <div class="sep"></div>

        <div class="tiny muted">This week</div>
        <div class="weekStrip" id="weekStrip"></div>

        <div class="sep"></div>

        <div class="calGrid tiny muted" style="margin-top:0">
          <div style="text-align:center">S</div><div style="text-align:center">M</div><div style="text-align:center">T</div>
          <div style="text-align:center">W</div><div style="text-align:center">T</div><div style="text-align:center">F</div><div style="text-align:center">S</div>
        </div>
        <div class="calGrid" id="calGrid"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Selected Day</div>
        <div class="sep"></div>
        <div id="calDetail" class="tiny muted">Tap a day.</div>
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="screenProgress" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Progress</div>
        <div style="width:80px"></div>
      </div>
    </div>

    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">How much stronger did you get?</div>
            <div class="tiny muted">e1RM (Epley) + best set changes.</div>
          </div>
          <div class="right">
            <select id="progWindow">
              <option value="7">Week</option>
              <option value="30" selected>Month</option>
              <option value="365">Year</option>
            </select>
          </div>
        </div>
        <div class="sep"></div>
        <div id="progSummary" class="tiny muted">‚Äî</div>
      </div>

      <div class="list">
        <div class="listHeader"><span>Exercises</span><span class="tiny">last 3 + change</span></div>
        <div id="progList"></div>
      </div>
    </div>
  </div>

  <!-- PRs -->
  <div id="screenPRs" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">PRs</div>
        <div style="width:80px"></div>
      </div>
    </div>

    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">PRs</div>
            <div class="tiny muted">Uses PR tags (Bench/Squat/etc.) so names don‚Äôt need to match.</div>
          </div>
          <div class="right">
            <select id="prWindow">
              <option value="7">Week</option>
              <option value="30" selected>Month</option>
              <option value="365">Year</option>
              <option value="99999">All time</option>
            </select>
          </div>
        </div>
        <div class="sep"></div>
        <div id="prSummary" class="tiny muted">‚Äî</div>
      </div>

      <div id="prCards"></div>

      <div class="card" style="margin-top:12px">
        <div class="name">PR history</div>
        <div class="sep"></div>
        <div id="prHistory" class="tiny muted">‚Äî</div>
      </div>
    </div>
  </div>

</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabsInner">
    <div class="tab" id="tabToday"><div class="icon">‚ñ¶</div><div>Today</div></div>
    <div class="tab" id="tabLogger"><div class="icon">‚â°</div><div>Log</div></div>
    <div class="tab" id="tabCalendar"><div class="icon">üìÖ</div><div>Calendar</div></div>
    <div class="tab" id="tabProgress"><div class="icon">üìà</div><div>Progress</div></div>
    <div class="tab" id="tabPRs"><div class="icon">üèÜ</div><div>PRs</div></div>
  </div>
</div>

<!-- Modal -->
<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <h3 id="sheetTitle">‚Äî</h3>
    <div id="sheetBody"></div>
    <div class="row" style="margin-top:12px">
      <button id="sheetOk" class="btnGood" style="flex:1">OK</button>
      <button id="sheetCancel" class="btnDanger" style="flex:1">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* =========================
   Storage + State
========================= */
const KEY = "liftlog_mvp_v2"; // bumped version (keeps old v1 separate)
const AUTO_BACKUP_KEY = "liftlog_mvp_autobackup";
const $ = (id) => document.getElementById(id);

function toast(msg="Saved"){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  if(navigator.vibrate) navigator.vibrate(10);
  setTimeout(()=>t.classList.remove("show"), 900);
}

function isoToday(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function dayOfWeek(iso){ // 0=Sun..6=Sat
  const d=new Date(iso+"T12:00:00");
  return d.getDay();
}

function prettyDate(iso){
  const d=new Date(iso+"T12:00:00");
  const days=["SUN","MON","TUE","WED","THU","FRI","SAT"];
  const mons=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  return `${days[d.getDay()]}, ${d.getDate()} ${mons[d.getMonth()]} ${d.getFullYear()}`;
}

function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
function num(x, fb=0){ const n=Number(x); return Number.isFinite(n)?n:fb; }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) throw 0;
    const s=JSON.parse(raw);
    s.program ||= null;
    s.sessions ||= [];
    s.exerciseState ||= {};
    s.prs ||= {};
    s.ui ||= { activeTab:"today" };
    s.meta ||= { lastBackupAt: null };
    return s;
  }catch{
    return { program:null, sessions:[], exerciseState:{}, prs:{}, ui:{activeTab:"today"}, meta:{ lastBackupAt:null } };
  }
}
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* Auto weekly backup (localStorage safety copy) */
function maybeAutoBackup(){
  const now = Date.now();
  const last = state.meta?.lastBackupAt ? Number(state.meta.lastBackupAt) : 0;
  const weekMs = 7*24*60*60*1000;
  if(!last || (now - last) > weekMs){
    try{
      localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify({ at: now, state }));
      state.meta ||= {};
      state.meta.lastBackupAt = now;
      save();
    }catch{}
  }
}

let state = load();
maybeAutoBackup();

/* =========================
   Program model helpers
========================= */
const WEEKDAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const PR_TAGS = [
  {v:"none", t:"No PR tag"},
  {v:"bench", t:"Bench PR"},
  {v:"squat", t:"Squat PR"},
  {v:"deadlift", t:"Deadlift PR"},
  {v:"ohp", t:"Overhead Press PR"},
  {v:"row", t:"Row PR"},
  {v:"pullup", t:"Pull-up PR"},
];

function defaultMonday(){
  const d=new Date();
  const dow=d.getDay(); // Sun 0
  const diff = (dow===0? -6 : 1-dow); // move to Monday
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function ensureExerciseState(exId, startWeight){
  if(!state.exerciseState[exId]){
    state.exerciseState[exId] = { currentWeight: startWeight, misses: 0 };
  }
}

function getPlanForWeekday(dow){
  const p=state.program;
  if(!p) return null;
  return p.split.find(s => s.weekday === dow) || null;
}

/* =========================
   Progress + PR calculations
========================= */
function e1rmEpley(w, r){
  if(w<=0 || r<=0) return 0;
  return w * (1 + (r/30));
}

function computeSession(session){
  let totalVol=0;
  const e1rms = {};
  for(const exLog of session.exercises){
    let bestE1 = 0;
    for(const set of exLog.sets){
      const w=num(set.w,0), r=num(set.r,0);
      totalVol += w*r;
      bestE1 = Math.max(bestE1, e1rmEpley(w,r));
    }
    e1rms[exLog.exId] = bestE1;
  }
  session.computed = session.computed || {};
  session.computed.volume = Math.round(totalVol);
  session.computed.e1rm = e1rms;
  return session;
}

function updatePRsFromSession(session){
  for(const exLog of session.exercises){
    const exId = exLog.exId;
    const sets = exLog.sets;
    if(!sets.length) continue;

    state.prs[exId] ||= {
      bestWeight:{value:0,date:null},
      bestE1RM:{value:0,date:null},
      bestVolume:{value:0,date:null},
      bestRepsAtWeight:{weight:0,reps:0,date:null}
    };

    let bestW=0, bestE1=0, exVol=0;

    for(const s of sets){
      const w=num(s.w,0), r=num(s.r,0);
      bestW = Math.max(bestW, w);
      bestE1 = Math.max(bestE1, e1rmEpley(w,r));
      exVol += w*r;

      if(w>0){
        const cur = state.prs[exId].bestRepsAtWeight;
        if(cur.weight===0 || w > cur.weight || (w===cur.weight && r>cur.reps)){
          state.prs[exId].bestRepsAtWeight = { weight:w, reps:r, date: session.date };
        }
      }
    }

    if(bestW > state.prs[exId].bestWeight.value){
      state.prs[exId].bestWeight = { value: bestW, date: session.date };
    }
    if(bestE1 > state.prs[exId].bestE1RM.value){
      state.prs[exId].bestE1RM = { value: Math.round(bestE1), date: session.date };
    }
    if(exVol > state.prs[exId].bestVolume.value){
      state.prs[exId].bestVolume = { value: Math.round(exVol), date: session.date };
    }
  }
}

/* =========================
   Progression engine
========================= */
function isSuccessForExercise(exDef, exLog){
  const attempted = (exLog.sets||[]).filter(s => num(s.r,0) > 0);
  if(!attempted.length) return false;

  if(exDef.target.type === "range"){
    const min = num(exDef.target.min, 6);
    return attempted.every(s => num(s.r,0) >= min);
  } else {
    const reps = num(exDef.target.reps, 3);
    return attempted.every(s => num(s.r,0) >= reps);
  }
}

function hitTopRangeAllSets(exDef, exLog){
  if(exDef.target.type !== "range") return false;
  const max = num(exDef.target.max, 10);
  const attempted = (exLog.sets||[]).filter(s => num(s.r,0) > 0);
  if(!attempted.length) return false;
  return attempted.every(s => num(s.r,0) >= max);
}

function applyProgression(exDef, exLog){
  const exId = exLog.exId;
  ensureExerciseState(exId, exDef.startWeight);
  const st = state.exerciseState[exId];
  const rule = exDef.rule || {type:"double", inc:5};

  const success = isSuccessForExercise(exDef, exLog);
  const topHit = hitTopRangeAllSets(exDef, exLog);

  // Bodyweight mode: reps-first when startWeight==0 AND setting enabled
  const repsFirstBW = !!(state.program?.settings?.repsFirstBW);
  const isBW = (num(exDef.startWeight,0) === 0);

  if(!success){
    st.misses = (st.misses || 0) + 1;
    if((rule.deloadOnMiss2 ?? true) && st.misses >= 2){
      // If BW reps-first, don't deload weight (still 0). Just reset misses.
      if(!isBW){
        st.currentWeight = Math.max(0, Math.round(st.currentWeight * 0.9));
      }
      st.misses = 0;
    }
    return;
  }

  st.misses = 0;

  if(isBW && repsFirstBW){
    // Increase target reps before adding weight
    if(exDef.target.type === "range"){
      if(topHit){
        exDef.target.min = clamp(num(exDef.target.min,6)+1,1,100);
        exDef.target.max = clamp(num(exDef.target.max,8)+1,1,100);
      }
    }else{
      exDef.target.reps = clamp(num(exDef.target.reps,3)+1,1,100);
    }
    return;
  }

  if(rule.type === "double"){
    const inc = num(rule.inc, 5);
    if(exDef.target.type === "range"){
      if(topHit) st.currentWeight = st.currentWeight + inc;
    }else{
      st.currentWeight = st.currentWeight + inc;
    }
  } else if(rule.type === "fixed"){
    const inc = num(rule.inc, 5);
    st.currentWeight = st.currentWeight + inc;
  } else if(rule.type === "percent"){
    const pct = num(rule.pct, 2.5)/100;
    st.currentWeight = Math.round(st.currentWeight * (1+pct));
  }
}

/* =========================
   UI Routing + Tabs
========================= */
function tabEl(id, active){
  const el=$(id);
  if(!el) return;
  el.classList.toggle("active", active);
}

function showScreen(id){
  for(const s of ["screenSetup","screenToday","screenLogger","screenCalendar","screenProgress","screenPRs"]){
    const el = $(s);
    if(el) el.classList.toggle("show", s===id);
  }
}

function setActiveTab(tab){
  state.ui.activeTab = tab;
  save();
  render();
}

/* =========================
   Modal helpers
========================= */
let modal = { onOk:null, onCancel:null };

function openModal(title, bodyHtml, okText="OK", cancelText="Cancel", onOk=null, onCancel=null){
  $("sheetTitle").textContent = title;
  $("sheetBody").innerHTML = bodyHtml;
  $("sheetOk").textContent = okText;
  $("sheetCancel").textContent = cancelText;
  modal.onOk = onOk;
  modal.onCancel = onCancel;
  $("overlay").classList.add("show");
}
function closeModal(){ $("overlay").classList.remove("show"); modal.onOk=null; modal.onCancel=null; }
$("overlay").addEventListener("click", (e)=>{ if(e.target === $("overlay")) closeModal(); });
$("sheetOk").addEventListener("click", ()=>{ if(modal.onOk) modal.onOk(); else closeModal(); });
$("sheetCancel").addEventListener("click", ()=>{ if(modal.onCancel) modal.onCancel(); closeModal(); });

/* =========================
   Setup Screen
========================= */
function countSetupProgress(p){
  const days = (p.split||[]).length;
  let exTotal = 0;
  for(const d of (p.split||[])) exTotal += (d.exercises||[]).length;
  return { days, exTotal };
}

function renderSetup(){
  $("setUnits").value = state.program?.units || "lb";
  $("setStartWeek").value = state.program?.startWeekDate || defaultMonday();

  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{}, settings:{jump:5, microload:false, repsFirstBW:false} };
  const {days, exTotal} = countSetupProgress(p);
  $("setupProgress").textContent = `${days} day(s) ‚Ä¢ ${exTotal} exercise(s)`;

  const list = $("daysList");
  list.innerHTML = "";

  if(!p.split.length){
    list.innerHTML = `<div class="item"><div class="tiny muted">No days yet. Tap ‚Äú+ Day‚Äù.</div></div>`;
  } else {
    for(const day of p.split){
      const exCount = (day.exercises||[]).length;
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div>
          <div class="name">${escapeHtml(WEEKDAYS[day.weekday])} ‚Äî ${escapeHtml(day.title)}</div>
          <div class="tiny muted">${exCount} exercise(s)</div>
        </div>
        <div class="right">
          <button class="mini btnGhost" data-act="addEx" data-id="${day.id}">+ Exercise</button>
          <button class="mini btnDanger" data-act="delDay" data-id="${day.id}">Delete</button>
        </div>
      `;
      list.appendChild(div);

      const exDiv = document.createElement("div");
      exDiv.style.padding="0 12px 10px";
      exDiv.innerHTML = (day.exercises||[]).map(exId=>{
        const ex = p.exercises[exId];
        if(!ex) return "";
        const tgt = ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const rule = ex.rule?.type || "double";
        const ruleTxt = rule==="double" ? `Double +${ex.rule.inc||5}` :
                        rule==="fixed" ? `Weekly +${ex.rule.inc||5}` :
                        `+${ex.rule.pct||2.5}%`;
        const tag = ex.prTag && ex.prTag!=="none" ? PR_TAGS.find(x=>x.v===ex.prTag)?.t : "";
        const tagBadge = tag ? `<span class="badge blue">${escapeHtml(tag)}</span>` : "";
        return `
          <div class="item" style="border-radius:14px;margin-top:8px;background:rgba(12,12,18,.35);border:1px solid rgba(42,42,62,.5)">
            <div>
              <div class="name">${escapeHtml(ex.name)} ${tagBadge}</div>
              <div class="tiny muted">${ex.sets} sets ‚Ä¢ ${tgt} reps ‚Ä¢ start ${ex.startWeight}${p.units} ‚Ä¢ ${ruleTxt}</div>
            </div>
            <div class="right">
              <button class="mini btnGhost" data-act="editEx" data-day="${day.id}" data-ex="${exId}">Edit</button>
              <button class="mini btnDanger" data-act="delEx" data-day="${day.id}" data-ex="${exId}">Remove</button>
            </div>
          </div>
        `;
      }).join("");
      list.appendChild(exDiv);
    }
  }

  list.querySelectorAll("button[data-act]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const act=b.getAttribute("data-act");
      const id=b.getAttribute("data-id");
      if(act==="delDay") deleteDay(id);
      if(act==="addEx") addExerciseToDay(id);
      if(act==="delEx"){
        const dayId=b.getAttribute("data-day");
        const exId=b.getAttribute("data-ex");
        removeExerciseFromDay(dayId, exId);
      }
      if(act==="editEx"){
        const dayId=b.getAttribute("data-day");
        const exId=b.getAttribute("data-ex");
        editExercise(exId);
      }
    });
  });
}

function deleteDay(dayId){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{}, settings:{jump:5, microload:false, repsFirstBW:false} };
  p.split = p.split.filter(d => d.id !== dayId);
  state.program = p;
  save();
  render();
}

function addDay(){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{}, settings:{jump:5, microload:false, repsFirstBW:false} };
  openModal("Add Day",
    `
      <div class="grid2">
        <div>
          <div class="tiny">Weekday</div>
          <select id="mWeekday">
            ${WEEKDAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("")}
          </select>
        </div>
        <div>
          <div class="tiny">Title</div>
          <input id="mTitle" placeholder="Upper / Lower / Push..."/>
        </div>
      </div>
      <div class="tiny muted" style="margin-top:10px">Example: Tue Upper, Wed Lower, Fri Upper‚Ä¶</div>
    `,
    "Add","Cancel",
    ()=>{
      const wd = num(document.getElementById("mWeekday").value, 1);
      const title = (document.getElementById("mTitle").value||"Workout").trim();
      p.split.push({ id: uid(), weekday: wd, title, exercises: [] });
      state.program = p;
      save();
      closeModal();
      render();
      toast("Day added");
    },
    ()=>{}
  );
}

function addExerciseToDay(dayId){
  const p = state.program || { units:"lb", startWeekDate: defaultMonday(), split:[], exercises:{}, settings:{jump:5, microload:false, repsFirstBW:false} };
  const day = p.split.find(d=>d.id===dayId);
  if(!day) return;

  openModal("Add Exercise",
    `
      <div class="grid2">
        <div class="tiny" style="grid-column:1/-1">Name</div>
        <input id="exName" class="full" placeholder="Bench Press / Squat / Pull-Ups"/>

        <div>
          <div class="tiny">Sets</div>
          <input id="exSets" inputmode="numeric" value="4"/>
        </div>

        <div>
          <div class="tiny">Start weight (${p.units})</div>
          <input id="exW" inputmode="decimal" value="0"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">PR tag (optional)</div>
        <select id="exPRTag">
          ${PR_TAGS.map(x=>`<option value="${x.v}">${escapeHtml(x.t)}</option>`).join("")}
        </select>

        <div class="tiny" style="grid-column:1/-1">Target</div>
        <select id="exTargetType">
          <option value="range">Rep range</option>
          <option value="fixed">Fixed reps</option>
        </select>

        <div id="rangeBox" class="grid2" style="grid-column:1/-1">
          <div>
            <div class="tiny">Min</div>
            <input id="exMin" inputmode="numeric" value="6"/>
          </div>
          <div>
            <div class="tiny">Max</div>
            <input id="exMax" inputmode="numeric" value="8"/>
          </div>
        </div>

        <div id="fixedBox" style="grid-column:1/-1; display:none">
          <div class="tiny">Reps</div>
          <input id="exFixed" inputmode="numeric" value="3"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">Progression rule</div>
        <select id="exRuleType">
          <option value="double">Double progression</option>
          <option value="fixed">Fixed weekly increase</option>
          <option value="percent">Percent increase</option>
        </select>

        <div id="incBox" class="grid2" style="grid-column:1/-1">
          <div>
            <div class="tiny">Increase (${p.units})</div>
            <input id="exInc" inputmode="decimal" value="5"/>
          </div>
          <div>
            <div class="tiny">Deload after 2 misses</div>
            <select id="exDeload">
              <option value="yes">Yes (-10%)</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>

        <div id="pctBox" class="grid2" style="grid-column:1/-1; display:none">
          <div>
            <div class="tiny">Percent (%)</div>
            <input id="exPct" inputmode="decimal" value="2.5"/>
          </div>
          <div></div>
        </div>

        <div class="tiny muted" style="grid-column:1/-1;margin-top:6px">
          Tip: For bodyweight moves, start weight can be 0. If Settings ‚Üí ‚ÄúBodyweight reps-first‚Äù is on, your targets will auto-increase reps instead of weight.
        </div>
      </div>
    `,
    "Add","Cancel",
    ()=>{
      const name = (document.getElementById("exName").value||"").trim();
      if(!name){ alert("Enter exercise name."); return; }
      const sets = clamp(num(document.getElementById("exSets").value, 4), 1, 20);
      const startW = num(document.getElementById("exW").value, 0);
      const prTag = document.getElementById("exPRTag").value || "none";

      const ttype = document.getElementById("exTargetType").value;
      let target;
      if(ttype==="range"){
        target = {
          type:"range",
          min: clamp(num(document.getElementById("exMin").value,6),1,200),
          max: clamp(num(document.getElementById("exMax").value,8),1,200)
        };
        if(target.max < target.min) target.max = target.min;
      } else {
        target = { type:"fixed", reps: clamp(num(document.getElementById("exFixed").value,3),1,200) };
      }

      const rtype = document.getElementById("exRuleType").value;
      const deload = (document.getElementById("exDeload")?.value || "yes") === "yes";
      let rule;
      if(rtype==="percent"){
        rule = { type:"percent", pct: num(document.getElementById("exPct").value, 2.5), deloadOnMiss2: deload };
      } else {
        rule = { type: rtype, inc: num(document.getElementById("exInc").value, 5), deloadOnMiss2: deload };
      }

      const exId = "ex_"+uid();
      p.exercises[exId] = { name, sets, target, startWeight:startW, rule, prTag };
      day.exercises.push(exId);
      state.program = p;

      ensureExerciseState(exId, startW);

      save();
      closeModal();
      render();
      toast("Exercise added");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel = document.getElementById("exTargetType");
    const rsel = document.getElementById("exRuleType");
    const rangeBox = document.getElementById("rangeBox");
    const fixedBox = document.getElementById("fixedBox");
    const incBox = document.getElementById("incBox");
    const pctBox = document.getElementById("pctBox");

    const sync = ()=>{
      const t = tsel.value;
      rangeBox.style.display = (t==="range") ? "" : "none";
      fixedBox.style.display = (t==="fixed") ? "" : "none";
    };
    const syncRule = ()=>{
      const r = rsel.value;
      incBox.style.display = (r==="percent") ? "none" : "";
      pctBox.style.display = (r==="percent") ? "" : "none";
    };
    tsel.addEventListener("change", sync);
    rsel.addEventListener("change", syncRule);
    sync(); syncRule();
  }, 0);
}

function editExercise(exId){
  const p = state.program;
  const ex = p?.exercises?.[exId];
  if(!ex) return;

  openModal("Edit Exercise",
    `
      <div class="grid2">
        <div class="tiny" style="grid-column:1/-1">Name</div>
        <input id="edName" value="${escapeAttr(ex.name||"")}"/>

        <div>
          <div class="tiny">Sets</div>
          <input id="edSets" inputmode="numeric" value="${escapeAttr(ex.sets)}"/>
        </div>

        <div>
          <div class="tiny">Start weight (${p.units})</div>
          <input id="edW" inputmode="decimal" value="${escapeAttr(ex.startWeight)}"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">PR tag</div>
        <select id="edPRTag">
          ${PR_TAGS.map(x=>`<option value="${x.v}" ${x.v===(ex.prTag||"none")?"selected":""}>${escapeHtml(x.t)}</option>`).join("")}
        </select>

        <div class="tiny" style="grid-column:1/-1">Target</div>
        <select id="edTargetType">
          <option value="range" ${ex.target.type==="range"?"selected":""}>Rep range</option>
          <option value="fixed" ${ex.target.type==="fixed"?"selected":""}>Fixed reps</option>
        </select>

        <div id="edRangeBox" class="grid2" style="grid-column:1/-1; ${ex.target.type==="range"?"":"display:none"}">
          <div>
            <div class="tiny">Min</div>
            <input id="edMin" inputmode="numeric" value="${escapeAttr(ex.target.min ?? 6)}"/>
          </div>
          <div>
            <div class="tiny">Max</div>
            <input id="edMax" inputmode="numeric" value="${escapeAttr(ex.target.max ?? 8)}"/>
          </div>
        </div>

        <div id="edFixedBox" style="grid-column:1/-1; ${ex.target.type==="fixed"?"":"display:none"}">
          <div class="tiny">Reps</div>
          <input id="edFixed" inputmode="numeric" value="${escapeAttr(ex.target.reps ?? 3)}"/>
        </div>

        <div class="tiny" style="grid-column:1/-1">Progression rule</div>
        <select id="edRuleType">
          <option value="double" ${(ex.rule?.type||"double")==="double"?"selected":""}>Double progression</option>
          <option value="fixed" ${(ex.rule?.type||"double")==="fixed"?"selected":""}>Fixed weekly increase</option>
          <option value="percent" ${(ex.rule?.type||"double")==="percent"?"selected":""}>Percent increase</option>
        </select>

        <div id="edIncBox" class="grid2" style="grid-column:1/-1; ${(ex.rule?.type||"double")==="percent"?"display:none":""}">
          <div>
            <div class="tiny">Increase (${p.units})</div>
            <input id="edInc" inputmode="decimal" value="${escapeAttr(ex.rule?.inc ?? 5)}"/>
          </div>
          <div>
            <div class="tiny">Deload after 2 misses</div>
            <select id="edDeload">
              <option value="yes" ${(ex.rule?.deloadOnMiss2 ?? true) ? "selected":""}>Yes (-10%)</option>
              <option value="no" ${!(ex.rule?.deloadOnMiss2 ?? true) ? "selected":""}>No</option>
            </select>
          </div>
        </div>

        <div id="edPctBox" class="grid2" style="grid-column:1/-1; ${(ex.rule?.type||"double")==="percent"?"":"display:none"}">
          <div>
            <div class="tiny">Percent (%)</div>
            <input id="edPct" inputmode="decimal" value="${escapeAttr(ex.rule?.pct ?? 2.5)}"/>
          </div>
          <div></div>
        </div>

        <div class="tiny muted" style="grid-column:1/-1;margin-top:6px">
          Note: changing sets/targets affects future sessions (not past logs).
        </div>
      </div>
    `,
    "Save","Cancel",
    ()=>{
      ex.name = (document.getElementById("edName").value||ex.name).trim();
      ex.sets = clamp(num(document.getElementById("edSets").value, ex.sets), 1, 30);
      ex.startWeight = num(document.getElementById("edW").value, ex.startWeight);
      ex.prTag = document.getElementById("edPRTag").value || "none";

      const ttype = document.getElementById("edTargetType").value;
      if(ttype==="range"){
        ex.target = {
          type:"range",
          min: clamp(num(document.getElementById("edMin").value, ex.target.min ?? 6),1,200),
          max: clamp(num(document.getElementById("edMax").value, ex.target.max ?? 8),1,200),
        };
        if(ex.target.max < ex.target.min) ex.target.max = ex.target.min;
      }else{
        ex.target = { type:"fixed", reps: clamp(num(document.getElementById("edFixed").value, ex.target.reps ?? 3),1,200) };
      }

      const rtype = document.getElementById("edRuleType").value;
      const deload = (document.getElementById("edDeload")?.value || "yes") === "yes";
      if(rtype==="percent"){
        ex.rule = { type:"percent", pct: num(document.getElementById("edPct").value, 2.5), deloadOnMiss2: deload };
      }else{
        ex.rule = { type: rtype, inc: num(document.getElementById("edInc").value, 5), deloadOnMiss2: deload };
      }

      ensureExerciseState(exId, ex.startWeight);
      save();
      closeModal();
      render();
      toast("Updated");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel = document.getElementById("edTargetType");
    const rsel = document.getElementById("edRuleType");
    const rangeBox = document.getElementById("edRangeBox");
    const fixedBox = document.getElementById("edFixedBox");
    const incBox = document.getElementById("edIncBox");
    const pctBox = document.getElementById("edPctBox");

    const sync = ()=>{
      const t = tsel.value;
      rangeBox.style.display = (t==="range") ? "" : "none";
      fixedBox.style.display = (t==="fixed") ? "" : "none";
    };
    const syncRule = ()=>{
      const r = rsel.value;
      incBox.style.display = (r==="percent") ? "none" : "";
      pctBox.style.display = (r==="percent") ? "" : "none";
    };
    tsel.addEventListener("change", sync);
    rsel.addEventListener("change", syncRule);
  }, 0);
}

function removeExerciseFromDay(dayId, exId){
  const p = state.program;
  if(!p) return;
  const day = p.split.find(d=>d.id===dayId);
  if(!day) return;
  day.exercises = (day.exercises||[]).filter(x=>x!==exId);
  state.program = p;
  save();
  render();
  toast("Removed");
}

$("btnAddDay").addEventListener("click", addDay);

$("btnFinishSetup").addEventListener("click", ()=>{
  const units = $("setUnits").value;
  const startWeekDate = ($("setStartWeek").value||"").trim() || defaultMonday();
  const p = state.program || { units, startWeekDate, split:[], exercises:{}, settings:{jump:5, microload:false, repsFirstBW:false} };
  p.units = units;
  p.startWeekDate = startWeekDate;
  p.settings ||= {};
  p.settings.jump ??= 5;
  p.settings.microload ??= false;
  p.settings.repsFirstBW ??= false;

  if(!p.split.length){
    alert("Add at least 1 training day.");
    return;
  }
  state.program = p;
  save();
  toast("Setup saved");
  setActiveTab("today");
});

/* =========================
   Today + Logger
========================= */
let sessionDraft = null;

function weekKeyForDate(iso){
  const d=new Date(iso+"T12:00:00");
  const dow=d.getDay();
  const diff = (dow===0? -6 : 1-dow);
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function countWeekStats(){
  const today = isoToday();
  const wk = weekKeyForDate(today);
  const p = state.program;
  const planned = p ? p.split.length : 0;
  const doneThisWeek = state.sessions.filter(s => weekKeyForDate(s.date)===wk).length;

  let streak=0;
  const datesSet = new Set(state.sessions.map(s=>s.date));
  let d = new Date(today+"T12:00:00");
  for(;;){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
    const iso=`${y}-${m}-${day}`;
    if(datesSet.has(iso)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }

  $("stPlanned").textContent = planned;
  $("stDone").textContent = doneThisWeek;
  $("stStreak").textContent = streak;
  $("stTotal").textContent = state.sessions.length;
}

function plannedWorkoutForDate(iso){
  const p=state.program;
  if(!p) return null;
  const dow=dayOfWeek(iso);
  const plan = getPlanForWeekday(dow);
  return { date:iso, dow, plan };
}
function plannedWorkoutForToday(){
  return plannedWorkoutForDate(isoToday());
}

function renderToday(){
  const p=state.program;
  const info = plannedWorkoutForToday();
  const d=isoToday();
  $("todayDatePill").textContent = d;
  $("todaySub").textContent = prettyDate(d);

  if(!p || !info?.plan){
    $("todayTitle").textContent = "Rest Day ‚úÖ";
    $("todayBox").innerHTML = `No workout scheduled for today.`;
    $("btnStartWorkout").disabled = true;
  } else {
    $("todayTitle").textContent = info.plan.title;
    const exIds = info.plan.exercises || [];
    if(!exIds.length){
      $("todayBox").innerHTML = `No exercises in today‚Äôs plan. (Add in Edit Split)`;
      $("btnStartWorkout").disabled = true;
    } else {
      const lines = exIds.map(exId=>{
        const ex=p.exercises[exId];
        if(!ex) return "";
        ensureExerciseState(exId, ex.startWeight);
        const st=state.exerciseState[exId];
        const tgt = ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const w = st.currentWeight;
        const tag = ex.prTag && ex.prTag!=="none" ? PR_TAGS.find(x=>x.v===ex.prTag)?.t : "";
        return `<div class="item">
          <div>
            <div class="name">${escapeHtml(ex.name)} ${tag?`<span class="badge blue">${escapeHtml(tag)}</span>`:""}</div>
            <div class="tiny muted">${ex.sets} sets ‚Ä¢ ${tgt} reps ‚Ä¢ target <b>${w}${p.units}</b></div>
          </div>
          <span class="pill">next: ${w}${p.units}</span>
        </div>`;
      }).join("");
      $("todayBox").innerHTML = `<div class="list" style="margin-top:0"><div class="listHeader"><span>Planned</span><span class="tiny">targets</span></div>${lines}</div>`;
      $("btnStartWorkout").disabled = false;
    }
  }

  countWeekStats();
}

function buildSessionDraftForDate(iso){
  const p=state.program;
  const info = plannedWorkoutForDate(iso);
  if(!info?.plan) return null;
  const {date,dow,plan} = info;

  const exLogs = (plan.exercises||[]).map(exId=>{
    const ex = p.exercises[exId];
    ensureExerciseState(exId, ex.startWeight);
    const w = state.exerciseState[exId].currentWeight;
    const sets = Array.from({length: ex.sets}, ()=>({ w: w, r: 0, done:false }));
    return { exId, sets, note:"" };
  });

  return {
    id: "sess_"+uid(),
    date,
    weekday: dow,
    workoutTitle: plan.title,
    rating: "normal",
    notes: "",
    exercises: exLogs,
    computed: { volume:0, e1rm:{} }
  };
}

$("btnStartWorkout").addEventListener("click", ()=>{
  sessionDraft = buildSessionDraftForDate(isoToday());
  if(!sessionDraft){ toast("No plan today"); return; }
  setActiveTab("logger");
});

$("btnEditSplitToday").addEventListener("click", ()=>{
  showScreen("screenSetup");
  renderSetup();
});

$("btnBackToday").addEventListener("click", ()=> setActiveTab("today"));

/* =========================
   Logger rendering + controls
========================= */
function ruleText(exDef, units){
  const r=exDef.rule||{type:"double",inc:5};
  const deload = (r.deloadOnMiss2 ?? true) ? " ‚Ä¢ deload -10% after 2 misses" : "";
  if(r.type==="double"){
    if(exDef.target.type==="range") return `Double:s: hit top reps on all sets ‚Üí +${r.inc||5}${units}.${deload}`;
    return `Fixed reps: complete all sets ‚Üí +${r.inc||5}${units}.${deload}`;
  }
  if(r.type==="fixed"){
    return `Weekly increase: if successful ‚Üí +${r.inc||5}${units}.${deload}`;
  }
  return `Percent increase: if successful ‚Üí +${r.pct||2.5}%.${deload}`;
}

function getJumpForExercise(exDef){
  const base = num(state.program?.settings?.jump ?? 5, 5);
  const micro = !!(state.program?.settings?.microload);
  const tag = (exDef.prTag||"none");
  // Microload: bench/ohp default 2.5 (lb), squat/deadlift keep base
  if(micro && (tag==="bench" || tag==="ohp")) return 2.5;
  return base;
}

function renderLogger(){
  const p=state.program;
  if(!sessionDraft || !p){
    $("loggerExercises").innerHTML = `<div class="content"><div class="card"><div class="tiny muted">No active workout. Start from Today / Calendar planned day.</div></div></div>`;
    $("fabAddExerciseToSession").classList.remove("show");
    return;
  }

  $("loggerTitle").textContent = "Log";
  $("loggerName").textContent = sessionDraft.workoutTitle;
  $("loggerMeta").textContent = `Targets in ${p.units}. Enter on reps jumps to next reps.`;
  $("loggerDate").textContent = sessionDraft.date;

  const box=$("loggerExercises");
  box.innerHTML = "";

  sessionDraft.exercises.forEach((exLog, idx)=>{
    const exDef = p.exercises[exLog.exId];
    if(!exDef) return;

    const tgt = exDef.target.type==="range" ? `${exDef.target.min}-${exDef.target.max}` : `${exDef.target.reps}`;
    const st = state.exerciseState[exLog.exId] || { currentWeight: exDef.startWeight, misses:0 };
    const targetW = st.currentWeight;
    const jump = getJumpForExercise(exDef);

    const card=document.createElement("div");
    card.className="card";
    card.style.marginTop="12px";

    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="name">${escapeHtml(exDef.name)} ${(exDef.prTag && exDef.prTag!=="none")?`<span class="badge blue">${escapeHtml(PR_TAGS.find(x=>x.v===exDef.prTag)?.t||"PR")}</span>`:""}</div>
          <div class="tiny muted">${exLog.sets.length} sets ‚Ä¢ ${tgt} reps ‚Ä¢ target <b>${targetW}${p.units}</b></div>
        </div>
        <div class="right">
          <span class="badge">misses: ${st.misses||0}</span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between;gap:10px">
        <div class="miniBtns">
          <button class="mini btnGhost" data-act="copySet1" data-e="${idx}">Copy set 1 ‚Üí all</button>
          <button class="mini btnGhost" data-act="fillMin" data-e="${idx}">Fill reps = min</button>
        </div>
        <div class="miniBtns">
          <button class="mini btnGhost" data-act="addSet" data-e="${idx}">+ Set</button>
          <button class="mini btnGhost" data-act="delSet" data-e="${idx}">‚Äì Set</button>
        </div>
      </div>

      <div class="sep"></div>

      <table>
        <thead>
          <tr>
            <th style="width:42px">‚úì</th>
            <th style="width:64px">Set</th>
            <th>Weight</th>
            <th>Reps</th>
            <th style="width:120px">Quick</th>
          </tr>
        </thead>
        <tbody>
          ${exLog.sets.map((s,i)=>`
            <tr>
              <td><div class="chk ${s.done?'on':''}" data-act="toggle" data-e="${idx}" data-i="${i}">${s.done?'‚úì':''}</div></td>
              <td>${i+1}</td>
              <td><input inputmode="decimal" value="${escapeAttr(s.w)}" data-act="w" data-e="${idx}" data-i="${i}" style="width:100%"/></td>
              <td><input inputmode="numeric" value="${escapeAttr(s.r)}" data-act="r" data-e="${idx}" data-i="${i}" style="width:100%"/></td>
              <td>
                <div class="miniBtns">
                  <button class="mini btnGhost" data-act="repUp" data-e="${idx}" data-i="${i}">+1</button>
                  <button class="mini btnGhost" data-act="repDn" data-e="${idx}" data-i="${i}">-1</button>
                  <button class="mini btnGhost" data-act="wUp" data-e="${idx}" data-i="${i}">+${jump}</button>
                  <button class="mini btnGhost" data-act="wDn" data-e="${idx}" data-i="${i}">-${jump}</button>
                  <button class="mini btnGhost" data-act="copyPrev" data-e="${idx}" data-i="${i}">Copy</button>
                </div>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="sep"></div>

      <div class="grid2">
        <div>
          <div class="tiny">Exercise note</div>
          <input value="${escapeAttr(exLog.note||"")}" data-act="note" data-e="${idx}" placeholder="felt heavy, form‚Ä¶"/>
        </div>
        <div>
          <div class="tiny">Rule</div>
          <div class="tiny muted">${ruleText(exDef, p.units)}</div>
        </div>
      </div>
    `;

    card.addEventListener("click", (ev)=>{
      const t = ev.target;
      if(!(t instanceof HTMLElement)) return;
      const act = t.getAttribute("data-act");
      if(!act) return;

      const e = num(t.getAttribute("data-e"), -1);
      const i = num(t.getAttribute("data-i"), -1);
      if(e<0) return;

      const exL = sessionDraft.exercises[e];
      const exDefLocal = p.exercises[exL.exId];
      const set = (i>=0) ? exL.sets[i] : null;
      const jumpLocal = getJumpForExercise(exDefLocal);

      if(act==="copySet1"){
        if(exL.sets.length){
          const s0 = exL.sets[0];
          for(let k=0;k<exL.sets.length;k++){
            exL.sets[k].w = s0.w;
            exL.sets[k].r = s0.r;
          }
          toast("Copied");
          render();
        }
      }
      if(act==="fillMin"){
        const min = exDefLocal.target.type==="range" ? num(exDefLocal.target.min,6) : num(exDefLocal.target.reps,3);
        for(const s of exL.sets){
          if(num(s.r,0)===0) s.r = min;
        }
        toast("Filled");
        render();
      }
      if(act==="addSet"){
        const last = exL.sets[exL.sets.length-1] || {w: targetW, r: 0, done:false};
        exL.sets.push({ w: num(last.w,targetW), r: num(last.r,0), done:false });
        toast("+ Set");
        render();
      }
      if(act==="delSet"){
        if(exL.sets.length>1){
          exL.sets.pop();
          toast("‚Äì Set");
          render();
        }
      }

      if(act==="toggle" && set){
        set.done = !set.done;
        if(set.done && num(set.r,0)===0){
          if(exDefLocal.target.type==="range") set.r = exDefLocal.target.min;
          else set.r = exDefLocal.target.reps;
        }
        render();
      }
      if(act==="repUp" && set){ set.r = clamp(num(set.r,0)+1, 0, 200); render(); }
      if(act==="repDn" && set){ set.r = clamp(num(set.r,0)-1, 0, 200); render(); }
      if(act==="wUp" && set){ set.w = num(set.w,0)+jumpLocal; render(); }
      if(act==="wDn" && set){ set.w = Math.max(0, num(set.w,0)-jumpLocal); render(); }
      if(act==="copyPrev" && set){
        if(i>0){
          set.w = exL.sets[i-1].w;
          set.r = exL.sets[i-1].r;
          render();
        }
      }
    });

    // Input handlers (including Enter auto-advance on reps)
    const inputsW = card.querySelectorAll("input[data-act='w']");
    const inputsR = card.querySelectorAll("input[data-act='r']");

    inputsW.forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1), i=num(inp.getAttribute("data-i"),-1);
        sessionDraft.exercises[e].sets[i].w = num(inp.value,0);
      });
    });

    inputsR.forEach((inp, idxR)=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1), i=num(inp.getAttribute("data-i"),-1);
        sessionDraft.exercises[e].sets[i].r = num(inp.value,0);
      });
      inp.addEventListener("keydown", (ev)=>{
        if(ev.key==="Enter"){
          ev.preventDefault();
          // Focus next reps cell
          const next = inputsR[idxR+1];
          if(next) next.focus();
          else toast("Last set");
        }
      });
    });

    card.querySelectorAll("input[data-act='note']").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const e=num(inp.getAttribute("data-e"),-1);
        sessionDraft.exercises[e].note = inp.value;
      });
    });

    box.appendChild(card);
  });

  $("fabAddExerciseToSession").classList.add("show");
}

$("btnFinishWorkout").addEventListener("click", ()=>{
  if(!sessionDraft) return;

  openModal("Finish Workout",
    `
      <div class="tiny">How did it feel?</div>
      <div class="row" style="margin-top:10px">
        <button class="mini btnGhost" id="rateEasy">Easy</button>
        <button class="mini btnGhost" id="rateNorm">Normal</button>
        <button class="mini btnGhost" id="rateHard">Hard</button>
      </div>
      <div class="sep"></div>
      <div class="tiny">Workout notes (optional)</div>
      <textarea id="sessNote" placeholder="Anything to remember‚Ä¶"></textarea>
      <div class="sep"></div>
      <div class="tiny muted">We‚Äôll save your sets, compute volume, PRs, and update next targets automatically.</div>
    `,
    "Save","Cancel",
    ()=>{
      const note = (document.getElementById("sessNote").value||"").trim();
      sessionDraft.notes = note;
      if(!sessionDraft.rating) sessionDraft.rating = "normal";

      computeSession(sessionDraft);
      state.sessions.push(sessionDraft);

      updatePRsFromSession(sessionDraft);

      for(const exLog of sessionDraft.exercises){
        const exDef = state.program.exercises[exLog.exId];
        if(exDef) applyProgression(exDef, exLog);
      }

      save();
      closeModal();
      toast("Workout saved");
      sessionDraft = null;
      setActiveTab("today");
    },
    ()=>{}
  );

  setTimeout(()=>{
    document.getElementById("rateEasy").addEventListener("click", ()=>{ sessionDraft.rating="easy"; toast("Easy"); });
    document.getElementById("rateNorm").addEventListener("click", ()=>{ sessionDraft.rating="normal"; toast("Normal"); });
    document.getElementById("rateHard").addEventListener("click", ()=>{ sessionDraft.rating="hard"; toast("Hard"); });
  }, 0);
});

$("fabAddExerciseToSession").addEventListener("click", ()=> toast("Tip: add exercises in Setup (Edit Split)"));

/* =========================
   Settings
========================= */
$("btnSettings").addEventListener("click", ()=>{
  const p = state.program;
  p.settings ||= {};
  p.settings.jump ??= 5;
  p.settings.microload ??= false;
  p.settings.repsFirstBW ??= false;

  openModal("Settings",
    `
      <div class="grid2">
        <div>
          <div class="tiny">Jump size (${p.units})</div>
          <input id="stJump" inputmode="decimal" value="${escapeAttr(p.settings.jump)}"/>
          <div class="tiny muted" style="margin-top:6px">Used for quick +/‚Äì buttons (except microload rules).</div>
        </div>
        <div>
          <div class="tiny">Microload bench/OHP</div>
          <select id="stMicro">
            <option value="off" ${p.settings.microload?"" :"selected"}>Off</option>
            <option value="on"  ${p.settings.microload?"selected":""}>On (2.5 for Bench/OHP)</option>
          </select>
          <div class="tiny muted" style="margin-top:6px">If an exercise has PR tag Bench/OHP, quick weight buttons use 2.5.</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div>
          <div class="tiny">Bodyweight reps-first</div>
          <select id="stBW">
            <option value="off" ${p.settings.repsFirstBW?"" :"selected"}>Off</option>
            <option value="on"  ${p.settings.repsFirstBW?"selected":""}>On (increase reps)</option>
          </select>
          <div class="tiny muted" style="margin-top:6px">If start weight = 0 and you succeed, targets increase reps instead of weight.</div>
        </div>
        <div>
          <div class="tiny">Edit split</div>
          <button id="goSetup" class="btnGhost" style="width:100%">Open Setup</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button id="exportBtn" class="btnGhost" style="flex:1">Download backup</button>
        <button id="importBtn" class="btnGhost" style="flex:1">Import backup</button>
      </div>

      <div class="sep"></div>

      <button id="wipeBtn" class="btnDanger" style="width:100%">Delete ALL data</button>

      <div class="tiny muted" style="margin-top:10px">
        Auto-backup is saved weekly on this device.
      </div>
    `,
    "Save","Close",
    ()=>{
      const jump = num(document.getElementById("stJump").value, 5);
      const micro = (document.getElementById("stMicro").value === "on");
      const bw = (document.getElementById("stBW").value === "on");
      state.program.settings ||= {};
      state.program.settings.jump = jump;
      state.program.settings.microload = micro;
      state.program.settings.repsFirstBW = bw;
      save();
      closeModal();
      toast("Settings saved");
      render();
    },
    ()=>{}
  );

  setTimeout(()=>{
    document.getElementById("goSetup").addEventListener("click", ()=>{
      closeModal();
      showScreen("screenSetup");
      renderSetup();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `liftlog-backup-${isoToday()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Downloaded");
    });

    document.getElementById("importBtn").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = ()=>{
        const file = input.files && input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const parsed = JSON.parse(String(reader.result||""));
            state = parsed;
            // normalize
            state.program ||= null;
            state.sessions ||= [];
            state.exerciseState ||= {};
            state.prs ||= {};
            state.ui ||= {activeTab:"today"};
            state.meta ||= {lastBackupAt:null};
            save();
            toast("Imported");
            closeModal();
            render();
          }catch{
            alert("Import failed.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    document.getElementById("wipeBtn").addEventListener("click", ()=>{
      if(confirm("Delete ALL data?")) {
        localStorage.removeItem(KEY);
        state = load();
        toast("Wiped");
        closeModal();
        render();
      }
    });
  }, 0);
});

/* =========================
   Calendar
========================= */
let calCursor = (()=>{ const d=new Date(); return { y:d.getFullYear(), m:d.getMonth() }; })();
let calSelected = null;

function monthName(y,m){
  const mons=["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${mons[m]} ${y}`;
}

function weekStartISO(iso){
  const d=new Date(iso+"T12:00:00");
  const dow=d.getDay();
  d.setDate(d.getDate()-dow);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function addDays(iso, n){
  const d=new Date(iso+"T12:00:00");
  d.setDate(d.getDate()+n);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function renderWeekStrip(){
  const start = weekStartISO(isoToday());
  const p = state.program;
  const doneMap = new Map();
  for(const s of state.sessions) doneMap.set(s.date, s);

  const box = $("weekStrip");
  box.innerHTML = "";

  for(let i=0;i<7;i++){
    const iso = addDays(start, i);
    const dow = dayOfWeek(iso);
    const plan = p?.split?.find(x=>x.weekday===dow);
    const sess = doneMap.get(iso);

    const dot = sess ? `<span class="dot ${sess.rating==='hard'?'amber':''}"></span>` : (plan ? `<span class="dot blue"></span>` : ``);
    const title = sess ? sess.workoutTitle : (plan ? plan.title : "Rest");

    const d=new Date(iso+"T12:00:00");
    const label=["S","M","T","W","T","F","S"][d.getDay()];

    const el=document.createElement("div");
    el.className="wkDay" + (iso===isoToday() ? " today" : "");
    el.innerHTML = `
      <div class="wkTop"><span>${label} ${d.getDate()}</span><span>${dot}</span></div>
      <div class="wkTitle">${escapeHtml(title||"")}</div>
    `;
    el.addEventListener("click", ()=>{
      if(sess){
        calSelected = sess.date;
        renderCalDetail(sess);
        toast("Selected");
      }else if(plan){
        renderPlannedDetail(iso, plan.title);
      }else{
        $("calDetail").innerHTML = `<div class="tiny"><b>${prettyDate(iso)}</b></div><div class="sep"></div><div class="tiny muted">Rest day.</div>`;
      }
    });
    box.appendChild(el);
  }
}

function renderPlannedDetail(iso, plannedTitle){
  $("calDetail").innerHTML = `
    <div class="tiny"><b>${prettyDate(iso)}</b> ‚Ä¢ Planned: <b>${escapeHtml(plannedTitle)}</b></div>
    <div class="sep"></div>
    <div class="row" style="gap:10px">
      <button id="startPlannedBtn" class="btnGood" style="flex:1">Start this workout</button>
      <button id="goTodayBtn" class="btnGhost" style="flex:1">Go to Today</button>
    </div>
    <div class="sep"></div>
    <div class="tiny muted">Starting this will create a draft session for that date.</div>
  `;
  setTimeout(()=>{
    const b1=document.getElementById("startPlannedBtn");
    const b2=document.getElementById("goTodayBtn");
    if(b1) b1.addEventListener("click", ()=>{
      sessionDraft = buildSessionDraftForDate(iso);
      if(!sessionDraft){ toast("No plan"); return; }
      toast("Started");
      setActiveTab("logger");
    });
    if(b2) b2.addEventListener("click", ()=> setActiveTab("today"));
  }, 0);
}

function renderCalendar(){
  $("calMonth").textContent = monthName(calCursor.y, calCursor.m);
  renderWeekStrip();

  const grid = $("calGrid");
  grid.innerHTML = "";

  const first = new Date(calCursor.y, calCursor.m, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(calCursor.y, calCursor.m+1, 0).getDate();

  const prevDays = startDow;
  const prevMonthDays = new Date(calCursor.y, calCursor.m, 0).getDate();

  const cells = [];
  for(let i=0;i<prevDays;i++){
    const dayNum = prevMonthDays - prevDays + 1 + i;
    cells.push({ off:true, day:dayNum, y: calCursor.m===0? calCursor.y-1 : calCursor.y, m: calCursor.m===0? 11 : calCursor.m-1 });
  }
  for(let d=1; d<=daysInMonth; d++){
    cells.push({ off:false, day:d, y: calCursor.y, m: calCursor.m });
  }
  while(cells.length % 7 !== 0){
    const dayNum = (cells.length - (prevDays+daysInMonth)) + 1;
    cells.push({ off:true, day:dayNum, y: calCursor.m===11? calCursor.y+1 : calCursor.y, m: calCursor.m===11? 0 : calCursor.m+1 });
  }

  const doneMap = new Map();
  for(const s of state.sessions){
    doneMap.set(s.date, s);
  }

  const plannedMap = new Map();
  const p = state.program;
  if(p?.split?.length){
    for(const c of cells){
      if(c.off) continue;
      const mm = String(c.m+1).padStart(2,"0");
      const dd = String(c.day).padStart(2,"0");
      const iso = `${c.y}-${mm}-${dd}`;
      const dow = new Date(iso+"T12:00:00").getDay();
      const plan = p.split.find(x => x.weekday === dow);
      if(plan) plannedMap.set(iso, plan.title);
    }
  }

  const filter = $("calFilter")?.value || "both";

  for(const c of cells){
    const mm = String(c.m+1).padStart(2,"0");
    const dd = String(c.day).padStart(2,"0");
    const iso = `${c.y}-${mm}-${dd}`;

    const sess = doneMap.get(iso);
    const plannedTitle = plannedMap.get(iso);

    const showDone = !!sess;
    const showPlanned = !!plannedTitle && !sess;

    if(!c.off){
      if(filter==="done" && !showDone) {
        // still render but no dot/title (keeps grid shape)
      }
      if(filter==="planned" && !(plannedTitle)) {
        // still render but no dot/title
      }
    }

    const cell=document.createElement("div");
    cell.className = "calCell" + (c.off ? " off" : "");

    let dotHtml = "";
    if(showDone && (filter==="both" || filter==="done")){
      dotHtml = `<span class="dot ${sess.rating==='hard'?'amber':''}"></span>`;
    } else if(showPlanned && (filter==="both" || filter==="planned")){
      dotHtml = `<span class="dot blue"></span>`;
    }

    const title =
      (showDone && (filter==="both" || filter==="done")) ? sess.workoutTitle :
      (showPlanned && (filter==="both" || filter==="planned")) ? plannedTitle :
      "";

    cell.innerHTML = `
      <div class="calNum">
        <span>${c.day}</span>
        <span>${dotHtml}</span>
      </div>
      <div class="calTitle">${title ? escapeHtml(title) : ""}</div>
    `;

    if(!c.off){
      cell.addEventListener("click", ()=>{
        if(sess){
          calSelected = sess.date;
          renderCalDetail(sess);
        } else if(plannedTitle){
          renderPlannedDetail(iso, plannedTitle);
        } else {
          $("calDetail").innerHTML = `<div class="tiny"><b>${prettyDate(iso)}</b></div><div class="sep"></div><div class="tiny muted">Rest day.</div>`;
        }
      });
    }

    grid.appendChild(cell);
  }

  if(calSelected){
    const sess = doneMap.get(calSelected);
    if(sess) renderCalDetail(sess);
  }
}

function renderCalDetail(sess){
  const p = state.program;
  const units = p?.units || "lb";
  const prMsgs = getPRMessages(sess);

  const exLines = sess.exercises.map(exLog=>{
    const ex = p?.exercises?.[exLog.exId];
    const name = ex ? ex.name : exLog.exId;
    const setsStr = exLog.sets.map((s,i)=>`${i+1}:${num(s.w,0)}x${num(s.r,0)}`).join("  ");
    return `<div class="item">
      <div>
        <div class="name">${escapeHtml(name)}</div>
        <div class="tiny muted">${escapeHtml(setsStr)}</div>
      </div>
    </div>`;
  }).join("");

  $("calDetail").innerHTML = `
    <div class="tiny"><b>${prettyDate(sess.date)}</b> ‚Ä¢ ${escapeHtml(sess.workoutTitle)} ‚Ä¢ <span class="badge ${sess.rating==='hard'?'hard':'good'}">${escapeHtml(sess.rating)}</span></div>
    <div class="sep"></div>
    <div class="tiny">Volume: <b>${sess.computed?.volume ?? 0}</b> ${units}</div>
    <div class="tiny">PRs: ${prMsgs.length ? prMsgs.map(m=>`<span class="badge good">${escapeHtml(m)}</span>`).join(" ") : `<span class="muted">none</span>`}</div>
    <div class="sep"></div>
    <div class="list" style="margin-top:0">
      <div class="listHeader"><span>Logged</span><span class="tiny">sets</span></div>
      ${exLines}
    </div>
    ${sess.notes ? `<div class="sep"></div><div class="tiny muted">${escapeHtml(sess.notes)}</div>` : ""}
  `;
}

function getPRMessages(sess){
  const msgs=[];
  for(const exLog of sess.exercises){
    const exId = exLog.exId;
    const pr = state.prs[exId];
    if(pr?.bestE1RM?.date === sess.date) msgs.push("New e1RM PR");
    if(pr?.bestWeight?.date === sess.date) msgs.push("New Weight PR");
    if(pr?.bestVolume?.date === sess.date) msgs.push("New Volume PR");
  }
  return [...new Set(msgs)];
}

$("calPrev").addEventListener("click", ()=>{
  calCursor.m -= 1;
  if(calCursor.m<0){ calCursor.m=11; calCursor.y-=1; }
  render();
});
$("calNext").addEventListener("click", ()=>{
  calCursor.m += 1;
  if(calCursor.m>11){ calCursor.m=0; calCursor.y+=1; }
  render();
});
$("calFilter").addEventListener("change", ()=> render());

/* =========================
   PRs (BY TAG)
========================= */
function renderPRs(){
  const p = state.program;
  if(!p){ $("prSummary").textContent="Finish setup first."; return; }

  const days = num($("prWindow")?.value, 30);
  const endIso = isoToday();
  const end = new Date(endIso + "T12:00:00");

  let startIso = "0000-01-01";
  if(days !== 99999){
    const start = new Date(end);
    start.setDate(start.getDate() - (days - 1));
    startIso = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,"0")}-${String(start.getDate()).padStart(2,"0")}`;
  }

  // Collect exercises by tag
  const exByTag = {};
  for(const exId of Object.keys(p.exercises||{})){
    const ex = p.exercises[exId];
    const tag = ex.prTag || "none";
    if(tag==="none") continue;
    exByTag[tag] ||= [];
    exByTag[tag].push({exId, name: ex.name});
  }

  function collect(tag){
    const inWindow = [];
    const before = [];

    for(const sess of (state.sessions || [])){
      if(!sess.exercises) continue;

      for(const exLog of sess.exercises){
        const exDef = p.exercises?.[exLog.exId];
        if(!exDef) continue;
        if((exDef.prTag||"none") !== tag) continue;

        for(const st of (exLog.sets || [])){
          const w = num(st.w,0), r = num(st.r,0);
          if(w<=0 || r<=0) continue;
          const row = { date: sess.date, w, r, e1rm: e1rmEpley(w,r), exName: exDef.name };
          if(sess.date >= startIso && sess.date <= endIso) inWindow.push(row);
          else if(sess.date < startIso) before.push(row);
        }
      }
    }
    return { inWindow, before };
  }

  function bestStats(rows){
    let bestE = 0, bestERow=null;
    let heavyW = 0, heavyRow=null;
    let bestRepsAtHeavyW = 0;

    for(const x of rows){
      if(x.e1rm > bestE){ bestE = x.e1rm; bestERow = x; }
      if(x.w > heavyW){ heavyW = x.w; heavyRow = x; bestRepsAtHeavyW = x.r; }
      else if(x.w === heavyW){ bestRepsAtHeavyW = Math.max(bestRepsAtHeavyW, x.r); }
    }
    return { bestE, bestERow, heavyW, heavyRow, bestRepsAtHeavyW };
  }

  function pctChange(newVal, oldVal){
    if(newVal<=0 || oldVal<=0) return null;
    return ((newVal-oldVal)/oldVal)*100;
  }

  const order = ["bench","squat","deadlift","ohp","row","pullup"];
  const tagsToShow = order.filter(t=>exByTag[t]?.length).concat(Object.keys(exByTag).filter(t=>!order.includes(t)));

  let cardsHtml = "";
  let history = [];

  for(const tag of tagsToShow){
    const label = PR_TAGS.find(x=>x.v===tag)?.t || tag;
    const { inWindow, before } = collect(tag);
    inWindow.sort((a,b)=> a.date.localeCompare(b.date));
    before.sort((a,b)=> a.date.localeCompare(b.date));

    const win = bestStats(inWindow);
    const prev = bestStats(before);

    let prPctStr = "‚Äî";
    const prPct = pctChange(win.bestE, prev.bestE);
    if(win.bestE > 0 && prev.bestE > 0){
      prPctStr = `${prPct>=0?"+":""}${prPct.toFixed(1)}%`;
    } else if(win.bestE > 0 && prev.bestE === 0){
      prPctStr = "NEW";
    }

    const bestE1rmTxt = win.bestE ? `${Math.round(win.bestE)} e1RM` : "‚Äî";
    const bestE1rmDate = win.bestERow ? prettyDate(win.bestERow.date) : "‚Äî";
    const bestE1rmName = win.bestERow ? win.bestERow.exName : "‚Äî";

    const heavyTxt = win.heavyW ? `${win.heavyW} √ó ${win.bestRepsAtHeavyW}` : "‚Äî";
    const heavyDate = win.heavyRow ? prettyDate(win.heavyRow.date) : "‚Äî";
    const heavyName = win.heavyRow ? win.heavyRow.exName : "‚Äî";

    // PR history (e1RM) per tag across all time
    const all = [...before, ...inWindow].sort((a,b)=> a.date.localeCompare(b.date));
    let bestSoFar = 0;
    for(const x of all){
      if(x.e1rm > bestSoFar){
        bestSoFar = x.e1rm;
        history.push({
          date: x.date,
          text: `${label}: New e1RM PR ${Math.round(x.e1rm)} (${x.exName}: ${x.w}√ó${x.r})`
        });
      }
    }

    cardsHtml += `
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">${escapeHtml(label)}</div>
            <div class="tiny muted">Exercises tagged: ${exByTag[tag].length}</div>
          </div>
          <div class="right">
            <span class="pill">PR change: <b>${prPctStr}</b></span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="gap:10px;flex-wrap:wrap">
          <span class="pill">Best e1RM: <b>${bestE1rmTxt}</b> <span class="tiny muted">(${bestE1rmDate})</span></span>
          <span class="pill">Lift: <b>${escapeHtml(bestE1rmName)}</b></span>
        </div>

        <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:8px">
          <span class="pill">Heaviest set: <b>${heavyTxt}</b> <span class="tiny muted">(${heavyDate})</span></span>
          <span class="pill">Lift: <b>${escapeHtml(heavyName)}</b></span>
        </div>

        <div class="tiny muted" style="margin-top:8px">PRs are computed from your best set (Epley e1RM).</div>
      </div>
    `;
  }

  if(!tagsToShow.length){
    $("prCards").innerHTML = `<div class="card" style="margin-top:12px"><div class="tiny muted">No PR tags yet. Go to Setup and tag your Bench/Squat/etc.</div></div>`;
    $("prSummary").textContent = "No tagged PR exercises yet.";
  }else{
    $("prCards").innerHTML = cardsHtml;
    const label = days===7?"this week":days===30?"this month":days===365?"this year":"all time";
    $("prSummary").textContent = `Showing tagged PRs (${label}).`;
  }

  history.sort((a,b)=> b.date.localeCompare(a.date));
  if(history.length){
    $("prHistory").innerHTML = history
      .slice(0, 25)
      .map(h => `<div class="row" style="justify-content:space-between;gap:12px">
        <span>${escapeHtml(h.text)}</span>
        <span class="tiny muted">${prettyDate(h.date)}</span>
      </div>`)
      .join(`<div class="sep"></div>`);
  } else {
    $("prHistory").textContent = "No PRs yet ‚Äî once you log sets, PR history will appear here.";
  }
}

/* =========================
   Progress screen (last 3 sessions + % + lbs)
========================= */
function renderProgress(){
  const p = state.program;
  const box = $("progList");
  box.innerHTML = "";

  if(!p){
    box.innerHTML = `<div class="item"><div class="tiny muted">Finish setup first.</div></div>`;
    return;
  }

  const exIds = Object.keys(p.exercises || {});
  if(!exIds.length){
    box.innerHTML = `<div class="item"><div class="tiny muted">No exercises.</div></div>`;
    return;
  }

  const days = num($("progWindow")?.value, 30);

  const endIso = isoToday();
  const end = new Date(endIso + "T12:00:00");
  const start = new Date(end);
  start.setDate(start.getDate() - (days - 1));
  const startIso = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,"0")}-${String(start.getDate()).padStart(2,"0")}`;

  function bestFromExLog(exLog){
    let bestE=0;
    let bestSet=null; // {w,r}
    for(const s of exLog.sets || []){
      const w = num(s.w,0), r = num(s.r,0);
            const w = num(s.w,0), r = num(s.r,0);
      if(w<=0 || r<=0) continue;
      const e = e1rmEpley(w,r);
      if(e > bestE){
        bestE = e;
        bestSet = { w, r, e1rm: e };
      }
    }
    return bestSet;
  }

  function lastNSessionsForExercise(exId, n, startIso, endIso){
    const rows = [];
    for(const s of (state.sessions||[])){
      if(s.date < startIso || s.date > endIso) continue;
      for(const exLog of (s.exercises||[])){
        if(exLog.exId !== exId) continue;
        const best = bestFromExLog(exLog);
        if(best){
          rows.push({ date: s.date, best, workoutTitle: s.workoutTitle });
        }
      }
    }
    rows.sort((a,b)=> b.date.localeCompare(a.date));
    return rows.slice(0,n);
  }

  function bestBeforeWindow(exId, startIso){
    let bestE = 0;
    let bestRow = null;
    for(const s of (state.sessions||[])){
      if(s.date >= startIso) continue;
      for(const exLog of (s.exercises||[])){
        if(exLog.exId !== exId) continue;
        const best = bestFromExLog(exLog);
        if(best && best.e1rm > bestE){
          bestE = best.e1rm;
          bestRow = { date:s.date, best };
        }
      }
    }
    return bestRow; // {date, best:{w,r,e1rm}} or null
  }

  function pctChange(newVal, oldVal){
    if(!newVal || !oldVal) return null;
    if(oldVal<=0) return null;
    return ((newVal-oldVal)/oldVal)*100;
  }

  // Summary: average e1RM change across all exercises that have any data in window
  let sumPct = 0, countPct = 0, newPRs = 0;

  for(const exId of exIds){
    const ex = p.exercises[exId];
    const recent = lastNSessionsForExercise(exId, 1, startIso, endIso);
    if(!recent.length) continue;

    const newest = recent[0].best.e1rm;
    const prev = bestBeforeWindow(exId, startIso);
    const prevE = prev ? prev.best.e1rm : 0;

    const prAll = state.prs?.[exId]?.bestE1RM;
    if(prAll?.date && prAll.date >= startIso && prAll.date <= endIso) newPRs++;

    const pct = pctChange(newest, prevE);
    if(pct !== null){
      sumPct += pct;
      countPct++;
    }
  }

  const windowLabel = days===7 ? "last 7 days" : days===30 ? "last 30 days" : days===365 ? "last 365 days" : `last ${days} days`;
  const avgPct = countPct ? (sumPct/countPct) : null;

  $("progSummary").innerHTML =
    `Compared to before this window (${escapeHtml(windowLabel)}): ` +
    (avgPct===null ? `<b>Not enough data yet</b>` : `<b>${avgPct>=0?"+":""}${avgPct.toFixed(1)}%</b> average e1RM change`) +
    ` ‚Ä¢ New PRs: <b>${newPRs}</b>`;

  // Render each exercise row
  for(const exId of exIds){
    const ex = p.exercises[exId];
    const recent3 = lastNSessionsForExercise(exId, 3, startIso, endIso);
    if(!recent3.length) continue;

    const newest = recent3[0].best.e1rm;
    const prev = bestBeforeWindow(exId, startIso);
    const prevE = prev ? prev.best.e1rm : 0;

    const pct = pctChange(newest, prevE);
    const pctTxt = (pct===null)
      ? (prevE===0 ? "NEW" : "‚Äî")
      : `${pct>=0?"+":""}${pct.toFixed(1)}%`;

    const lastLines = recent3.map(r=>{
      const setTxt = `${r.best.w}√ó${r.best.r} (e1RM ${Math.round(r.best.e1rm)})`;
      return `<div class="tiny muted">${escapeHtml(prettyDate(r.date))}: ${escapeHtml(setTxt)}</div>`;
    }).join("");

    const tag = ex.prTag && ex.prTag!=="none" ? (PR_TAGS.find(x=>x.v===ex.prTag)?.t || "PR") : "";
    const tagBadge = tag ? `<span class="badge blue">${escapeHtml(tag)}</span>` : "";

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div>
        <div class="name">${escapeHtml(ex.name)} ${tagBadge}</div>
        <div class="tiny">Change: <b>${escapeHtml(pctTxt)}</b> ‚Ä¢ Latest e1RM: <b>${Math.round(newest)}</b></div>
        <div style="margin-top:6px">${lastLines}</div>
      </div>
      <div class="right">
        <button class="mini btnGhost" data-ex="${exId}">View</button>
      </div>
    `;
    row.querySelector("button").addEventListener("click", ()=>{
      // jump to PRs tab and set window to "All time" to see it
      $("prWindow").value = "99999";
      setActiveTab("prs");
    });
    box.appendChild(row);
  }

  if(!box.children.length){
    box.innerHTML = `<div class="item"><div class="tiny muted">No logs in this window yet.</div></div>`;
  }
}

/* =========================
   Tabs + Router
========================= */
function renderTabs(){
  tabEl("tabToday", state.ui.activeTab==="today");
  tabEl("tabLogger", state.ui.activeTab==="logger");
  tabEl("tabCalendar", state.ui.activeTab==="calendar");
  tabEl("tabProgress", state.ui.activeTab==="progress");
  tabEl("tabPRs", state.ui.activeTab==="prs");
}

$("tabToday").addEventListener("click", ()=> setActiveTab("today"));
$("tabLogger").addEventListener("click", ()=>{
  // If no active draft, start today's if possible; otherwise show hint
  if(!sessionDraft){
    const info = plannedWorkoutForToday();
    if(info?.plan && (info.plan.exercises||[]).length){
      sessionDraft = buildSessionDraftForDate(isoToday());
    }
  }
  setActiveTab("logger");
});
$("tabCalendar").addEventListener("click", ()=> setActiveTab("calendar"));
$("tabProgress").addEventListener("click", ()=> setActiveTab("progress"));
$("tabPRs").addEventListener("click", ()=> setActiveTab("prs"));

$("prWindow").addEventListener("change", ()=> render());
$("progWindow").addEventListener("change", ()=> render());

/* =========================
   Boot / render
========================= */
function render(){
  renderTabs();

  // If no program, show setup always
  if(!state.program){
    showScreen("screenSetup");
    renderSetup();
    return;
  }

  if(state.ui.activeTab==="today"){
    showScreen("screenToday");
    renderToday();
  } else if(state.ui.activeTab==="logger"){
    showScreen("screenLogger");
    renderLogger();
  } else if(state.ui.activeTab==="calendar"){
    showScreen("screenCalendar");
    renderCalendar();
  } else if(state.ui.activeTab==="progress"){
    showScreen("screenProgress");
    renderProgress();
  } else if(state.ui.activeTab==="prs"){
    showScreen("screenPRs");
    renderPRs();
  } else {
    showScreen("screenToday");
    renderToday();
  }
}

// If setup exists but startWeekDate empty, patch
if(state.program){
  state.program.startWeekDate ||= defaultMonday();
  state.program.settings ||= {jump:5, microload:false, repsFirstBW:false};
  save();
}

// Initial render
render();

/* =========================
   Safe HTML helpers
========================= */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){ return escapeHtml(s); }
</script>
</body>
</html>
