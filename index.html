<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#070712"/>
  <title>LiftLog AI</title>

  <style>
    :root{
      /* New purple / teal theme */
      --bg:#05040b;
      --panel:#0c0b18;
      --card:#131126;
      --line:rgba(255,255,255,.10);
      --text:#f5f4ff;
      --muted:rgba(220,218,255,.70);

      --accent:#b772ff;    /* purple */
      --accent2:#5be6ff;   /* teal pop */
      --danger:#ff6b81;
      --warn:#ffbf5a;

      --shadow:0 18px 40px rgba(0,0,0,.5);
      --radius:18px;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{
      margin:0;background:radial-gradient(circle at top,#15122a 0,#05040b 55%);
      color:var(--text);
      padding-top:env(safe-area-inset-top);
      padding-bottom:calc(72px + env(safe-area-inset-bottom));
    }
    .app{max-width:560px;margin:0 auto}

    .topbar{
      position:sticky;top:0;z-index:20;
      background:rgba(7,6,18,.9);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
    }
    .navrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-size:17px;font-weight:850;text-align:center;flex:1;letter-spacing:.04em}
    .pill{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;border-radius:999px;
      background:linear-gradient(120deg,rgba(183,114,255,.2),rgba(91,230,255,.12));
    }
    .content{padding:12px}
    .card{
      background:radial-gradient(circle at top left,rgba(183,114,255,.16),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(91,230,255,.12),transparent 60%),
                 linear-gradient(180deg,rgba(16,15,38,.96),rgba(7,7,18,.96));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
    }
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}

    button,input,select,textarea{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,9,24,.85);
      color:var(--text);
      border-radius:14px;padding:10px 12px;font-size:14px;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(183,114,255,.8);
      box-shadow:0 0 0 2px rgba(183,114,255,.35);
      background:rgba(16,14,40,.95);
    }
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer;transition:.12s transform,.12s box-shadow}
    button:active{transform:scale(.985)}
    .btnAccent{
      background:linear-gradient(120deg,#b772ff,#5be6ff);
      border:none;color:#05040b;
      box-shadow:0 12px 30px rgba(92,230,255,.35);
    }
    .btnDanger{background:rgba(255,107,129,.14);border-color:rgba(255,107,129,.5);}
    .btnGhost{background:rgba(255,255,255,.06);}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}

    .list{margin-top:12px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--line);background:rgba(6,5,18,.9);}
    .listHeader{padding:10px 12px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,.04);}
    .item:last-child{border-bottom:none}
    .name{font-weight:850}
    .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
    .mini{padding:7px 9px;border-radius:12px;font-size:12px}

    .sep{height:1px;background:rgba(255,255,255,.09);margin:12px 0}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:rgba(255,255,255,.03)}
    .badge.good{border-color:rgba(91,230,255,.7);color:var(--accent2);background:rgba(91,230,255,.13);}
    .badge.hard{border-color:rgba(255,191,90,.7);color:var(--warn);background:rgba(255,191,90,.12);}
    .badge.tag{border-color:rgba(183,114,255,.7);color:rgba(222,206,255,.95);background:rgba(183,114,255,.14);}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:700;font-size:12px}
    .chk{width:22px;height:22px;border-radius:9px;border:1px solid var(--line);display:grid;place-items:center;font-size:13px}
    .chk.on{border-color:rgba(91,230,255,.8);background:rgba(91,230,255,.15);color:var(--accent2);font-weight:900}

    .tabs{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background:rgba(3,3,10,.96);
      backdrop-filter:blur(16px);
      border-top:1px solid rgba(255,255,255,.12);
      padding:8px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .tabsInner{max-width:560px;margin:0 auto;display:flex;justify-content:space-around;align-items:center;gap:10px}
    .tab{display:flex;flex-direction:column;align-items:center;gap:4px;color:rgba(220,218,255,.6);font-size:11px;cursor:pointer;user-select:none}
    .tab.active{color:var(--accent2)}
    .icon{
      width:26px;height:26px;border-radius:11px;border:1px solid rgba(255,255,255,.14);
      display:grid;place-items:center;font-weight:900;font-size:12px;
      background:radial-gradient(circle at top,rgba(183,114,255,.4),rgba(7,7,18,1));
    }
    .tab.active .icon{
      border-color:rgba(91,230,255,.9);
      box-shadow:0 0 0 2px rgba(91,230,255,.35) inset;
    }

    .screen{display:none}
    .screen.show{display:block}

    .fab{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:calc(18px + env(safe-area-inset-bottom) + 44px);
      width:62px;height:62px;border-radius:999px;
      background:radial-gradient(circle at top,#ffffff,#b772ff);
      box-shadow:0 18px 40px rgba(183,114,255,.55);
      border:none;color:#120f2a;font-size:34px;
      display:none;place-items:center;z-index:40;
    }
    .fab.show{display:grid}

    .calHead{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .calCell{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:8px;
      min-height:72px;
      background:rgba(12,10,32,.96);
      cursor:pointer;
      overflow:hidden;
      display:flex;flex-direction:column;gap:6px;
    }
    .calCell.off{opacity:.25;cursor:default}
    .calNum{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent2);display:inline-block}
    .dot.warn{background:var(--warn)}
    .dot.plan{background:rgba(183,114,255,.95)}
    .calTitle{
      font-size:11px;color:var(--text);opacity:.9;
      line-height:1.2;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;
      -webkit-line-clamp:2;white-space:normal;word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }

    .weekStrip{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .wkDay{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:8px;min-height:54px;
      background:rgba(12,10,32,.96);
      display:flex;flex-direction:column;gap:6px;
      cursor:pointer;overflow:hidden;
    }
    .wkTop{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted)}
    .wkTitle{
      font-size:11px;opacity:.9;overflow:hidden;
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      line-height:1.2;white-space:normal;word-break:break-word;
      min-height: calc(11px * 1.2 * 2);
    }
    .wkDay.today{border-color:rgba(91,230,255,.9);box-shadow:0 0 0 2px rgba(91,230,255,.45) inset;}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:60;align-items:flex-end;justify-content:center;padding:14px;}
    .overlay.show{display:flex}
    .sheet{width:min(560px,100%);background:rgba(8,7,20,.98);border:1px solid rgba(255,255,255,.14);border-radius:22px;box-shadow:var(--shadow);padding:14px;}
    .sheet h3{margin:4px 2px 10px;font-size:16px}

    .toast{
      position:fixed;left:50%;bottom:calc(82px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      background:rgba(8,7,20,.97);
      border:1px solid rgba(91,230,255,.6);
      padding:10px 12px;border-radius:999px;font-size:12px;color:var(--text);
      opacity:0;pointer-events:none;transition:.18s;z-index:80
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">

  <!-- SETUP -->
  <div id="screenSetup" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Setup</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="tiny">
          Tell the app your split once. The AI will adjust reps and loads every session.
        </div>
        <div class="sep"></div>

        <div class="grid2">
          <div>
            <div class="tiny">Units</div>
            <select id="setUnits">
              <option value="lb">lbs</option>
              <option value="kg">kg</option>
            </select>
          </div>
          <div>
            <div class="tiny">Start week date (Monday)</div>
            <input id="setStartWeek" placeholder="YYYY-MM-DD"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">Your split</div>
            <div class="tiny" id="setupProgress">0 days • 0 exercises</div>
          </div>
          <button id="btnAddDay" class="btnAccent">+ Day</button>
        </div>

        <div id="daysBox" class="list" style="margin-top:10px">
          <div class="listHeader"><span>Days</span><span class="tiny">tap to manage</span></div>
          <div id="daysList"></div>
        </div>

        <div class="sep"></div>
        <button id="btnFinishSetup" class="btnAccent" style="width:100%">Save split</button>
        <div class="tiny" style="margin-top:10px">
          Tip: If Today shows Rest, you probably did not add a day for that weekday.
        </div>
      </div>
    </div>
  </div>

  <!-- TODAY -->
  <div id="screenToday" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Today</div>
        <button id="btnEditSplitToday" class="btnGhost" style="width:80px">Split</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="todayTitle">—</div>
            <div class="tiny" id="todaySub">—</div>
          </div>
          <span class="pill" id="todayDatePill">—</span>
        </div>

        <div class="sep"></div>
        <div id="todayBox" class="tiny muted">—</div>

        <div class="sep"></div>
        <div class="row" style="gap:10px">
          <button id="btnStartWorkout" class="btnAccent" style="flex:1">Start workout</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">This week</div>
        <div class="sep"></div>
        <div class="grid2">
          <div class="tiny">Planned: <b id="stPlanned">0</b></div>
          <div class="tiny">Completed: <b id="stDone">0</b></div>
          <div class="tiny">Streak: <b id="stStreak">0</b></div>
          <div class="tiny">Total: <b id="stTotal">0</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGGER -->
  <div id="screenLogger" class="screen">
    <div class="topbar">
      <div class="navrow">
        <button id="btnBackToday" class="btnGhost" style="width:80px">Back</button>
        <div class="title" id="loggerTitle">Log</div>
        <button id="btnFinishWorkout" class="btnAccent" style="width:110px">Finish</button>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name" id="loggerName">—</div>
            <div class="tiny" id="loggerMeta">—</div>
          </div>
          <span class="pill" id="loggerDate">—</span>
        </div>
        <div class="sep"></div>
        <div class="tiny">AI will bump or deload weights based on how you hit the target reps.</div>
      </div>

      <div id="loggerExercises"></div>
    </div>
    <button class="fab" id="fabAddExerciseToSession">+</button>
  </div>

  <!-- CALENDAR -->
  <div id="screenCalendar" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Calendar</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="calHead">
          <button id="calPrev" class="btnGhost">‹</button>
          <div class="name" id="calMonth">—</div>
          <button id="calNext" class="btnGhost">›</button>
        </div>

        <div class="sep"></div>

        <div class="tiny muted">This week</div>
        <div class="weekStrip" id="weekStrip"></div>

        <div class="sep"></div>

        <div class="calGrid tiny muted" style="margin-top:0">
          <div style="text-align:center">S</div><div style="text-align:center">M</div><div style="text-align:center">T</div>
          <div style="text-align:center">W</div><div style="text-align:center">T</div><div style="text-align:center">F</div><div style="text-align:center">S</div>
        </div>
        <div class="calGrid" id="calGrid"></div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="name">Selected day</div>
        <div class="sep"></div>
        <div id="calDetail" class="tiny muted">Tap a day.</div>
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="screenProgress" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">Progress</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">Strength change</div>
            <div class="tiny muted">Estimated 1RM + best sets.</div>
          </div>
          <div class="right">
            <select id="progWindow">
              <option value="7">Week</option>
              <option value="30" selected>Month</option>
              <option value="365">Year</option>
            </select>
          </div>
        </div>
        <div class="sep"></div>
        <div id="progSummary" class="tiny muted">—</div>
      </div>

      <div class="list">
        <div class="listHeader"><span>Exercises</span><span class="tiny">last 3 + change</span></div>
        <div id="progList"></div>
      </div>
    </div>
  </div>

  <!-- PRs -->
  <div id="screenPRs" class="screen">
    <div class="topbar">
      <div class="navrow">
        <div style="width:80px"></div>
        <div class="title">PRs</div>
        <div style="width:80px"></div>
      </div>
    </div>
    <div class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">PRs</div>
            <div class="tiny muted">Uses PR tags (Bench/Squat/etc.).</div>
          </div>
        </div>
        <div class="sep"></div>
        <div id="prSummary" class="tiny muted">—</div>
      </div>

      <div id="prCards"></div>

      <div class="card" style="margin-top:12px">
        <div class="name">PR history</div>
        <div class="sep"></div>
        <div id="prHistory" class="tiny muted">—</div>
      </div>
    </div>
  </div>

</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tabsInner">
    <div class="tab" id="tabToday"><div class="icon">H</div><div>Home</div></div>
    <div class="tab" id="tabLogger"><div class="icon">L</div><div>Log</div></div>
    <div class="tab" id="tabCalendar"><div class="icon">C</div><div>Cal</div></div>
    <div class="tab" id="tabProgress"><div class="icon">P</div><div>Prog</div></div>
    <div class="tab" id="tabPRs"><div class="icon">R</div><div>PR</div></div>
  </div>
</div>

<!-- Modal + toast -->
<div class="overlay" id="overlay">
  <div class="sheet" id="sheet">
    <h3 id="sheetTitle">—</h3>
    <div id="sheetBody"></div>
    <div class="row" style="margin-top:12px">
      <button id="sheetOk" class="btnAccent" style="flex:1">OK</button>
      <button id="sheetCancel" class="btnDanger" style="flex:1">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* ===== Storage + helpers ===== */
const KEY="liftlog_ai_v1";
const AUTO_BACKUP_KEY="liftlog_ai_autobackup";
const $=id=>document.getElementById(id);

function toast(msg="Saved"){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  if(navigator.vibrate) navigator.vibrate(10);
  setTimeout(()=>t.classList.remove("show"),900);
}
function isoToday(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function dayOfWeek(iso){
  const d=new Date(iso+"T12:00:00");
  return d.getDay();
}
function prettyDate(iso){
  const d=new Date(iso+"T12:00:00");
  const days=["SUN","MON","TUE","WED","THU","FRI","SAT"];
  const mons=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  return `${days[d.getDay()]}, ${d.getDate()} ${mons[d.getMonth()]} ${d.getFullYear()}`;
}
function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
function num(x,fb=0){ const n=Number(x); return Number.isFinite(n)?n:fb; }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){ return escapeHtml(s); }

function load(){
  try{
    const raw=localStorage.getItem(KEY);
    if(!raw) throw 0;
    const s=JSON.parse(raw);
    s.program ||= null;
    s.sessions ||= [];
    s.exerciseState ||= {};
    s.prs ||= {};
    s.ui ||= {activeTab:"today"};
    s.meta ||= {lastBackupAt:null};
    return s;
  }catch{
    return {program:null,sessions:[],exerciseState:{},prs:{},ui:{activeTab:"today"},meta:{lastBackupAt:null}};
  }
}
function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

function maybeAutoBackup(){
  const now=Date.now();
  const last=state.meta?.lastBackupAt ? Number(state.meta.lastBackupAt) : 0;
  const weekMs=7*24*60*60*1000;
  if(!last || (now-last)>weekMs){
    try{
      localStorage.setItem(AUTO_BACKUP_KEY,JSON.stringify({at:now,state}));
      state.meta ||= {};
      state.meta.lastBackupAt=now;
      save();
    }catch{}
  }
}

let state=load();
maybeAutoBackup();

/* ===== lightweight DOM cache ===== */
const EL = {
  overlay: $("overlay"),
  sheetBody: $("sheetBody"),
  sheetTitle: $("sheetTitle"),
  sheetOk: $("sheetOk"),
  sheetCancel: $("sheetCancel"),
  toast: $("toast"),
  daysList: $("daysList"),
  loggerExercises: $("loggerExercises")
};

/* ===== UI routing ===== */
function tabEl(id,active){
  const el=$(id); if(!el) return;
  el.classList.toggle("active",active);
}
function showScreen(id){
  ["screenSetup","screenToday","screenLogger","screenCalendar","screenProgress","screenPRs"].forEach(s=>{
    const el=$(s); if(!el) return;
    el.classList.toggle("show",s===id);
  });
}
function setActiveTab(tab){
  state.ui.activeTab=tab;
  save();
  render();
}

/* ===== Modal helpers ===== */
let modal={onOk:null,onCancel:null};
function openModal(title,bodyHtml,okText="OK",cancelText="Cancel",onOk=null,onCancel=null){
  $("sheetTitle").textContent=title;
  $("sheetBody").innerHTML=bodyHtml;
  $("sheetOk").textContent=okText;
  $("sheetCancel").textContent=cancelText;
  modal.onOk=onOk;
  modal.onCancel=onCancel;
  EL.overlay.classList.add("show");
}
function closeModal(){
  EL.overlay.classList.remove("show");
  modal.onOk=null; modal.onCancel=null;
}
EL.overlay.addEventListener("click",e=>{ if(e.target===EL.overlay) closeModal(); });
EL.sheetOk.addEventListener("click",()=>{ if(modal.onOk) modal.onOk(); else closeModal(); });
EL.sheetCancel.addEventListener("click",()=>{ if(modal.onCancel) modal.onCancel(); closeModal(); });

/* ===== Setup screen ===== */
function normalizeProgram(){
  const p=state.program || {units:"lb",startWeekDate:defaultMonday(),split:[],exercises:{},settings:{jump:5,microload:false,repsFirstBW:false}};
  p.split ||= [];
  p.exercises ||= {};
  p.settings ||= {jump:5,microload:false,repsFirstBW:false};
  p.settings.jump ??= 5;
  p.settings.microload ??= false;
  p.settings.repsFirstBW ??= false;
  return p;
}
function countSetupProgress(p){
  const days=(p.split||[]).length;
  let exTotal=0;
  for(const d of (p.split||[])) exTotal+=(d.exercises||[]).length;
  return {days,exTotal};
}
function renderSetup(){
  const p=normalizeProgram();
  $("setUnits").value=p.units || "lb";
  $("setStartWeek").value=p.startWeekDate || defaultMonday();
  const {days,exTotal}=countSetupProgress(p);
  $("setupProgress").textContent=`${days} day(s) • ${exTotal} exercise(s)`;

  const list=$("daysList");
  list.innerHTML="";
  if(!p.split.length){
    list.innerHTML=`<div class="item"><div class="tiny muted">No days yet. Tap “+ Day”.</div></div>`;
  }else{
    p.split.forEach(day=>{
      const exCount=(day.exercises||[]).length;
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div>
          <div class="name">${escapeHtml(WEEKDAYS[day.weekday])} — ${escapeHtml(day.title)}</div>
          <div class="tiny muted">${exCount} exercise(s)</div>
        </div>
        <div class="right">
          <button class="mini btnGhost" data-act="up" data-id="${day.id}">↑</button>
          <button class="mini btnGhost" data-act="dn" data-id="${day.id}">↓</button>
          <button class="mini btnGhost" data-act="editDay" data-id="${day.id}">Edit</button>
          <button class="mini btnAccent" data-act="addEx" data-id="${day.id}">+ Ex</button>
          <button class="mini btnDanger" data-act="delDay" data-id="${day.id}">Del</button>
        </div>`;
      list.appendChild(div);

      const exDiv=document.createElement("div");
      exDiv.style.padding="0 12px 10px";
      exDiv.innerHTML=(day.exercises||[]).map(exId=>{
        const ex=p.exercises[exId];
        if(!ex) return "";
        const tgt=ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const rule=ex.rule?.type || "double";
        const ruleTxt=rule==="double" ? `Range + load` :
                      rule==="fixed"  ? `Weekly +${ex.rule.inc||5}` :
                                        `+${ex.rule.pct||2.5}%`;
        const tag=ex.prTag && ex.prTag!=="none" ? PR_TAGS.find(x=>x.v===ex.prTag)?.t : "";
        const tagBadge=tag ? `<span class="badge tag">${escapeHtml(tag)}</span>` : "";
        return `
          <div class="item" style="border-radius:14px;margin-top:8px;background:rgba(9,7,26,.95);border:1px solid rgba(255,255,255,.10)">
            <div>
              <div class="name">${escapeHtml(ex.name)} ${tagBadge}</div>
              <div class="tiny muted">${ex.sets} sets • ${tgt} reps • start ${ex.startWeight}${p.units} • ${ruleTxt}</div>
            </div>
            <div class="right">
              <button class="mini btnGhost" data-act="editEx" data-ex="${exId}">Edit</button>
              <button class="mini btnDanger" data-act="delEx" data-day="${day.id}" data-ex="${exId}">Remove</button>
            </div>
          </div>`;
      }).join("");
      list.appendChild(exDiv);
    });
  }
}
function deleteDay(dayId){
  const p=normalizeProgram();
  p.split=p.split.filter(d=>d.id!==dayId);
  state.program=p;
  save(); render(); toast("Day deleted");
}
function moveDay(dayId,dir){
  const p=normalizeProgram();
  const idx=p.split.findIndex(d=>d.id===dayId);
  if(idx<0) return;
  const j=idx+dir;
  if(j<0 || j>=p.split.length) return;
  const tmp=p.split[idx]; p.split[idx]=p.split[j]; p.split[j]=tmp;
  state.program=p;
  save(); renderSetup(); toast("Moved");
}
function editDay(dayId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  openModal("Edit day",
    `
    <div class="grid2">
      <div>
        <div class="tiny">Weekday</div>
        <select id="edDayWeekday">
          ${WEEKDAYS.map((d,i)=>`<option value="${i}" ${i===day.weekday?"selected":""}>${d}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="tiny">Title</div>
        <input id="edDayTitle" value="${escapeAttr(day.title||"Workout")}"/>
      </div>
    </div>
    <div class="tiny muted" style="margin-top:10px">
      Match weekdays so Today and Calendar line up with your real split.
    </div>
    `,
    "Save","Cancel",
    ()=>{
      day.weekday=num(document.getElementById("edDayWeekday").value,day.weekday);
      day.title=(document.getElementById("edDayTitle").value||day.title).trim() || "Workout";
      state.program=p;
      save(); closeModal(); render(); toast("Day updated");
    },
    ()=>{}
  );
}
function addDay(){
  const p=normalizeProgram();
  openModal("Add day",
    `
    <div class="grid2">
      <div>
        <div class="tiny">Weekday</div>
        <select id="mWeekday">
          ${WEEKDAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join("")}
        </select>
      </div>
      <div>
        <div class="tiny">Title</div>
        <input id="mTitle" placeholder="Push / Pull / Legs..."/>
      </div>
    </div>
    `,
    "Add","Cancel",
    ()=>{
      const wd=num(document.getElementById("mWeekday").value,1);
      const title=(document.getElementById("mTitle").value||"Workout").trim();
      p.split.push({id:uid(),weekday:wd,title,exercises:[]});
      state.program=p;
      save(); closeModal(); render(); toast("Day added");
    },
    ()=>{}
  );
}
function addExerciseToDay(dayId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  openModal("Add exercise",
    `
    <div class="grid2">
      <div class="tiny" style="grid-column:1/-1">Name</div>
      <input id="exName" placeholder="Bench Press / Squat / Pull-Ups"/>

      <div>
        <div class="tiny">Sets</div>
        <input id="exSets" inputmode="numeric" value="4"/>
      </div>

      <div>
        <div class="tiny">Start weight (${p.units})</div>
        <input id="exW" inputmode="decimal" value="0"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">PR tag (optional)</div>
      <select id="exPRTag">
        ${PR_TAGS.map(x=>`<option value="${x.v}">${escapeHtml(x.t)}</option>`).join("")}
      </select>

      <div class="tiny" style="grid-column:1/-1">Target</div>
      <select id="exTargetType">
        <option value="range">Rep range</option>
        <option value="fixed">Fixed reps</option>
      </select>

      <div id="rangeBox" class="grid2" style="grid-column:1/-1">
        <div>
          <div class="tiny">Min</div>
          <input id="exMin" inputmode="numeric" value="6"/>
        </div>
        <div>
          <div class="tiny">Max</div>
          <input id="exMax" inputmode="numeric" value="8"/>
        </div>
      </div>

      <div id="fixedBox" style="grid-column:1/-1;display:none">
        <div class="tiny">Reps</div>
        <input id="exFixed" inputmode="numeric" value="3"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">Progression rule</div>
      <select id="exRuleType">
        <option value="double">AI range + load</option>
        <option value="fixed">Fixed weekly increase</option>
        <option value="percent">Percent increase</option>
      </select>

      <div id="incBox" class="grid2" style="grid-column:1/-1">
        <div>
          <div class="tiny">Increase (${p.units})</div>
          <input id="exInc" inputmode="decimal" value="5"/>
        </div>
        <div>
          <div class="tiny">Deload after 2 misses</div>
          <select id="exDeload">
            <option value="yes">Yes (-10%)</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div id="pctBox" class="grid2" style="grid-column:1/-1;display:none">
        <div>
          <div class="tiny">Percent (%)</div>
          <input id="exPct" inputmode="decimal" value="2.5"/>
        </div>
        <div></div>
      </div>
    </div>
    `,
    "Add","Cancel",
    ()=>{
      const name=(document.getElementById("exName").value||"").trim();
      if(!name){ alert("Enter exercise name."); return; }
      const sets=clamp(num(document.getElementById("exSets").value,4),1,20);
      const startW=num(document.getElementById("exW").value,0);
      const prTag=document.getElementById("exPRTag").value || "none";

      const ttype=document.getElementById("exTargetType").value;
      let target;
      if(ttype==="range"){
        const min=clamp(num(document.getElementById("exMin").value,6),1,200);
        let max=clamp(num(document.getElementById("exMax").value,8),1,200);
        if(max<min) max=min;
        target={type:"range",min,max};
      }else{
        target={type:"fixed",reps:clamp(num(document.getElementById("exFixed").value,3),1,200)};
      }

      const rtype=document.getElementById("exRuleType").value;
      const deload=(document.getElementById("exDeload")?.value || "yes")==="yes";
      let rule;
      if(rtype==="percent"){
        rule={type:"percent",pct:num(document.getElementById("exPct").value,2.5),deloadOnMiss2:deload};
      }else{
        rule={type:rtype,inc:num(document.getElementById("exInc").value,5),deloadOnMiss2:deload};
      }

      const exId="ex_"+uid();
      p.exercises[exId]={name,sets,target,startWeight:startW,rule,prTag};
      day.exercises.push(exId);
      state.program=p;
      ensureExerciseState(exId,startW);
      save(); closeModal(); render(); toast("Exercise added");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel=document.getElementById("exTargetType");
    const rsel=document.getElementById("exRuleType");
    const rangeBox=document.getElementById("rangeBox");
    const fixedBox=document.getElementById("fixedBox");
    const incBox=document.getElementById("incBox");
    const pctBox=document.getElementById("pctBox");
    tsel.addEventListener("change",()=>{
      const v=tsel.value;
      rangeBox.style.display=v==="range"?"grid":"none";
      fixedBox.style.display=v==="fixed"?"block":"none";
    });
    rsel.addEventListener("change",()=>{
      const v=rsel.value;
      incBox.style.display=(v==="percent")?"none":"grid";
      pctBox.style.display=(v==="percent")?"grid":"none";
    });
  },0);
}
function removeExerciseFromDay(dayId,exId){
  const p=normalizeProgram();
  const day=p.split.find(d=>d.id===dayId);
  if(!day) return;
  day.exercises=(day.exercises||[]).filter(x=>x!==exId);
  state.program=p;
  save(); render(); toast("Removed");
}
function editExercise(exId){
  const p=normalizeProgram();
  const ex=p.exercises[exId];
  if(!ex) return;
  openModal("Edit exercise",
    `
    <div class="grid2">
      <div class="tiny" style="grid-column:1/-1">Name</div>
      <input id="edName" value="${escapeAttr(ex.name)}"/>

      <div>
        <div class="tiny">Sets</div>
        <input id="edSets" inputmode="numeric" value="${ex.sets}"/>
      </div>

      <div>
        <div class="tiny">Start weight (${p.units})</div>
        <input id="edW" inputmode="decimal" value="${ex.startWeight}"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">PR tag</div>
      <select id="edPRTag">
        ${PR_TAGS.map(x=>`<option value="${x.v}" ${x.v===ex.prTag?"selected":""}>${escapeHtml(x.t)}</option>`).join("")}
      </select>

      <div class="tiny" style="grid-column:1/-1">Target</div>
      <select id="edTargetType">
        <option value="range" ${ex.target.type==="range"?"selected":""}>Rep range</option>
        <option value="fixed" ${ex.target.type==="fixed"?"selected":""}>Fixed reps</option>
      </select>

      <div id="edRangeBox" class="grid2" style="grid-column:1/-1;${ex.target.type==="range"?"":"display:none"}">
        <div>
          <div class="tiny">Min</div>
          <input id="edMin" inputmode="numeric" value="${escapeAttr(ex.target.min ?? 6)}"/>
        </div>
        <div>
          <div class="tiny">Max</div>
          <input id="edMax" inputmode="numeric" value="${escapeAttr(ex.target.max ?? 8)}"/>
        </div>
      </div>

      <div id="edFixedBox" style="grid-column:1/-1;${ex.target.type==="fixed"?"":"display:none"}">
        <div class="tiny">Reps</div>
        <input id="edFixed" inputmode="numeric" value="${escapeAttr(ex.target.reps ?? 3)}"/>
      </div>

      <div class="tiny" style="grid-column:1/-1">Progression rule</div>
      <select id="edRuleType">
        <option value="double" ${(ex.rule?.type||"double")==="double"?"selected":""}>AI range + load</option>
        <option value="fixed" ${(ex.rule?.type||"double")==="fixed"?"selected":""}>Fixed weekly increase</option>
        <option value="percent" ${(ex.rule?.type||"double")==="percent"?"selected":""}>Percent increase</option>
      </select>

      <div id="edIncBox" class="grid2" style="grid-column:1/-1;${(ex.rule?.type||"double")==="percent"?"display:none":""}">
        <div>
          <div class="tiny">Increase (${p.units})</div>
          <input id="edInc" inputmode="decimal" value="${escapeAttr(ex.rule?.inc ?? 5)}"/>
        </div>
        <div>
          <div class="tiny">Deload after 2 misses</div>
          <select id="edDeload">
            <option value="yes" ${(ex.rule?.deloadOnMiss2 ?? true)?"selected":""}>Yes (-10%)</option>
            <option value="no" ${!(ex.rule?.deloadOnMiss2 ?? true)?"selected":""}>No</option>
          </select>
        </div>
      </div>

      <div id="edPctBox" class="grid2" style="grid-column:1/-1;${(ex.rule?.type||"double")==="percent"?"":"display:none"}">
        <div>
          <div class="tiny">Percent (%)</div>
          <input id="edPct" inputmode="decimal" value="${escapeAttr(ex.rule?.pct ?? 2.5)}"/>
        </div>
        <div></div>
      </div>
    </div>
    `,
    "Save","Cancel",
    ()=>{
      ex.name=(document.getElementById("edName").value||ex.name).trim();
      ex.sets=clamp(num(document.getElementById("edSets").value,ex.sets),1,30);
      ex.startWeight=num(document.getElementById("edW").value,ex.startWeight);
      ex.prTag=document.getElementById("edPRTag").value || "none";

      const ttype=document.getElementById("edTargetType").value;
      if(ttype==="range"){
        const min=clamp(num(document.getElementById("edMin").value,ex.target.min ?? 6),1,200);
        let max=clamp(num(document.getElementById("edMax").value,ex.target.max ?? 8),1,200);
        if(max<min) max=min;
        ex.target={type:"range",min,max};
      }else{
        const reps=clamp(num(document.getElementById("edFixed").value,ex.target.reps ?? 3),1,200);
        ex.target={type:"fixed",reps};
      }

      const rtype=document.getElementById("edRuleType").value;
      const deload=(document.getElementById("edDeload")?.value || "yes")==="yes";
      if(rtype==="percent"){
        ex.rule={type:"percent",pct:num(document.getElementById("edPct").value,2.5),deloadOnMiss2:deload};
      }else{
        ex.rule={type:rtype,inc:num(document.getElementById("edInc").value,5),deloadOnMiss2:deload};
      }

      ensureExerciseState(exId,ex.startWeight);
      state.program=p;
      save(); closeModal(); render(); toast("Updated");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel=document.getElementById("edTargetType");
    const rsel=document.getElementById("edRuleType");
    const rangeBox=document.getElementById("edRangeBox");
    const fixedBox=document.getElementById("edFixedBox");
    const incBox=document.getElementById("edIncBox");
    const pctBox=document.getElementById("edPctBox");
    tsel.addEventListener("change",()=>{
      const t=tsel.value;
      rangeBox.style.display=t==="range"?"grid":"none";
      fixedBox.style.display=t==="fixed"?"":"none";
    });
    rsel.addEventListener("change",()=>{
      const r=rsel.value;
      incBox.style.display=r==="percent"?"none":"grid";
      pctBox.style.display=r==="percent"?"grid":"none";
    });
  },0);
}

/* ===== Today + stats ===== */
function weekKeyForDate(iso){
  const d=new Date(iso+"T12:00:00");
  const dow=d.getDay();
  const diff=(dow===0? -6:1-dow);
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function countWeekStats(){
  const today=isoToday();
  const wk=weekKeyForDate(today);
  const p=state.program;
  const planned=p ? p.split.length : 0;
  const doneThisWeek=state.sessions.filter(s=>weekKeyForDate(s.date)===wk).length;

  let streak=0;
  const datesSet=new Set(state.sessions.map(s=>s.date));
  let d=new Date(today+"T12:00:00");
  while(true){
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
    const iso=`${y}-${m}-${day}`;
    if(datesSet.has(iso)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }

  $("stPlanned").textContent=planned;
  $("stDone").textContent=doneThisWeek;
  $("stStreak").textContent=streak;
  $("stTotal").textContent=state.sessions.length;
}
function renderToday(){
  const p=state.program;
  const iso=isoToday();
  $("todayDatePill").textContent=prettyDate(iso);

  if(!p){
    $("todayTitle").textContent="Welcome";
    $("todaySub").textContent="Set up your split once.";
    $("todayBox").innerHTML=`<div class="tiny muted">Go to Setup and add your training days. The AI coach will handle reps and weight jumps from there.</div>`;
    return;
  }

  const dow=dayOfWeek(iso);
  const plan=getPlanForWeekday(dow);
  if(!plan){
    $("todayTitle").textContent="Rest day";
    $("todaySub").textContent="Recovery • no training scheduled";
    $("todayBox").innerHTML=`<div class="tiny muted">If this should be a workout day, add a ${WEEKDAYS[dow]} session in Setup.</div>`;
    return;
  }

  $("todayTitle").textContent=plan.title || "Workout";
  $("todaySub").textContent=`${WEEKDAYS[plan.weekday]} • Strength + Hypertrophy`;

  const units=p.units || "lb";
  if(!plan.exercises?.length){
    $("todayBox").innerHTML=`<div class="tiny muted">No exercises yet for this day. Tap Split → your day → + Ex.</div>`;
    return;
  }

  let bigLiftCount=0;
  const rows=plan.exercises.map(exId=>{
    const ex=p.exercises[exId];
    if(!ex) return "";
    const name=(ex.name||"").toLowerCase();
    if(name.includes("bench")||name.includes("squat")||name.includes("deadlift")) bigLiftCount++;
    ensureExerciseState(exId,ex.startWeight);
    const st=state.exerciseState[exId];
    const tgt=ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
    const w=st.currentWeight ?? ex.startWeight;
    return `<tr><td>${escapeHtml(ex.name)}</td><td>${tgt}</td><td>${ex.sets}</td><td>${w}${units}</td></tr>`;
  }).join("");

  const focus = bigLiftCount>=2 ? "heavy compound focus" :
                bigLiftCount===1 ? "mixed compounds and accessories" :
                                   "mainly accessory work";

  $("todayBox").innerHTML=`
    <div class="tiny" style="margin-bottom:6px">
      Coach: This is a ${focus} <b>${escape
            <option value="no" ${!(ex.rule?.deloadOnMiss2 ?? true)?"selected":""}>No</option>
          </select>
        </div>
      </div>

      <div id="edPctBox" class="grid2" style="grid-column:1/-1;${(ex.rule?.type||"double")==="percent"?"":"display:none"}">
        <div>
          <div class="tiny">Percent (%)</div>
          <input id="edPct" inputmode="decimal" value="${escapeAttr(ex.rule?.pct ?? 2.5)}"/>
        </div>
        <div></div>
      </div>
    </div>
    `,
    "Save","Cancel",
    ()=>{
      ex.name=(document.getElementById("edName").value||ex.name).trim();
      ex.sets=clamp(num(document.getElementById("edSets").value,ex.sets),1,30);
      ex.startWeight=num(document.getElementById("edW").value,ex.startWeight);
      ex.prTag=document.getElementById("edPRTag").value || "none";

      const ttype=document.getElementById("edTargetType").value;
      if(ttype==="range"){
        const min=clamp(num(document.getElementById("edMin").value,ex.target.min ?? 6),1,200);
        let max=clamp(num(document.getElementById("edMax").value,ex.target.max ?? 8),1,200);
        if(max<min) max=min;
        ex.target={type:"range",min,max};
      }else{
        const reps=clamp(num(document.getElementById("edFixed").value,ex.target.reps ?? 3),1,200);
        ex.target={type:"fixed",reps};
      }

      const rtype=document.getElementById("edRuleType").value;
      const deload=(document.getElementById("edDeload")?.value || "yes")==="yes";
      if(rtype==="percent"){
        ex.rule={type:"percent",pct:num(document.getElementById("edPct").value,2.5),deloadOnMiss2:deload};
      }else{
        ex.rule={type:rtype,inc:num(document.getElementById("edInc").value,5),deloadOnMiss2:deload};
      }

      ensureExerciseState(exId,ex.startWeight);
      state.program=p;
      save(); closeModal(); render(); toast("Updated");
    },
    ()=>{}
  );

  setTimeout(()=>{
    const tsel=document.getElementById("edTargetType");
    const rsel=document.getElementById("edRuleType");
    const rangeBox=document.getElementById("edRangeBox");
    const fixedBox=document.getElementById("edFixedBox");
    const incBox=document.getElementById("edIncBox");
    const pctBox=document.getElementById("edPctBox");
    tsel.addEventListener("change",()=>{
      const t=tsel.value;
      rangeBox.style.display=t==="range"?"grid":"none";
      fixedBox.style.display=t==="fixed"?"":"none";
    });
    rsel.addEventListener("change",()=>{
      const r=rsel.value;
      incBox.style.display=r==="percent"?"none":"grid";
      pctBox.style.display=r==="percent"?"grid":"none";
    });
  },0);
}

/* ===== Today + stats ===== */
function weekKeyForDate(iso){
  const d=new Date(iso+"T12:00:00");
  const dow=d.getDay();
  const diff=(dow===0? -6:1-dow);
  d.setDate(d.getDate()+diff);
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function countWeekStats(){
  const today=isoToday();
  const wk=weekKeyForDate(today);
  const p=state.program;
  const planned=p ? p.split.length : 0;
  const doneThisWeek=state.sessions.filter(s=>weekKeyForDate(s.date)===wk).length;

  let streak=0;
  const datesSet=new Set(state.sessions.map(s=>s.date));
  let d=new Date(today+"T12:00:00");
  while(true){
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");
    const iso=`${y}-${m}-${day}`;
    if(datesSet.has(iso)){ streak++; d.setDate(d.getDate()-1); }
    else break;
  }

  $("stPlanned").textContent=planned;
  $("stDone").textContent=doneThisWeek;
  $("stStreak").textContent=streak;
  $("stTotal").textContent=state.sessions.length;
}
function renderToday(){
  const p=state.program;
  const iso=isoToday();
  $("todayDatePill").textContent=prettyDate(iso);

  if(!p){
    $("todayTitle").textContent="Welcome";
    $("todaySub").textContent="Set up your split once.";
    $("todayBox").innerHTML=`<div class="tiny muted">Go to Setup and add your training days. The AI coach will handle reps and weight jumps from there.</div>`;
    return;
  }

  const dow=dayOfWeek(iso);
  const plan=getPlanForWeekday(dow);
  if(!plan){
    $("todayTitle").textContent="Rest day";
    $("todaySub").textContent="Recovery • no training scheduled";
    $("todayBox").innerHTML=`<div class="tiny muted">If this should be a workout day, add a ${WEEKDAYS[dow]} session in Setup.</div>`;
    return;
  }

  $("todayTitle").textContent=plan.title || "Workout";
  $("todaySub").textContent=`${WEEKDAYS[plan.weekday]} • Strength + Hypertrophy`;

  const units=p.units || "lb";
  if(!plan.exercises?.length){
    $("todayBox").innerHTML=`<div class="tiny muted">No exercises yet for this day. Tap Split → your day → + Ex.</div>`;
    return;
  }

  let bigLiftCount=0;
  const rows=plan.exercises.map(exId=>{
    const ex=p.exercises[exId];
    if(!ex) return "";
    const name=(ex.name||"").toLowerCase();
    if(name.includes("bench")||name.includes("squat")||name.includes("deadlift")) bigLiftCount++;
    ensureExerciseState(exId,ex.startWeight);
    const st=state.exerciseState[exId];
    const tgt=ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
    const w=st.currentWeight ?? ex.startWeight;
    return `<tr><td>${escapeHtml(ex.name)}</td><td>${tgt}</td><td>${ex.sets}</td><td>${w}${units}</td></tr>`;
  }).join("");

  const focus = bigLiftCount>=2 ? "heavy compound focus" :
                bigLiftCount===1 ? "mixed compounds and accessories" :
                                   "mainly accessory work";

  $("todayBox").innerHTML=`
    <div class="tiny" style="margin-bottom:6px">
      Coach: This is a ${focus} <b>${escapeHtml(plan.title || "session")}</b>.
      Hit your target zone; the AI will adjust reps and weight next time.
    </div>
    <table class="tiny">
      <thead><tr><th>Exercise</th><th>Target</th><th>Sets</th><th>Next load</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* ===== Logger ===== */
let sessionDraft=null;

function buildSessionDraftForDate(iso){
  const p=state.program;
  if(!p) return null;
  const dow=dayOfWeek(iso);
  const plan=getPlanForWeekday(dow);
  if(!plan || !plan.exercises?.length) return null;

  const exLogs=(plan.exercises||[]).map(exId=>{
    const ex=p.exercises[exId];
    if(!ex) return null;
    ensureExerciseState(exId,ex.startWeight);
    const w=state.exerciseState[exId].currentWeight;
    const sets=Array.from({length:ex.sets},()=>({w,r:0,done:false}));
    return {exId,sets,note:""};
  }).filter(Boolean);
  if(!exLogs.length) return null;

  return {
    id:"sess_"+uid(),
    date:iso,
    planDayId:plan.id,
    title:plan.title,
    units:p.units,
    exercises:exLogs,
    note:"",
    feeling:"normal"
  };
}
function renderLogger(){
  const p=state.program;
  if(!sessionDraft || !p){
    $("loggerName").textContent="No workout";
    $("loggerMeta").textContent="";
    $("loggerDate").textContent="—";
    $("loggerExercises").innerHTML=
      `<div class="card" style="margin-top:12px">
         <div class="tiny muted">No active workout. Go to Home and tap Start workout.</div>
       </div>`;
    $("fabAddExerciseToSession").classList.remove("show");
    return;
  }

  $("loggerName").textContent=sessionDraft.title || "Workout";
  $("loggerDate").textContent=prettyDate(sessionDraft.date);
  $("loggerMeta").textContent=`${sessionDraft.exercises.length} exercise(s) • ${sessionDraft.units}`;

  const box=$("loggerExercises");
  box.innerHTML="";
  sessionDraft.exercises.forEach((exLog,idx)=>{
    const exDef=p.exercises[exLog.exId];
    const name=exDef?.name || "Exercise";
    const tgt=exDef?.target?.type==="range" ? `${exDef.target.min}-${exDef.target.max}` :
               exDef?.target?.type==="fixed" ? `${exDef.target.reps}` : "?";
    const setsRows=exLog.sets.map((s,si)=>`
      <tr data-ex="${idx}" data-set="${si}">
        <td>${si+1}</td>
        <td><input class="setW" inputmode="decimal" value="${s.w ?? ""}"/></td>
        <td><input class="setR" inputmode="numeric" value="${s.r ?? ""}"/></td>
        <td><div class="chk ${s.done?"on":""}">${s.done?"✓":""}</div></td>
      </tr>
    `).join("");

    const card=document.createElement("div");
    card.className="card";
    const hint=exDef ? coachHint(exDef,exLog) : "";
    card.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="name">${escapeHtml(name)}</div>
          <div class="tiny muted">${exLog.sets.length} set(s) • target ${tgt}</div>
        </div>
        <div class="right miniBtns">
          <button class="mini btnGhost" data-act="copyLast" data-i="${idx}">Copy</button>
          <button class="mini btnGhost" data-act="addSet" data-i="${idx}">+Set</button>
          <button class="mini btnDanger" data-act="rmEx" data-i="${idx}">Del</button>
        </div>
      </div>
      <div class="sep"></div>
      <table class="tiny">
        <thead><tr><th>#</th><th>W</th><th>R</th><th>✔</th></tr></thead>
        <tbody>${setsRows}</tbody>
      </table>
      <div class="sep"></div>
      <div class="tiny muted">Coach: ${escapeHtml(hint)}</div>
      <div class="sep"></div>
      <div class="tiny muted">
        <textarea id="note_${idx}" placeholder="Notes for this exercise...">${exLog.note||""}</textarea>
      </div>
    `;
    box.appendChild(card);
  });

  $("fabAddExerciseToSession").classList.toggle("show",!!p);

  box.querySelectorAll("input.setR").forEach(inp=>{
    inp.addEventListener("keydown",e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const inputs=Array.from(box.querySelectorAll("input.setR"));
        const i=inputs.indexOf(e.target);
        if(i>=0 && i<inputs.length-1) inputs[i+1].focus();
      }
    });
  });

  box.querySelectorAll("tbody tr").forEach(tr=>{
    const exIdx=num(tr.getAttribute("data-ex"),0);
    const setIdx=num(tr.getAttribute("data-set"),0);
    const wInput=tr.querySelector("input.setW");
    const rInput=tr.querySelector("input.setR");
    const chk=tr.querySelector(".chk");
    wInput.addEventListener("input",()=>{
      sessionDraft.exercises[exIdx].sets[setIdx].w=num(wInput.value,0);
    });
    rInput.addEventListener("input",()=>{
      const v=num(rInput.value,0);
      const s=sessionDraft.exercises[exIdx].sets[setIdx];
      s.r=v; s.done=v>0;
      chk.classList.toggle("on",s.done);
      chk.textContent=s.done?"✓":"";
    });
    chk.addEventListener("click",()=>{
      const s=sessionDraft.exercises[exIdx].sets[setIdx];
      s.done=!s.done;
      chk.classList.toggle("on",s.done);
      chk.textContent=s.done?"✓":"";
    });
  });

  box.querySelectorAll("button[data-act]").forEach(b=>{
    b.addEventListener("click",()=>{
      const act=b.getAttribute("data-act");
      const i=num(b.getAttribute("data-i"),0);
      if(act==="copyLast"){
        const ex=sessionDraft.exercises[i];
        const last=ex.sets[ex.sets.length-1] || {w:0,r:0,done:false};
        ex.sets=ex.sets.map(()=>({w:last.w,r:last.r,done:last.done}));
      }
      if(act==="addSet"){
        const ex=sessionDraft.exercises[i];
        const last=ex.sets[ex.sets.length-1] || {w:0,r:0,done:false};
        ex.sets.push({w:last.w,r:0,done:false});
      }
      if(act==="rmEx"){
        sessionDraft.exercises.splice(i,1);
      }
      renderLogger();
    });
  });

  sessionDraft.exercises.forEach((exLog,idx)=>{
    const area=document.getElementById(`note_${idx}`);
    if(area){
      area.addEventListener("input",()=>{
        sessionDraft.exercises[idx].note=area.value;
      });
    }
  });
}
/* ===== Calendar ===== */
let calCursor=(function(){
  const d=new Date();
  return {y:d.getFullYear(),m:d.getMonth()};
})();
let calSelected=null;

function renderWeekStrip(){
  const strip=$("weekStrip");
  strip.innerHTML="";
  const todayIso=isoToday();
  const d=new Date();
  const dow=d.getDay();
  const monday=new Date(d);
  const diff=(dow===0? -6:1-dow);
  monday.setDate(monday.getDate()+diff);

  for(let i=0;i<7;i++){
    const dd=new Date(monday);
    dd.setDate(monday.getDate()+i);
    const iso=`${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,"0")}-${String(dd.getDate()).padStart(2,"0")}`;
    const wday=dd.getDay();
    const plan=getPlanForWeekday(wday);
    const sess=state.sessions.find(s=>s.date===iso);

    const div=document.createElement("div");
    div.className="wkDay"+(iso===todayIso?" today":"");
    div.innerHTML=`
      <div class="wkTop">
        <span>${WEEKDAYS[wday]}</span>
        <span>
          ${sess?'<span class="dot"></span>':''}
          ${plan?'<span class="dot plan" style="margin-left:4px"></span>':''}
        </span>
      </div>
      <div class="wkTitle">
        ${sess?escapeHtml(sess.title || "Workout"):
          plan?escapeHtml(plan.title || "Planned"):"Rest"}
      </div>`;
    div.addEventListener("click",()=>{ calSelected=iso; renderCalDetail(); });
    strip.appendChild(div);
  }
}
function renderCalendar(){
  const p=state.program;
  const monthLabel=(()=>{
    const d=new Date(calCursor.y,calCursor.m,1);
    const mons=["January","February","March","April","May","June","July","August","September","October","November","December"];
    return `${mons[d.getMonth()]} ${d.getFullYear()}`;
  })();
  $("calMonth").textContent=monthLabel;

  const grid=$("calGrid");
  grid.innerHTML="";
  if(!p){
    grid.innerHTML=`<div class="tiny muted" style="grid-column:1/-1;padding:8px 0">No split yet.</div>`;
    $("calDetail").textContent="Tap a day.";
    return;
  }

  const firstDay=new Date(calCursor.y,calCursor.m,1);
  const startDow=firstDay.getDay();
  const daysInMonth=new Date(calCursor.y,calCursor.m+1,0).getDate();

  for(let i=0;i<startDow;i++){
    const div=document.createElement("div");
    div.className="calCell off";
    grid.appendChild(div);
  }

  for(let day=1; day<=daysInMonth; day++){
    const iso=`${calCursor.y}-${String(calCursor.m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    const dow=dayOfWeek(iso);
    const plan=getPlanForWeekday(dow);
    const sess=state.sessions.find(s=>s.date===iso);
    const hasPlan=!!plan, hasDone=!!sess;

    const cell=document.createElement("div");
    cell.className="calCell";
    if(!hasPlan && !hasDone) cell.style.opacity=".35";
    cell.innerHTML=`
      <div class="calNum">
        <span>${day}</span>
        <span>
          ${hasDone?'<span class="dot"></span>':''}
          ${hasPlan?'<span class="dot plan" style="margin-left:4px"></span>':''}
        </span>
      </div>
      <div class="calTitle">
        ${hasDone?escapeHtml(sess.title || "Workout"):
          hasPlan?escapeHtml(plan.title || "Planned"):""}
      </div>`;
    cell.addEventListener("click",()=>{ calSelected=iso; renderCalDetail(); });
    grid.appendChild(cell);
  }

  renderWeekStrip();
  renderCalDetail();
}
function renderCalDetail(){
  const box=$("calDetail");
  if(!calSelected){ box.textContent="Tap a day."; return; }
  const iso=calSelected;
  const dow=dayOfWeek(iso);
  const plan=getPlanForWeekday(dow);
  const sess=state.sessions.find(s=>s.date===iso);
  const p=state.program;
  const units=p?.units || "lb";

  let html=`<div class="tiny muted">${prettyDate(iso)}</div><div class="sep"></div>`;
  if(sess){
    html+=`<div class="name">${escapeHtml(sess.title || "Session")}</div>`;
    html+=`<div class="tiny muted">${sess.exercises?.length || 0} exercise(s) • ${units}</div>`;
    if(sess.computed){
      html+=`<div class="tiny" style="margin-top:6px">Volume: <b>${sess.computed.volume || 0}</b></div>`;
    }
    if(sess.note){
      html+=`<div class="sep"></div><div class="tiny muted">${escapeHtml(sess.note)}</div>`;
    }
  }else if(plan){
    html+=`<div class="name">${escapeHtml(plan.title || "Planned")}</div>`;
    html+=`<div class="tiny muted">${(plan.exercises||[]).length} planned exercise(s)</div>`;
    if(plan.exercises?.length && p){
      const rows=plan.exercises.map(exId=>{
        const ex=p.exercises[exId];
        if(!ex) return "";
        ensureExerciseState(exId,ex.startWeight);
        const st=state.exerciseState[exId];
        const tgt=ex.target.type==="range" ? `${ex.target.min}-${ex.target.max}` : `${ex.target.reps}`;
        const w=st.currentWeight ?? ex.startWeight;
        return `<tr><td>${escapeHtml(ex.name)}</td><td>${tgt}</td><td>${ex.sets}</td><td>${w}${units}</td></tr>`;
      }).join("");
      if(rows){
        html+=`<div class="sep"></div>
          <table class="tiny">
            <thead><tr><th>Exercise</th><th>Reps</th><th>Sets</th><th>Next</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      }
      html+=`<div class="sep"></div>
        <button class="btnAccent" id="btnStartFromCal" style="width:100%">Start workout</button>`;
    }
  }else{
    html+=`<div class="tiny muted">No plan or session for this day.</div>`;
  }
  box.innerHTML=html;

  const b1=document.getElementById("btnStartFromCal");
  if(b1){
    b1.addEventListener("click",()=>{
      const draft=buildSessionDraftForDate(iso);
      if(!draft){ toast("No plan"); return; }
      sessionDraft=draft;
      state.ui.activeTab="logger";
      save();
      render();
    });
  }
}

/* ===== Progress + PRs (simple) ===== */
function computeSession(session){
  let totalVol=0;
  const e1rms={};
  for(const exLog of session.exercises){
    let bestE1=0;
    for(const set of exLog.sets){
      const w=num(set.w,0), r=num(set.r,0);
      totalVol+=w*r;
      bestE1=Math.max(bestE1,e1rmEpley(w,r));
    }
    e1rms[exLog.exId]=bestE1;
  }
  session.computed=session.computed || {};
  session.computed.volume=Math.round(totalVol);
  session.computed.e1rm=e1rms;
  return session;
}
function updatePRsFromSession(session){
  for(const exLog of session.exercises){
    const exId=exLog.exId;
    const sets=exLog.sets;
    if(!sets.length) continue;

    state.prs[exId] ||= {
      bestWeight:{value:0,date:null},
      bestE1RM:{value:0,date:null},
      bestVolume:{value:0,date:null},
      bestRepsAtWeight:{weight:0,reps:0,date:null}
    };

    let bestW=0,bestE=0,exVol=0;
    for(const s of sets){
      const w=num(s.w,0), r=num(s.r,0);
      bestW=Math.max(bestW,w);
      bestE=Math.max(bestE,e1rmEpley(w,r));
      exVol+=w*r;
      if(w>0){
        const cur=state.prs[exId].bestRepsAtWeight;
        if(cur.weight===0 || w>cur.weight || (w===cur.weight && r>cur.reps)){
          state.prs[exId].bestRepsAtWeight={weight:w,reps:r,date:session.date};
        }
      }
    }
    if(bestW>state.prs[exId].bestWeight.value){
      state.prs[exId].bestWeight={value:bestW,date:session.date};
    }
    if(bestE>state.prs[exId].bestE1RM.value){
      state.prs[exId].bestE1RM={value:Math.round(bestE),date:session.date};
    }
    if(exVol>state.prs[exId].bestVolume.value){
      state.prs[exId].bestVolume={value:Math.round(exVol),date:session.date};
    }
  }
}
function renderProgress(){
  const p=state.program;
  if(!p){ $("progSummary").textContent="No data yet."; $("progList").innerHTML=""; return; }
  const days=parseInt($("progWindow").value,10);
  const cutoff=new Date();
  cutoff.setDate(cutoff.getDate()-days);
  const cutoffIso=cutoff.toISOString().slice(0,10);

  const recent=state.sessions.filter(s=>s.date>=cutoffIso);
  if(!recent.length){
    $("progSummary").textContent="No sessions in this window.";
    $("progList").innerHTML="";
    return;
  }
  $("progSummary").textContent=`${recent.length} session(s) in the last ${days} days.`;

  const byEx={};
  for(const s of recent){
    for(const exId of Object.keys(s.computed?.e1rm || {})){
      byEx[exId] ||= [];
      byEx[exId].push({date:s.date,e1:s.computed.e1rm[exId]});
    }
  }

  const list=$("progList");
  list.innerHTML="";
  Object.entries(byEx).forEach(([exId,arr])=>{
    arr.sort((a,b)=>a.date.localeCompare(b.date));
    const first=arr[0], last=arr[arr.length-1];
    const diff=Math.round(last.e1-first.e1);
    const label=diff>0 ? `+${diff}` : `${diff}`;
    const ex=p.exercises[exId];
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`
      <div>
        <div class="name">${escapeHtml(ex?.name || "Exercise")}</div>
        <div class="tiny muted">${arr.length} entry(ies) • last e1RM ${Math.round(last.e1) || 0}</div>
      </div>
      <div class="right">
        <span class="badge ${diff>=0?"good":"hard"}">${label}</span>
      </div>`;
    list.appendChild(row);
  });
}
function renderPRs(){
  const p=state.program;
  const boxCards=$("prCards");
  const boxSummary=$("prSummary");
  const boxHist=$("prHistory");
  boxCards.innerHTML="";
  boxHist.textContent="—";
  if(!p || !Object.keys(state.prs).length){
    boxSummary.textContent="No PRs yet. Tag key lifts as Bench/Squat/etc. in Setup.";
    return;
  }
  boxSummary.textContent="Best e1RM and heaviest sets for your tagged lifts.";

  function buildCard(tag,label){
    const exIds=Object.entries(p.exercises||{}).filter(([id,ex])=>ex.prTag===tag).map(([id])=>id);
    if(!exIds.length) return "";
    let bestE=0,bestEName="",bestW=0,bestWName="";
    const counted=[];
    exIds.forEach(id=>{
      const pr=state.prs[id];
      if(!pr) return;
      const ex=p.exercises[id];
      counted.push(ex.name);
      if(pr.bestE1RM.value>bestE){ bestE=pr.bestE1RM.value; bestEName=ex.name; }
      if(pr.bestWeight.value>bestW){ bestW=pr.bestWeight.value; bestWName=ex.name; }
    });
    if(!counted.length) return "";
    return `
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="name">${escapeHtml(label)}</div>
            <div class="tiny muted">Best e1RM and heaviest set across your tagged variations.</div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid2">
          <div>
            <div class="tiny muted">Best e1RM</div>
            <div class="name">${bestE?bestE:"-"}</div>
            <div class="tiny muted">${escapeHtml(bestEName)}</div>
          </div>
          <div>
            <div class="tiny muted">Heaviest set</div>
            <div class="name">${bestW?bestW:"-"}</div>
            <div class="tiny muted">${escapeHtml(bestWName)}</div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="tiny muted">
          Exercises counted: ${escapeHtml(counted.join(", "))}.
        </div>
      </div>`;
  }

  const cardsHtml=[
    buildCard("bench","Bench PR"),
    buildCard("squat","Squat PR"),
    buildCard("deadlift","Deadlift PR"),
    buildCard("ohp","Overhead Press PR"),
    buildCard("row","Row PR"),
    buildCard("pullup","Pull-up PR"),
  ].filter(Boolean).join("");
  boxCards.innerHTML=cardsHtml || `<div class="tiny muted" style="margin-top:8px">No tagged PRs yet.</div>`;

  const hist=[];
  Object.entries(state.prs).forEach(([exId,pr])=>{
    const ex=p.exercises[exId];
    if(!ex) return;
    if(pr.bestE1RM.date) hist.push(`e1RM PR on ${pr.bestE1RM.date}: ${pr.bestE1RM.value} (${ex.name})`);
    if(pr.bestWeight.date) hist.push(`Heaviest set on ${pr.bestWeight.date}: ${pr.bestWeight.value} (${ex.name})`);
  });
  boxHist.textContent=hist.length ? hist.join(" • ") : "No PR events yet.";
}

/* ===== Finish workout ===== */
function finishWorkout(){
  if(!sessionDraft){ toast("No workout in progress"); return; }
  const p=state.program;
  if(!p){ toast("No program"); return; }

  computeSession(sessionDraft);
  for(const exLog of sessionDraft.exercises){
    const exDef=p.exercises[exLog.exId];
    if(!exDef) continue;
    applyProgression(exDef,exLog);
  }
  updatePRsFromSession(sessionDraft);

  state.sessions.push(sessionDraft);
  save();
  toast("Workout saved");
  sessionDraft=null;
  render();
}

/* ===== Render root + wiring ===== */
function render(){
  const p=state.program;
  if(!p){
    showScreen("screenSetup");
    tabEl("tabToday",false);
    tabEl("tabLogger",false);
    tabEl("tabCalendar",false);
    tabEl("tabProgress",false);
    tabEl("tabPRs",false);
  }else{
    const tab=state.ui.activeTab || "today";
    showScreen(
      tab==="logger"?"screenLogger":
      tab==="calendar"?"screenCalendar":
      tab==="progress"?"screenProgress":
      tab==="prs"?"screenPRs":
      "screenToday"
    );
    tabEl("tabToday",tab==="today");
    tabEl("tabLogger",tab==="logger");
    tabEl("tabCalendar",tab==="calendar");
    tabEl("tabProgress",tab==="progress");
    tabEl("tabPRs",tab==="prs");
  }
  renderSetup();
  renderToday();
  renderLogger();
  renderCalendar();
  countWeekStats();
  renderProgress();
  renderPRs();
}

document.addEventListener("DOMContentLoaded",()=>{
  $("btnAddDay").addEventListener("click",addDay);
  $("btnFinishSetup").addEventListener("click",()=>{
    const p=normalizeProgram();
    p.units=$("setUnits").value || "lb";
    p.startWeekDate=$("setStartWeek").value || defaultMonday();
    if(!p.split.length){ alert("Add at least one training day."); return; }
    state.program=p;
    save();
    toast("Split saved");
    setActiveTab("today");
  });

  $("btnEditSplitToday").addEventListener("click",()=>{ setActiveTab("setup"); });

  $("btnStartWorkout").addEventListener("click",()=>{
    const draft=buildSessionDraftForDate(isoToday());
    if(!draft){ toast("No plan for today"); return; }
    sessionDraft=draft;
    setActiveTab("logger");
  });

  $("btnBackToday").addEventListener("click",()=>{ setActiveTab("today"); });
  $("btnFinishWorkout").addEventListener("click",finishWorkout);

  $("tabToday").addEventListener("click",()=>setActiveTab("today"));
  $("tabLogger").addEventListener("click",()=>setActiveTab("logger"));
  $("tabCalendar").addEventListener("click",()=>setActiveTab("calendar"));
  $("tabProgress").addEventListener("click",()=>setActiveTab("progress"));
  $("tabPRs").addEventListener("click",()=>setActiveTab("prs"));

  $("calPrev").addEventListener("click",()=>{
    calCursor.m-=1;
    if(calCursor.m<0){ calCursor.m=11; calCursor.y-=1; }
    calSelected=null;
    renderCalendar();
  });
  $("calNext").addEventListener("click",()=>{
    calCursor.m+=1;
    if(calCursor.m>11){ calCursor.m=0; calCursor.y+=1; }
    calSelected=null;
    renderCalendar();
  });

  render();
});
</script>
</body>
</html>
